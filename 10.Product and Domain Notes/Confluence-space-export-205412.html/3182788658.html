<!DOCTYPE html>
<html>
    <head>
        <title>Jackson Fan : Ace/Fusion-Institutional Client Brokerage Revenue Analysis</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Jackson Fan</a></span>
                            </li>
                                                    <li>
                                <span><a href="JF-Space-Overview_2554888272.html">JF Space Overview</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Jackson Fan : Ace/Fusion-Institutional Client Brokerage Revenue Analysis
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                            
        
    
        
    
        
        
            Created by <span class='author'> Jackson Fan</span> on 26-05-25
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h2 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-Background">Background</h2><p>This page documents the SQL scripts and processes developed to generate a brokerage revenue report for Institutional clients not registered for tax in New Zealand, as requested by Alice Burns. The report covers the periods January–December 2021, 2022, 2023, and 2024. The analysis addresses challenges with incomplete tax residency data in the CRM system and incorporates additional fields like client address for enhanced reporting.</p><h2 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-Overview">Overview</h2><p>The objective is to provide a detailed and summarized view of brokerage revenue from Institutional clients, focusing on foreign clients (non-NZL tax-registered). The report leverages data from the <strong>ACE</strong> and <strong>Fusion</strong> databases, specifically from tables related to transactions, equity contracts, client details, and currency exchange rates. Two SQL scripts were developed:</p><ol start="1"><li><p><strong>W2-Base details for brokerage at EquityContracts and Ace Transaction grain.sql</strong>: Provides detailed transaction-level data.</p></li></ol><p class="media-group"><span class="confluence-embedded-file-wrapper"><a class="confluence-embedded-file" href="attachments/3182788658/3182985266.sql" data-nice-type="null" data-file-src="/wiki/download/attachments/3182788658/W2-Base%20details%20for%20brokerage%20at%20EquityContracts%20and%20Ace%20Transaction%20grain.sql?version=1&amp;modificationDate=1748298011494&amp;cacheVersion=1&amp;api=v2" data-linked-resource-id="3182985266" data-linked-resource-type="attachment" data-linked-resource-container-id="3182788658" data-linked-resource-default-alias="W2-Base details for brokerage at EquityContracts and Ace Transaction grain.sql" data-mime-type="binary/octet-stream" data-has-thumbnail="true" data-linked-resource-version="1" data-media-id="f2823726-4188-468c-880f-ed347bbfd916" data-media-type="file"><img src="attachments/thumbnails/3182788658/3182985266" height="250"/></a></span></p><ol start="2"><li><p><strong>W2.1-Roll up to Ledger ID Grain.sql</strong>: Aggregates data to the portfolio (LedgerID) level for summary reporting.</p></li></ol><p class="media-group"><span class="confluence-embedded-file-wrapper"><a class="confluence-embedded-file" href="attachments/3182788658/3182788668.sql" data-nice-type="null" data-file-src="/wiki/download/attachments/3182788658/W2.1-Roll%20up%20to%20Ledger%20ID%20Grain.sql?version=1&amp;modificationDate=1748298019173&amp;cacheVersion=1&amp;api=v2" data-linked-resource-id="3182788668" data-linked-resource-type="attachment" data-linked-resource-container-id="3182788658" data-linked-resource-default-alias="W2.1-Roll up to Ledger ID Grain.sql" data-mime-type="binary/octet-stream" data-has-thumbnail="true" data-linked-resource-version="1" data-media-id="f388fd26-a00b-4e46-9706-2a541577f182" data-media-type="file"><img src="attachments/thumbnails/3182788658/3182788668" height="250"/></a></span></p><p>The scripts filter for Institutional clients under the Wholesale account, exclude NZL-registered clients, and include address details for better client identification. The report is saved at:</p><p><code>&lt;https://kapsqlrpt-prd01.craigsip.com/Reports/report/Finance%20and%20Accounting/UAT/ACE%20Institutional%20Clients%20Brokerage%20Summary</code>&gt;</p><h2 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-BusinessContext">Business Context</h2><p>Alice Burns, a stakeholder in the Finance and Accounting team, requested a report to analyze brokerage revenue from foreign Institutional clients for 2021–2024. Key business requirements include:</p><ul><li><p><strong>Foreign Client Definition</strong>: Clients not registered for tax in New Zealand (CountryID ≠ 'NZL').</p></li><li><p><strong>Institutional Clients</strong>: Identified by <code>ClientTypeID = 'IN'</code> and managed under the Wholesale account (<code>AccID = 'WHOLESALE'</code>).</p></li><li><p><strong>Data Periods</strong>: Annual data for 2021, 2022, 2023, and 2024.</p></li><li><p><strong>Challenges</strong>:</p><ul><li><p>Incomplete tax residency data in the CRM system, as noted by Serviceportal.</p></li><li><p>Suggestion to use address fields and Fusion data for verification.</p></li><li><p>Need to identify Institutional team clients and their transactions using advisor codes and client types.</p></li></ul></li><li><p><strong>Additional Fields</strong>: Include address details to supplement missing tax residency data.</p></li></ul><p>The report supports financial reporting and strategic analysis of Institutional client revenue streams, particularly for foreign clients.</p><h2 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-InvestigationProcess">Investigation Process</h2><ol start="1"><li><p><strong>Requirement Clarification</strong>:</p><ul><li><p>Reviewed Alice’s request for brokerage revenue data for foreign Institutional clients.</p></li><li><p>Noted Serviceportal’s feedback on incomplete tax residency data and the suggestion to use Fusion for verification.</p></li><li><p>Confirmed the need to filter by <code>ClientTypeID = 'IN'</code> and <code>AccID = 'WHOLESALE'</code> to isolate Institutional clients.</p></li></ul></li><li><p><strong>Data Source Identification</strong>:</p><ul><li><p><strong>ACE Database</strong>: Primary source for transaction and client data (<code>AcTransaction</code>, <code>EqContracts</code>, <code>StClients_Master</code>, etc.).</p></li><li><p><strong>Fusion Database</strong>: Used for FX rate data (<code>FxRate</code>) to convert brokerage amounts to NZD.</p></li><li><p>Key tables identified: <code>AcTransaction</code>, <code>AcBatchHeader</code>, <code>EqContracts</code>, <code>StClients_Master</code>, <code>StAddresses</code>, <code>StCountries</code>.</p></li></ul></li><li><p><strong>Script Development</strong>:</p><ul><li><p>Developed <strong>W2-Base</strong> script for transaction-level details, including contract dates, client details, and NZD-converted brokerage.</p></li><li><p>Developed <strong>W2.1-Roll up</strong> script for portfolio-level aggregation, summarizing trade counts, quantities, values, and brokerage.</p></li><li><p>Incorporated address fields (<code>AddressLine1–4</code>, <code>PostCode</code>) and country details (<code>ctry.Name</code>) to address incomplete tax residency data.</p></li></ul></li><li><p><strong>Data Validation</strong>:</p><ul><li><p>Ensured filters for active clients (<code>m.Status = 'A'</code>), completed batches (<code>bh.Status = 'C'</code>), and non-deleted contracts (<code>ec.Status &lt;&gt; 'D'</code>).</p></li><li><p>Used <code>CountryID ≠ 'NZL'</code> to isolate foreign clients, supplemented by address data for verification.</p></li><li><p>Tested scripts for the 2024 period and adjusted parameters for historical years (2021–2023).</p></li></ul></li><li><p><strong>Report Deployment</strong>:</p><ul><li><p>Saved the report to the specified reporting server location.</p></li><li><p>Assigned to Jackson Fan with a target response date of 12/05/2025.</p></li></ul></li></ol><h2 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-BaseDetailedScriptExplained(W2-BasedetailsforbrokerageatEquityContractsandAceTransactiongrain.sql)">Base Detailed Script Explained (W2-Base details for brokerage at EquityContracts and Ace Transaction grain.sql)</h2><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-Purpose">Purpose</h3><p>Provides transaction-level details for brokerage revenue from Institutional clients, including contract details, client information, and NZD-converted brokerage amounts.</p><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-Why">Why</h3><p>To enable granular analysis of individual trades, including contract dates, quantities, values, and brokerage fees, with a focus on foreign clients.</p><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-Who">Who</h3><ul><li><p><strong>Users</strong>: Finance and Accounting team, particularly Alice Burns.</p></li><li><p><strong>Developers</strong>: SQL developers maintaining or extending the report.</p></li></ul><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-How">How</h3><ul><li><p><strong>Parameters</strong>:</p><ul><li><p><code>@StartDate</code> and <code>@EndDate</code>: Define the date range (e.g., '2024-01-01' to '2024-12-31').</p></li><li><p><code>@PortfolioNo</code>: Filters for a specific portfolio (e.g., '275350') for testing; can be removed for all portfolios.</p></li></ul></li><li><p><strong>Key Tables and Joins</strong>:</p><ul><li><p><code>AcTransaction</code>: Core transaction data (amount, currency, debit/credit).</p></li><li><p><code>AcBatchHeader</code>: Batch details (transaction date, status).</p></li><li><p><code>EqContracts</code>: Equity contract details (quantity, price, value, dates).</p></li><li><p><code>StClients_Master</code>: Client details (name, status, country).</p></li><li><p><code>StAddresses</code> and <code>StCountries</code>: Address and country details for tax residency verification.</p></li><li><p><code>FxRate</code>: FX rates for USD→AUD and USD→NZD conversions.</p></li></ul></li><li><p><strong>Key Fields</strong>:</p><ul><li><p><code>ContractAsAtDate</code>, <code>BatchHeaderTransDate</code>: Transaction and contract dates.</p></li><li><p><code>AccountID</code>, <code>PortfolioNo</code>, <code>ClientName</code>, <code>CountryName</code>: Client identification.</p></li><li><p><code>RawBrokerage</code>: Brokerage fee in original currency (credit/debit adjusted).</p></li><li><p><code>NZDBrokerage</code>: Brokerage converted to NZD using FX rates.</p></li><li><p><code>Quantity</code>, <code>Price</code>, <code>Value</code>: Trade details.</p></li></ul></li><li><p><strong>Filters</strong>:</p><ul><li><p><code>t.AccID = 'WHOLESALE'</code>: Wholesale account.</p></li><li><p><code>m.ClientTypeID = 'IN'</code>: Institutional clients.</p></li><li><p><code>m.Status = 'A'</code>: Active clients.</p></li><li><p><code>ec.Status &lt;&gt; 'D'</code>: Non-deleted contracts.</p></li><li><p><code>bh.Status = 'C'</code>: Completed batches.</p></li><li><p><code>caa.AddressTypeID = 'M'</code>: Master address.</p></li><li><p><code>m.CountryID NOT IN ('NZL')</code>: Foreign clients (commented out for flexibility).</p></li><li><p>Date range filter on <code>ec.AsAtDate</code>.</p></li></ul></li></ul><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-KeyLogic">Key Logic</h3><ul><li><p><strong>Brokerage Calculation</strong>:</p><ul><li><p><code>RawBrokerage</code>: <code>t.Amount</code> for credits, <code>-t.Amount</code> for debits.</p></li><li><p><code>NZDBrokerage</code>: Converts <code>RawBrokerage</code> to NZD using FX rates (<code>f1.currentRate / f.currentRate</code> for AUD).</p></li></ul></li><li><p><strong>FX Conversion</strong>:</p><ul><li><p>Uses <code>FxRate</code> table with <code>fxRateID=44</code> (USD→AUD) and <code>fxRateID=53</code> (USD→NZD).</p></li><li><p>Handles NZD (<code>CurrencyID = '1'</code>) as 1:1 and AUD (<code>CurrencyID = '2'</code>) via USD conversion.</p></li></ul></li><li><p><strong>Client Identification</strong>:</p><ul><li><p>Joins <code>StClients_Master</code> and <code>StCountries</code> to verify non-NZL status.</p></li><li><p>Includes address fields to supplement missing tax residency data.</p></li></ul></li></ul><h2 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-Roll-UpScriptExplained(W2.1-RolluptoLedgerIDGrain.sql)">Roll-Up Script Explained (W2.1-Roll up to Ledger ID Grain.sql)</h2><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-Purpose.1">Purpose</h3><p>Aggregates transaction-level data to the portfolio (LedgerID) level, summarizing trade counts, quantities, values, and brokerage revenue by client and currency.</p><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-Why.1">Why</h3><p>To provide a high-level summary for financial reporting, focusing on total brokerage revenue from foreign Institutional clients.</p><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-Who.1">Who</h3><ul><li><p><strong>Users</strong>: Finance and Accounting team for strategic analysis.</p></li><li><p><strong>Developers</strong>: SQL developers for maintenance or enhancements.</p></li></ul><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-How.1">How</h3><ul><li><p><strong>Parameters</strong>:</p><ul><li><p><code>@StartDate</code> and <code>@EndDate</code>: Define the date range (e.g., '2024-01-01' to '2024-12-31').</p></li></ul></li><li><p><strong>Key Tables and Joins</strong>:</p><ul><li><p>Uses a CTE (<code>DetailedTrades</code>) to pre-process transaction-level data from <code>AcTransaction</code>, <code>EqContracts</code>, and <code>AcBatchHeader</code>.</p></li><li><p>Joins to <code>StClients_Master</code>, <code>StAddresses</code>, and <code>StCountries</code> for client and address details.</p></li></ul></li><li><p><strong>Key Fields</strong>:</p><ul><li><p><code>AccountID</code>, <code>PortfolioNo</code>, <code>EntityName</code>, <code>CountryName</code>: Client identification.</p></li><li><p><code>TradeCount</code>: Number of trades (<code>COUNT_BIG(*)</code>).</p></li><li><p><code>TotalQuantity</code>: Sum of units traded (<code>SUM(dt.Quantity)</code>).</p></li><li><p><code>TotalValue</code>: Sum of contract values (<code>SUM(dt.Value)</code>).</p></li><li><p><code>RawBrokerage</code>: Sum of brokerage fees in original currency (<code>SUM(dt.RawBrokerage)</code>).</p></li><li><p><code>CurrencyCode</code>: Original currency from <code>StCurrencies</code>.</p></li></ul></li><li><p><strong>Filters</strong>:</p><ul><li><p>Same as base script: Wholesale account, Institutional clients, active status, completed batches, non-deleted contracts, master address.</p></li><li><p><code>m.CountryID NOT IN ('NZL')</code> (commented out for flexibility).</p></li></ul></li><li><p><strong>Grouping</strong>:</p><ul><li><p>Groups by <code>AccountID</code>, <code>PortfolioNo</code>, <code>ClientName</code>, <code>CountryName</code>, <code>CurrencyCode</code>, and address fields.</p></li></ul></li></ul><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-KeyLogic.1">Key Logic</h3><ul><li><p><strong>Aggregation</strong>:</p><ul><li><p>Uses CTE to compute transaction-level metrics (quantity, value, brokerage).</p></li><li><p>Aggregates to portfolio level for summary metrics.</p></li></ul></li><li><p><strong>Client Verification</strong>:</p><ul><li><p>Includes address fields and <code>CountryName</code> for tax residency verification.</p></li></ul></li><li><p><strong>Output</strong>:</p><ul><li><p>Ordered by <code>PortfolioNo</code> for easy reference.</p></li></ul></li></ul><h2 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-InstitutionalClientRevenuesNotes">Institutional Client Revenues Notes</h2><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-DataModel">Data Model</h3><p>The data model diagram illustrates the relationships between key tables:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">graph LR
  AcTransaction --&gt;|BatchID| AcBatchHeader
  AcTransaction --&gt;|DescriptionID| AcTransDesc
  AcTransaction --&gt;|Reference| EqContracts
  EqContracts --&gt;|LedgerID| AcLedger
  AcLedger --&gt;|Type| AccountTypes
  EqContracts --&gt;|CurrencyID| StCurrencies
  EqContracts --&gt;|ContractDate| FxRate_USDAUD[FxRate USD→AUD]
  EqContracts --&gt;|ContractDate| FxRate_USDNZD[FxRate USD→NZD]
  EqContracts --&gt;|LedgerID| StClients_Master
  StClients_Master --&gt;|ClientTypeID| StClientTypes
  StClients_Master --&gt;|BranchID| StBranches
  StClients_Master --&gt;|LedgerID| StClientParents
  StClients_Master --&gt;|LedgerID| StClientAdvisor
  StClients_Master --&gt;|LedgerID| StClientAddress
  StClientAddress --&gt;|AddressID| StAddresses
  StAddresses --&gt;|CountryID| StCountries</pre>
</div></div><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-KeyTablesandRelationships">Key Tables and Relationships</h3><ul><li><p><strong>AcTransaction</strong>: Core transaction data, linked to <code>AcBatchHeader</code> (BatchID), <code>AcTransDesc</code> (DescriptionID), and <code>EqContracts</code> (Reference).</p></li><li><p><strong>EqContracts</strong>: Contract details, linked to <code>AcLedger</code> (LedgerID), <code>StCurrencies</code> (CurrencyID), and <code>FxRate</code> (ContractDate).</p></li><li><p><strong>StClients_Master</strong>: Client details, linked to <code>StClientTypes</code>, <code>StBranches</code>, <code>StClientParents</code>, <code>StClientAdvisor</code>, and <code>StClientAddress</code>.</p></li><li><p><strong>StAddresses</strong>: Address details, linked to <code>StCountries</code> for country information.</p></li></ul><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-CurrencyCodes">Currency Codes</h3><p>Supported currencies include NZD, AUD, USD, GBP, etc. Key mappings:</p><ul><li><p><code>ID=1</code>: NZD</p></li><li><p><code>ID=2</code>: AUD</p></li><li><p>FX conversions use <code>FxRate</code> table for USD→AUD (<code>fxRateID=44</code>) and USD→NZD (<code>fxRateID=53</code>).</p></li></ul><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-ClientTypes">Client Types</h3><ul><li><p><code>IN</code>: Institution (target for this report).</p></li><li><p><code>PV</code>: Private, <code>NC</code>: Nominee Company, etc.</p></li></ul><h3 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-Branches">Branches</h3><ul><li><p><code>ZB</code>: Wholesale Branch (relevant for Institutional clients).</p></li><li><p>Other branches: Auckland (AK), Christchurch (CH), Head Office (HQ), etc.</p></li></ul><h2 id="Ace/Fusion-InstitutionalClientBrokerageRevenueAnalysis-AdditionalNotes">Additional Notes</h2><ul><li><p><strong>Tax Residency</strong>: Due to incomplete <code>CountryID</code> data, address fields (<code>AddressLine1–4</code>, <code>PostCode</code>, <code>CountryName</code>) are included for verification.</p></li><li><p><strong>Advisor Codes</strong>: <code>StClientAdvisor</code> table links clients to brokers, aiding Institutional team identification.</p></li><li><p><strong>Historical Data</strong>: Scripts can be modified to loop through years (2021–2023) by adjusting <code>@StartDate</code> and <code>@EndDate</code>.</p></li><li><p><strong>Future Enhancements</strong>:</p><ul><li><p>Add advisor-specific filters using <code>StClientAdvisor</code>.</p></li><li><p>Incorporate additional Fusion data for tax residency validation.</p></li><li><p>Automate multi-year reporting.</p></li></ul></li></ul>
                    </div>

                                        <div class="pageSection group">
                        <div class="pageSectionHeader">
                            <h2 id="attachments" class="pageSectionTitle">Attachments:</h2>
                        </div>

                        <div class="greybox" align="left">
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/3182788658/3182985266.sql">W2-Base details for brokerage at EquityContracts and Ace Transaction grain.sql</a> (binary/octet-stream)
                                <br/>
                                                            <img src="images/icons/bullet_blue.gif" height="8" width="8" alt=""/>
                                <a href="attachments/3182788658/3182788668.sql">W2.1-Roll up to Ledger ID Grain.sql</a> (binary/octet-stream)
                                <br/>
                                                    </div>
                    </div>
                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 18-08-25 20:53</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
