<!DOCTYPE html>
<html>
    <head>
        <title>Jackson Fan : Amend Management Fee Calculation: Staff vs Normal</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Jackson Fan</a></span>
                            </li>
                                                    <li>
                                <span><a href="JF-Space-Overview_2554888272.html">JF Space Overview</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Jackson Fan : Amend Management Fee Calculation: Staff vs Normal
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                            
        
    
        
    
        
        
            Created by <span class='author'> Jackson Fan</span>, last modified on 22-04-25
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h2 id="AmendManagementFeeCalculation:StaffvsNormal-Background:">Background:</h2><p>Business user from Finance want to udnertadn why the Staff fee is higer than normal management fee.</p><p>jackson investiagted into it</p><ol start="1"><li><p>Use Created date fro the monthly grain of staff fee</p></li><li><p>Use piecewise linear function to avoid double coutning of exsting rows calcaualtion</p></li></ol><p>there are 7 untis of code</p><p>The Finance team needs to understand, <strong>on a daily basis</strong>, how much more (or less) revenue is being generated by staff portfolios under discounted fee schedules versus the standard “normal” schedules.</p><ul><li><p><strong>Requirement:</strong> Calculate both <strong>Staff Fees</strong> and <strong>Normal Fees</strong> at a <strong>daily grain</strong>, rather than just at month‑end, so that any intra‑month valuations, portfolio switches or fee‑schedule changes are accurately captured.</p></li><li><p><strong>Developer Insight:</strong> In investigating this, we found that you must segment the calculation <strong>by asset type and by valuation date</strong>, recalculating each day’s fee contribution across all tiers to avoid double‑counting and to pinpoint the exact drivers of any variance.</p></li></ul><h2 id="AmendManagementFeeCalculation:StaffvsNormal-BusinessUseCases">Business Use Cases</h2><ol start="1"><li><p><strong>Branch Performance Analysis</strong></p><ul><li><p>A branch manager wants to see how much potential revenue is “lost” by giving staff discounted fee schedules vs what would have been charged under standard rates.</p></li></ul></li><li><p><strong>Compliance &amp; Audit Reporting</strong></p><ul><li><p>The compliance team needs to verify that all staff portfolios have been billed correctly, and to highlight any large variances between actual staff fees and calculated normal fees.</p></li></ul></li><li><p><strong>Product Pricing Review</strong></p><ul><li><p>The product team wants to simulate what revenue would look like if certain staff fee discounts were removed, by remapping staff schedules to normal schedules.</p></li></ul></li><li><p><strong>Financial Forecasting</strong></p><ul><li><p>The finance department can project daily fee income under different fee schedule scenarios (e.g. if certain staff promotions expire).</p></li></ul></li></ol><hr/><h2 id="AmendManagementFeeCalculation:StaffvsNormal-Prerequisites">Prerequisites</h2><ul><li><p><strong>Database &amp; Permissions</strong></p><ul><li><p>SQL Server with permissions to create/drop temporary tables.</p></li><li><p>Access to <code>CRAIGS_PROD_MAIN</code> tables:<br/><code>PortfolioCashTrade</code>, <code>PortfolioOrder</code>, <code>Portfolio</code>, <code>PortfolioStatus</code>,<br/><code>FeePackage</code>, <code>Fee</code>, <code>FeeScale</code>,<br/><code>PortfolioValuationHistoryHeader</code>, <code>PortfolioValuationHistoryDetail</code>, <code>Asset</code>, <code>Currency</code>,<br/>and dimension tables (<code>TradeStatus</code>, <code>TradeTypeDM</code>, <code>Entity</code>, <code>OrganisationBranch</code>, <code>OrganisationAdvisorCode</code>).</p></li></ul></li><li><p><strong>Input Parameters</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">DECLARE @StartDate   DATETIME = &#39;2025-03-01&#39;;
DECLARE @EndDate     DATETIME = &#39;2025-03-31&#39;;
DECLARE @PortfolioID VARCHAR(50) = NULL;  -- e.g. &#39;635981_KP&#39;
</pre>
</div></div></li></ul><hr/><h2 id="AmendManagementFeeCalculation:StaffvsNormal-Unit1:SetupVariables&amp;Cleanup">Unit 1: Setup Variables &amp; Cleanup</h2><p>Drop any leftover temp tables and declare your date/portfolio variables.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">-- Define date range &amp; optional portfolio filter
DECLARE @StartDate   DATETIME       = &#39;2025-03-01&#39;;
DECLARE @EndDate     DATETIME       = &#39;2025-03-31&#39;;
DECLARE @PortfolioID VARCHAR(50)    = NULL;  -- NULL = all portfolios

-- Drop existing temp tables
IF OBJECT_ID(&#39;tempdb..#AssetTypeMapping&#39;) IS NOT NULL DROP TABLE #AssetTypeMapping;
-- ... repeat DROP TABLE for all #temp tables ...
IF OBJECT_ID(&#39;tempdb..#FinalNormalManagementFees&#39;) IS NOT NULL DROP TABLE #FinalNormalManagementFees;
</pre>
</div></div><hr/><h2 id="AmendManagementFeeCalculation:StaffvsNormal-Unit2:PrescribedPersonMapping">Unit 2: Prescribed Person Mapping</h2><p>Map each client’s <code>PrescribedPersonType</code> to a human‑readable category (Staff, Director, etc.).</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">;WITH PrescribedPerson AS (
    SELECT &#39;Staff&#39;           AS Type, 1 AS Id
    UNION ALL SELECT &#39;Director&#39;, 5
    UNION ALL SELECT &#39;N/A&#39;,         0
    -- add other mappings as needed
)
SELECT * INTO #PrescribedPerson FROM PrescribedPerson;
</pre>
</div></div><hr/><h2 id="AmendManagementFeeCalculation:StaffvsNormal-Unit3:Extract&amp;AggregateStaffFees">Unit 3: Extract &amp; Aggregate Staff Fees</h2><ol start="1"><li><p><strong>Extract</strong> raw monthly staff fees into <code>#StaffManagementFee</code>.</p></li><li><p><strong>Aggregate</strong> to monthly totals in <code>#FinalStaffManagementFee</code>.</p></li></ol><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">-- 3.1 Extract raw staff fees
;WITH StaffManagementFee AS (
    SELECT
      p.PortfolioReference AS ClientCode,
      p.PortfolioName      AS ClientName,
      ps.Code              AS PortfolioStatus,
      p.PortfolioClosedDate,
      pr.Type              AS StaffType,
      ob.BranchName        AS Branch,
      oac.CommissionCode   AS AdvisorCode,
      fp.Id                AS FeePackage_ID,
      fp.Name              AS FeePackageName,
      pct.AmountBaseCCY    AS StaffManagementFeecol
    FROM PortfolioCashTrade pct
    JOIN PortfolioOrder po   ON po.Id = pct.PortfolioOrder_ID
    JOIN Portfolio p         ON p.Id  = po.Portfolio_ID
    JOIN PortfolioStatus ps  ON ps.Id = p.STATUS
    JOIN Entity e            ON e.Id  = p.Client_Id
    JOIN #PrescribedPerson pr ON pr.Id = e.PrescribedPersonType
    JOIN FeeIncomeAndExpenseDetail fed ON fed.PortfolioCashTrade_Id = pct.Id
    JOIN Fee f               ON f.Id  = fed.Fee_Id
    JOIN FeePackage fp       ON fp.Id = f.FeePackage_ID
    WHERE
      -- date filter with 2-day buffer to catch late billing:
      (pct.CreatedDate IS NULL OR
       pct.CreatedDate BETWEEN @StartDate AND DATEADD(DAY,2,@EndDate))
      AND (p.PortfolioReference = @PortfolioID OR @PortfolioID IS NULL)
      AND f.Name LIKE &#39;%Management Fee Staff%&#39;
)
SELECT * INTO #StaffManagementFee FROM StaffManagementFee;

-- 3.2 Aggregate to monthly totals
SELECT
  ClientCode, ClientName, PortfolioStatus, PortfolioClosedDate,
  StaffType, Branch, AdvisorCode,
  FeePackage_ID, FeePackageName,
  SUM(StaffManagementFeecol) AS FinalStaffManagementFee
INTO #FinalStaffManagementFee
FROM #StaffManagementFee
GROUP BY
  ClientCode, ClientName, PortfolioStatus, PortfolioClosedDate,
  StaffType, Branch, AdvisorCode, FeePackage_ID, FeePackageName;
</pre>
</div></div><hr/><h2 id="AmendManagementFeeCalculation:StaffvsNormal-Unit4:BuildNormalFeeSchedule">Unit 4: Build Normal Fee Schedule</h2><h3 id="AmendManagementFeeCalculation:StaffvsNormal-4.1AssetTypeMapping">4.1 Asset Type Mapping</h3><p>Translate raw asset‐type codes into readable names.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">;WITH AssetTypeMapping AS (
    SELECT * FROM (VALUES
      (NULL,  NULL, &#39;Cash Call Account&#39;),
      (2,     &#39;FIX&#39;,  &#39;Term Deposits &amp; Debentures&#39;),
      (4,     &#39;UTR&#39;,  &#39;Unitised&#39;),
      (5,     &#39;SHA&#39;,  &#39;Shares&#39;),
      (6,     &#39;GOV&#39;,  &#39;Government Bonds&#39;),
      (7,     &#39;BND&#39;,  &#39;Bonds &amp; Notes&#39;)
    ) AS v (AssetType,ProductType,TypeName)
)
SELECT * INTO #AssetTypeMapping FROM AssetTypeMapping;
</pre>
</div></div><h3 id="AmendManagementFeeCalculation:StaffvsNormal-4.2RankedFeeScales">4.2 Ranked Fee Scales</h3><p>Normalize and rank each fee‐schedule tier per (FeePackage, AssetType).</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">;WITH RankedFeeScales AS (
  SELECT
    fp.Id                           AS FeePackage_ID,
    fp.Name                         AS FeePackageName,
    -- remap staff packages → normal package IDs
    CASE WHEN fp.Id IN (43,10) THEN 42 ELSE fp.Id END AS Normal_FeePackage_ID,
    -- remap staff names → normal names
    CASE
      WHEN fp.Name LIKE &#39;%Staff Fee Schedule%&#39; THEN REPLACE(fp.Name,&#39; Staff&#39;,&#39;&#39;)
      ELSE fp.Name
    END AS Normal_FeePackageName,
    atm.AssetType,
    COALESCE(atm.TypeName,&#39;Cash Call Account&#39;) AS AssetTypeName,
    fs.EndValue,
    fs.FeeValue                      AS AnnualisedFeeInPercentage,
    ROW_NUMBER() OVER (
      PARTITION BY fp.Name, atm.TypeName
      ORDER BY fs.EndValue
    ) AS RowNum
  FROM dbo.FeePackage fp
  JOIN dbo.Fee f            ON f.FeePackage_ID = fp.Id
  JOIN dbo.FeeScale fs      ON fs.Fee_Id       = f.Id
  LEFT JOIN #AssetTypeMapping atm ON fs.AssetType = atm.AssetType
  WHERE fp.Name LIKE &#39;%Fee Schedule%&#39;
)
SELECT * INTO #RankedFeeScales FROM RankedFeeScales;
</pre>
</div></div><h3 id="AmendManagementFeeCalculation:StaffvsNormal-4.3CalculatedRanges">4.3 Calculated Ranges</h3><p>Compute each tier’s <code>StartValue</code> (previous tier’s <code>EndValue</code> or 0).</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">;WITH CalculatedRanges AS (
  SELECT
    *,
    COALESCE(
      LAG(EndValue) OVER (
        PARTITION BY FeePackageName,AssetTypeName
        ORDER BY RowNum
      ), 0
    ) AS StartValue
  FROM #RankedFeeScales
)
SELECT * INTO #CalculatedRanges FROM CalculatedRanges;
</pre>
</div></div><h3 id="AmendManagementFeeCalculation:StaffvsNormal-4.4FinalFeeSchedulewithPercentages">4.4 Final Fee Schedule with Percentages</h3><p>Handle unbounded tiers (NULL <code>EndValue</code>) and persist final ranges.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">;WITH FeeScheduleWithPercentage AS (
  SELECT
    FeePackage_ID,
    FeePackageName,
    Normal_FeePackage_ID,
    Normal_FeePackageName,
    AssetTypeName,
    StartValue,
    EndValue,
    AnnualisedFeeInPercentage
  FROM #CalculatedRanges
  -- add logic here to fill NULL EndValue with MAX(EndValue)
)
SELECT * INTO #FeeScheduleWithPercentage FROM FeeScheduleWithPercentage;
</pre>
</div></div><hr/><h2 id="AmendManagementFeeCalculation:StaffvsNormal-Unit5:PortfolioValuationbyAssetType">Unit 5: Portfolio Valuation by Asset Type</h2><h3 id="AmendManagementFeeCalculation:StaffvsNormal-5.1PopulateDailyNAVDetail">5.1 Populate Daily NAV Detail</h3><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">;WITH TempValuationNZD AS (
  SELECT
    p.Id                     AS Portfolio_ID,
    p.PortfolioReference     AS ClientCode,
    ob.BranchName            AS Branch,
    oac.CommissionCode       AS AdvisorCode,
    atm.TypeName             AS AssetType,
    FORMAT(pvh.ValuationAsAtDate,&#39;yyyy-MM-dd&#39;) AS ValuationAsAtDate,
    pvhd.ValuationRootAmount AS ValuationNZD
  FROM PortfolioValuationHistoryDetail pvhd
  JOIN PortfolioValuationHistoryHeader pvh
    ON pvhd.PortfolioValuationHistoryHeader_Id = pvh.Id
  JOIN Portfolio p ON p.Id = pvh.Portfolio_Id
  JOIN dbo.FeePackage fp ON fp.Id = p.Portfolio_ID  -- example join
  -- … other joins for branch/advisor …
  WHERE pvh.ValuationAsAtDate BETWEEN @StartDate AND @EndDate
)
SELECT * INTO #TempValuationNZD FROM TempValuationNZD;
</pre>
</div></div><h3 id="AmendManagementFeeCalculation:StaffvsNormal-5.2AggregateperDate+AssetType">5.2 Aggregate per Date + Asset Type</h3><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">SELECT
  Portfolio_ID, ClientCode, Branch, AdvisorCode,
  AssetType, ValuationAsAtDate,
  SUM(ValuationNZD) AS ValuationNZD
INTO #PortfolioValuationByAssetType
FROM #TempValuationNZD
GROUP BY
  Portfolio_ID, ClientCode, Branch, AdvisorCode,
  AssetType, ValuationAsAtDate;
</pre>
</div></div><hr/><h2 id="AmendManagementFeeCalculation:StaffvsNormal-Unit6:DailyFeeCalculations(PiecewiseLinear)">Unit 6: Daily Fee Calculations (Piecewise Linear)</h2><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">SELECT
  tvn.ClientCode,
  tvn.ValuationAsAtDate,
  ROUND(tvn.ValuationNZD,2) AS ValuationNZD,
  sf.DailyStaffFee,
  nf.DailyNormalFee
INTO #FinalNormalManagementFees
FROM #PortfolioValuationByAssetType tvn

-- Staff fee tiers
OUTER APPLY (
  SELECT SUM(
    (CASE
       WHEN tvn.ValuationNZD &gt; fs.StartValue
         THEN (LEAST(tvn.ValuationNZD,fs.EndValue) - fs.StartValue)
       ELSE 0
     END)
     * fs.AnnualisedFeeInPercentage/100.0/365.0
  ) AS DailyStaffFee
  FROM #FeeScheduleWithPercentage fs
  WHERE fs.FeePackage_ID = tvn.FeePackage_Id
    AND fs.AssetTypeName  = tvn.AssetType
) sf

-- Normal fee tiers
OUTER APPLY (
  SELECT SUM(
    (CASE
       WHEN tvn.ValuationNZD &gt; fs2.StartValue
         THEN (LEAST(tvn.ValuationNZD,fs2.EndValue) - fs2.StartValue)
       ELSE 0
     END)
     * fs2.AnnualisedFeeInPercentage/100.0/365.0
  ) AS DailyNormalFee
  FROM #FeeScheduleWithPercentage fs2
  WHERE fs2.FeePackage_ID = tvn.Normal_FeePackage_ID
    AND fs2.AssetTypeName  = tvn.AssetType
) nf;
</pre>
</div></div><hr/><h2 id="AmendManagementFeeCalculation:StaffvsNormal-Unit7:Merge&amp;FinalOutput">Unit 7: Merge &amp; Final Output</h2><p>Join the <strong>monthly</strong> staff‐fee totals with the <strong>daily</strong> calculated fees for reporting (e.g. SSRS):</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">SELECT
  fsmf.ClientCode,
  fsmf.PortfolioStatus,
  fsmf.FeePackageName               AS StaffFeeSchedule,
  fnmf.ValuationAsAtDate,
  CAST(ROUND(fsmf.FinalStaffManagementFee,2) AS DECIMAL(10,2)) AS Actual_Monthly_StaffFee,
  CAST(ROUND(fnmf.DailyStaffFee,2)          AS DECIMAL(10,2))  AS Cal_DailyStaffFee,
  CAST(ROUND(fnmf.DailyNormalFee,2)         AS DECIMAL(10,2))  AS Cal_NormalManagementFee
FROM #FinalStaffManagementFee fsmf
JOIN #FinalNormalManagementFees fnmf
  ON fnmf.ClientCode = fsmf.ClientCode
WHERE fsmf.Branch IN (@Branch)
  AND fsmf.FeePackageName IN (@FeePackage)
  AND fsmf.PortfolioStatus IN (@PortfolioStatus)
ORDER BY fsmf.ClientCode, fnmf.ValuationAsAtDate;
</pre>
</div></div><hr/><h2 id="AmendManagementFeeCalculation:StaffvsNormal-PiecewiseLinearFeeFunction">Piecewise Linear Fee Function</h2><p>For each tier <em>i</em>:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">TierContribution_i =
  max(0, min(V, EndValue_i) – StartValue_i)
  × (Rate_i ÷ 100) ÷ 365
</pre>
</div></div><p>Summing these across all tiers yields the <strong>daily</strong> fee for NAV = V.</p><hr/><p><em>Document updated: April 22, 2025</em></p>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 18-08-25 20:53</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
