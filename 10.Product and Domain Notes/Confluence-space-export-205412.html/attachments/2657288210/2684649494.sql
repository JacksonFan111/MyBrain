-- Step 4b: Get the #BloombergPrice table, i found out most of the Bloomberg price missing the PX_AS/BID/LAST price, only the H.SecurityPrice have prices
DECLARE @AsAtDate2 DATE = '2024-07-31';

-- Drop the temporary table if it already exists
IF OBJECT_ID('tempdb..#BloombergPrice') IS NOT NULL 
    DROP TABLE #BloombergPrice;

-- Create a temporary table to store the results
SELECT DISTINCT
    H.BloombergCode,
    H.PX_ASK,
    H.PX_BID,
    H.AsAtDate,
    H.PX_LAST,
	H.SecurityPrice,
	-- Calculate the Price_Flag based on the conditions
    CASE 
        WHEN H.PX_LAST <= H.PX_ASK AND H.PX_LAST >= H.PX_BID THEN 'Use PX_LAST'
        WHEN H.PX_LAST < H.PX_BID THEN 'Use PX_BID'
        WHEN H.PX_LAST > H.PX_ASK THEN 'Use PX_ASK'
        ELSE 'Invalid Price'
    END AS Price_Flag,

    AssetMap.dataProviderID,
    AssetMap.dpAssetID,
    a.code AS [Exchange Security],

    c.isoCode AS Currency,
    a.dataProviderID AS AssetDataProviderID,
    a.status AS AssetStatus,
    a.primaryListing,
    e.code AS [Exchange_ID],

    e.name AS ExchangeName,
    e.status AS ExchangeStatus
INTO #BloombergPrice
FROM 
    [SQLCIP].[Bloomberg].[dbo].[History] AS H
INNER JOIN 
    [AACARPTSRV].[fusion].[dbo].[AssetDpMap] AS AssetMap
    ON H.BloombergCode = AssetMap.dpAssetID COLLATE Database_Default 
    AND AssetMap.dataProviderID = 29 -- Link between Fusion and Bloomberg
INNER JOIN  
    [AACARPTSRV].[fusion].[dbo].[Asset] AS a 
    ON a.assetID = AssetMap.assetID 
    AND a.status = 1
INNER JOIN 
    [AACARPTSRV].[fusion].[dbo].[Currency] AS c 
    ON a.currencyID = c.currencyID
    AND c.status = 1
INNER JOIN  
    [AACARPTSRV].[fusion].[dbo].[Exchange] AS e 
    ON e.exchangeID = a.exchangeID
    AND e.status = 1
WHERE 
1=1
    AND H.SecurityPrice IS NOT NULL
    AND H.AsAtDate = @AsAtDate2 -- Filter for the specified date
	


Select *
FROM #BloombergPrice
--WHERE [Exchange Security] ='AAD'


------------------this scritps is to cross comared Bloom 1 Web page data with our SQL CIP bloomberge data


-- Step 1: Create a temporary table to store BB CODEs
IF OBJECT_ID('tempdb..#BBCodes') IS NOT NULL 
    DROP TABLE #BBCodes;

CREATE TABLE #BBCodes (
    BBCode VARCHAR(50)
);

-- Step 2: Insert the BB CODEs manually or from another source
-- Example of inserting manually:
INSERT INTO #BBCodes (BBCode)
VALUES 
('AAD AU EQUITY'),
('ABC AU EQUITY'),
('ABP AU EQUITY'),
('ADH AU EQUITY'),
('AFI AU EQUITY'),
('AGL AU EQUITY'),
('AHG AU EQUITY'),
('AHY AU EQUITY'),
('AIA AU EQUITY'),
('AIR AU EQUITY'),
('AIZ AU EQUITY'),
('AKP AU EQUITY'),
('ALL AU EQUITY'),
('ALQ AU EQUITY'),
('ALX AU EQUITY'),
('AMC AU EQUITY'),
('AMP AU EQUITY'),
('ANN AU EQUITY'),
('ANZ AU EQUITY'),
('APA AU EQUITY'),
('API AU EQUITY'),
('APO AU EQUITY'),
('ARG AU EQUITY'),
('ARX AU EQUITY'),
('ASL AU EQUITY'),
('AST AU EQUITY'),
('ASX AU EQUITY'),
('ATL AU EQUITY'),
('AUQ AU EQUITY'),
('AVJ AU EQUITY'),
('AWC AU EQUITY'),
('AWE AU EQUITY'),
('AZJ AU EQUITY'),
('BBG AU EQUITY'),
('BEN AU EQUITY'),
('BHP AU EQUITY'),
('BIG AU EQUITY'),
('BKL AU EQUITY'),
('BLD AU EQUITY'),
('BLY AU EQUITY'),
('BOQ AU EQUITY'),
('BPT AU EQUITY'),
('BSL AU EQUITY'),
('BTT AU EQUITY'),
('BWP AU EQUITY'),
('BXB AU EQUITY'),
('CAR AU EQUITY'),
('CBA AU EQUITY'),
('CCP AU EQUITY'),
('CEN AU EQUITY'),
('CGF AU EQUITY'),
('CHC AU EQUITY'),
('CIM AU EQUITY'),
('CIP AU EQUITY'),
('CKF AU EQUITY'),
('CLH AU EQUITY'),
('CMW AU EQUITY'),
('CNU AU EQUITY'),
('COH AU EQUITY'),
('CPU AU EQUITY'),
('CQR AU EQUITY'),
('CSL AU EQUITY'),
('CSR AU EQUITY'),
('CTX AU EQUITY'),
('CWN AU EQUITY'),
('CWY AU EQUITY'),
('CYB AU EQUITY'),
('DBI AU EQUITY'),
('DLX AU EQUITY'),
('DMP AU EQUITY'),
('DOW AU EQUITY'),
('DXS AU EQUITY'),
('ECX AU EQUITY'),
('EHE AU EQUITY'),
('ERD AU EQUITY'),
('EVN AU EQUITY'),
('EWC AU EQUITY'),
('FBU AU EQUITY'),
('FGG AU EQUITY'),
('FLT AU EQUITY'),
('FMG AU EQUITY'),
('FPH AU EQUITY'),
('FSF AU EQUITY'),
('FXJ AU EQUITY'),
('FXL AU EQUITY'),
('GEM AU EQUITY'),
('GGX AU EQUITY'),
('GID AU EQUITY'),
('GMA AU EQUITY'),
('GMG AU EQUITY'),
('GNC AU EQUITY'),
('GOZ AU EQUITY'),
('GPT AU EQUITY'),
('GWA AU EQUITY'),
('GXL AU EQUITY'),
('GXY AU EQUITY'),
('HCW AU EQUITY'),
('HIL AU EQUITY'),
('HSO AU EQUITY'),
('HVN AU EQUITY'),
('IAG AU EQUITY'),
('IFL AU EQUITY'),
('IFN AU EQUITY'),
('IGO AU EQUITY'),
('ILU AU EQUITY'),
('INM AU EQUITY'),
('IOF AU EQUITY'),
('IPE AU EQUITY'),
('IPG AU EQUITY'),
('IPH AU EQUITY'),
('IPL AU EQUITY'),
('IRE AU EQUITY'),
('JBH AU EQUITY'),
('JHC AU EQUITY'),
('JHG AU EQUITY'),
('JHX AU EQUITY'),
('KMD AU EQUITY'),
('LBY AU EQUITY'),
('LLC AU EQUITY'),
('LNK AU EQUITY'),
('LSR AU EQUITY'),
('MFG AU EQUITY'),
('MGR AU EQUITY'),
('MIN AU EQUITY'),
('MMS AU EQUITY'),
('MPL AU EQUITY'),
('MQA AU EQUITY'),
('MQG AU EQUITY'),
('MTS AU EQUITY'),
('MYX AU EQUITY'),
('NAB AU EQUITY'),
('NCM AU EQUITY'),
('NEC AU EQUITY'),
('NHF AU EQUITY'),
('NSR AU EQUITY'),
('NST AU EQUITY'),
('NUF AU EQUITY'),
('NVL AU EQUITY'),
('NVT AU EQUITY'),
('NWS AU EQUITY'),
('NWSLV AU EQUITY'),
('NZM AU EQUITY'),
('NZM AU EQUITY'),
('ORA AU EQUITY'),
('ORE AU EQUITY'),
('ORG AU EQUITY'),
('ORI AU EQUITY'),
('OSH AU EQUITY'),
('OZL AU EQUITY'),
('PEN AU EQUITY'),
('PGH AU EQUITY'),
('PMV AU EQUITY'),
('PNI AU EQUITY'),
('PPT AU EQUITY'),
('PRY AU EQUITY'),
('PTM AU EQUITY'),
('PXA AU EQUITY'),
('QBE AU EQUITY'),
('QUB AU EQUITY'),
('RDY AU EQUITY'),
('REA AU EQUITY'),
('REG AU EQUITY'),
('RF1 AU EQUITY'),
('RFF AU EQUITY'),
('RFG AU EQUITY'),
('RHC AU EQUITY'),
('RIO AU EQUITY'),
('RMD AU EQUITY'),
('RRL AU EQUITY'),
('RSG AU EQUITY'),
('S32 AU EQUITY'),
('SAR AU EQUITY'),
('SBM AU EQUITY'),
('SCG AU EQUITY'),
('SCP AU EQUITY'),
('SDF AU EQUITY'),
('SEC AU EQUITY'),
('SEK AU EQUITY'),
('SFR AU EQUITY'),
('SGH AU EQUITY'),
('SGM AU EQUITY'),
('SGP AU EQUITY'),
('SGR AU EQUITY'),
('SHL AU EQUITY'),
('SIG AU EQUITY'),
('SKC AU EQUITY'),
('SKI AU EQUITY'),
('SKT AU EQUITY'),
('SLF AU EQUITY'),
('SM1 AU EQUITY'),
('SOL AU EQUITY'),
('SPK AU EQUITY'),
('SPO AU EQUITY'),
('SRX AU EQUITY'),
('STO AU EQUITY'),
('STW AU EQUITY'),
('SUL AU EQUITY'),
('SUN AU EQUITY'),
('SVW AU EQUITY'),
('SYD AU EQUITY'),
('SYR AU EQUITY'),
('SYS AU EQUITY'),
('TAG AU EQUITY'),
('TAH AU EQUITY'),
('TCL AU EQUITY'),
('TGG AU EQUITY'),
('TGR AU EQUITY'),
('TLS AU EQUITY'),
('TLX AU EQUITY'),
('TME AU EQUITY'),
('TNE AU EQUITY'),
('TOX AU EQUITY'),
('TPM AU EQUITY'),
('TWR AU EQUITY'),
('URW AU EQUITY'),
('VCX AU EQUITY'),
('VEA AU EQUITY'),
('VHT AU EQUITY'),
('VOC AU EQUITY'),
('VVR AU EQUITY'),
('WBC AU EQUITY'),
('WES AU EQUITY'),
('WFD AU EQUITY'),
('WHC AU EQUITY'),
('WMK AU EQUITY'),
('WOR AU EQUITY'),
('WOW AU EQUITY'),
('WPL AU EQUITY'),
('WSA AU EQUITY'),
('WZR AU EQUITY'),
('XRO AU EQUITY'),
('ZNC AU EQUITY'),
('W4F GR EQUITY'),
('ABI BB EQUITY'),
('ARKQ US EQUITY'),
('FANS CN EQUITY'),
('PLNT CN EQUITY'),
('VWS DC EQUITY'),
('ADS SW EQUITY'),
('SLMC SW EQUITY'),
('HTJ GF EQUITY'),
('1113 HK EQUITY'),
('2947 HK EQUITY'),
('6954 JP EQUITY'),
('YTLP MK EQUITY'),
('AAS LN EQUITY'),
('ABD LN EQUITY'),
('ATR LN EQUITY'),
('ATT LN EQUITY'),
('AV/ LN EQUITY'),
('BARC LN EQUITY'),
('BGFD LN EQUITY'),
('BHP LN EQUITY'),
('BNKR LN EQUITY'),
('BNZL LN EQUITY'),
('BP/ LN EQUITY'),
('BRBY LN EQUITY'),
('BRGE LN EQUITY'),
('BRSC LN EQUITY'),
('CLDN LN EQUITY'),
('CNA LN EQUITY'),
('COA LN EQUITY'),
('CPG LN EQUITY'),
('CTY LN EQUITY'),
('DGE LN EQUITY'),
('DLN LN EQUITY'),
('EDIN LN EQUITY'),
('ELTA LN EQUITY'),
('ENQ LN EQUITY'),
('EWI LN EQUITY'),
('FCS LN EQUITY'),
('FEV LN EQUITY'),
('FGT LN EQUITY'),
('FRCL LN EQUITY'),
('GLEN LN EQUITY'),
('GSK LN EQUITY'),
('HEFT LN EQUITY'),
('HFEL LN EQUITY'),
('HICL LN EQUITY'),
('HSBA LN EQUITY'),
('IEM LN EQUITY'),
('III LN EQUITY'),
('INFR LN EQUITY'),
('IWDP LN EQUITY'),
('JAM LN EQUITY'),
('JESC LN EQUITY'),
('JFJ LN EQUITY'),
('JGC LN EQUITY'),
('JGGI LN EQUITY'),
('JII LN EQUITY'),
('JMG LN EQUITY'),
('JMI LN EQUITY'),
('JUS LN EQUITY'),
('LAND LN EQUITY'),
('MIDD LN EQUITY'),
('MNKS LN EQUITY

'),
('MYI LN EQUITY'),
('NAIT LN EQUITY'),
('PCT LN EQUITY'),
('PLI LN EQUITY'),
('RB/ LN EQUITY'),
('RCP LN EQUITY'),
('RDSA LN EQUITY'),
('RDSB LN EQUITY'),
('RKT LN EQUITY'),
('REL LN EQUITY'),
('RICA LN EQUITY'),
('RIO LN EQUITY'),
('RR/ LN EQUITY'),
('S32 LN EQUITY'),
('SBRY LN EQUITY'),
('SDP LN EQUITY'),
('SGE LN EQUITY'),
('SHP LN EQUITY'),
('SMIN LN EQUITY'),
('SMT LN EQUITY'),
('SMWH LN EQUITY'),
('SSE LN EQUITY'),
('SST LN EQUITY'),
('SVT LN EQUITY'),
('TEM LN EQUITY'),
('TRG LN EQUITY'),
('TRY LN EQUITY'),
('TRY LN EQUITY'),
('TSCO LN EQUITY'),
('UEM LN EQUITY'),
('ULVR LN EQUITY'),
('UTL LN EQUITY'),
('UU/ LN EQUITY'),
('VOD LN EQUITY'),
('WWH LN EQUITY'),
('AGGNZX IX EQUITY'),
('DXJ LN EQUITY'),
('HEAL LN EQUITY'),
('IEMS LN EQUITY'),
('RBOD LN EQUITY'),
('RBOT LN EQUITY'),
('SAEM LN EQUITY'),
('SAJP LN EQUITY'),
('SASU LN EQUITY'),
('SAWD LN EQUITY'),
('SDJP LN EQUITY'),
('SDUS LN EQUITY'),
('SDWD LN EQUITY'),
('SEDM LN EQUITY'),
('SUAS LN EQUITY'),
('VHYD LN EQUITY'),
('VWRD LN EQUITY'),
('ACTC US EQUITY'),
('KRYS US EQUITY'),
('BLBD US EQUITY'),
('QQQ US EQUITY'),
('AAPL US EQUITY'),
('ADBE US EQUITY'),
('AMZN US EQUITY'),
('CAFD US EQUITY'),
('CSCO US EQUITY'),
('GOOG US EQUITY'),
('GOOGL US EQUITY'),
('ICPT US EQUITY'),
('MSFT US EQUITY'),
('NVDA US EQUITY'),
('QCOM US EQUITY'),
('VTRX US EQUITY'),
('PGLC US EQUITY'),
('BABA US EQUITY'),
('BRK/B US EQUITY'),
('C US EQUITY'),
('CAJ US EQUITY'),
('CVS US EQUITY'),
('DDD US EQUITY'),
('DIS US EQUITY'),
('ECL US EQUITY'),
('FMC US EQUITY'),
('FSM US EQUITY'),
('GE US EQUITY'),
('GES US EQUITY'),
('HPE US EQUITY'),
('HPQ US EQUITY'),
('JNJ US EQUITY'),
('JPM US EQUITY'),
('KEX US EQUITY'),
('KO US EQUITY'),
('LTHM US EQUITY'),
('MLM US EQUITY'),
('MMM US EQUITY'),
('MRK US EQUITY'),
('NKE US EQUITY'),
('PG US EQUITY'),
('PLYM US EQUITY'),
('QSR US EQUITY'),
('RSG US EQUITY'),
('SHLL US EQUITY'),
('SLB US EQUITY'),
('SO US EQUITY'),
('SPGI US EQUITY'),
('STO US EQUITY'),
('SU US EQUITY'),
('T US EQUITY'),
('TEI US EQUITY'),
('TM US EQUITY'),
('UL US EQUITY'),
('UTX US EQUITY'),
('V US EQUITY'),
('VRX US EQUITY'),
('VZ US EQUITY'),
('WFC US EQUITY'),
('WMT US EQUITY'),
('XPO US EQUITY'),
('ZTS US EQUITY'),
('CGW US EQUITY'),
('DGT US EQUITY'),
('DIA US EQUITY'),
('DVY US EQUITY'),
('DWX US EQUITY'),
('DXJ US EQUITY'),
('EEM US EQUITY'),
('EFA US EQUITY'),
('EPI US EQUITY'),
('EWJ US EQUITY'),
('EWU US EQUITY'),
('EWZ US EQUITY'),
('EXI US EQUITY'),
('EZU US EQUITY'),
('FXI US EQUITY'),
('GDX US EQUITY'),
('GEX US EQUITY'),
('GLD US EQUITY'),
('HEDJ US EQUITY'),
('IDU US EQUITY'),
('IEFA US EQUITY'),
('IEMG US EQUITY'),
('IEV US EQUITY'),
('IGM US EQUITY'),
('IVV US EQUITY'),
('IXG US EQUITY'),
('IXN US EQUITY'),
('IYR US EQUITY'),
('JNUG US EQUITY'),
('KRE US EQUITY'),
('PBW US EQUITY'),
('PZD US EQUITY'),
('RYH US EQUITY'),
('SCO US EQUITY'),
('SDY US EQUITY'),
('SHY US EQUITY'),
('SPPP US EQUITY'),
('SPY US EQUITY'),
('VEU US EQUITY'),
('VGK US EQUITY'),
('VHT US EQUITY'),
('VNQ US EQUITY'),
('VO US EQUITY'),
('VOO US EQUITY'),
('VPL US EQUITY'),
('VT US EQUITY'),
('VTV US EQUITY'),
('VWO US EQUITY'),
('XLK US EQUITY'),
('LNG US EQUITY'),
('XPL US EQUITY'),
('ABA NZ EQUITY'),
('AFI NZ EQUITY'),
('AFT NZ EQUITY'),
('AGG NZ EQUITY'),
('AIA NZ EQUITY'),
('AIR NZ EQUITY'),
('ALF NZ EQUITY'),
('AMP NZ EQUITY'),
('ANZ NZ EQUITY'),
('ANZBAGR NZ EQUITY'),
('ANZBALA NZ EQUITY'),
('ANZCOBA NZ EQUITY'),
('ANZCONS NZ EQUITY'),
('ANZGROW NZ EQUITY'),
('APA NZ EQUITY'),
('APL NZ EQUITY'),
('ARB NZ EQUITY'),
('ARG NZ EQUITY'),
('ARV NZ EQUITY'),
('ASBPA NZ EQUITY'),
('ASD NZ EQUITY'),
('ASF NZ EQUITY'),
('ASP NZ EQUITY'),
('ASR NZ EQUITY'),
('ATM NZ EQUITY'),
('AUE NZ EQUITY'),
('AUG NZ EQUITY'),
('AUS NZ EQUITY'),
('AWF NZ EQUITY'),
('BFW NZ EQUITY'),
('BGP NZ EQUITY'),
('BIT NZ EQUITY'),
('BLT NZ EQUITY'),
('BOT NZ EQUITY'),
('BRM NZ EQUITY'),
('CAV NZ EQUITY'),
('CBD NZ EQUITY'),
('CDI NZ EQUITY'),
('CEN NZ EQUITY'),
('CGF NZ EQUITY'),
('CHI NZ EQUITY'),
('CMO NZ EQUITY'),
('CNU NZ EQUITY'),
('CO2 NZ EQUITY'),
('CRP NZ EQUITY'),
('CVT NZ EQUITY'),
('DGC NZ EQUITY'),
('DGL NZ EQUITY'),
('DIV NZ EQUITY'),
('EBO NZ EQUITY'),
('EMF NZ EQUITY'),
('EMG NZ EQUITY'),
('ENS NZ EQUITY'),
('ERD NZ EQUITY'),
('ESG NZ EQUITY'),
('EUF NZ EQUITY'),
('EUG NZ EQUITY'),
('EVO NZ EQUITY'),
('FBU NZ EQUITY'),
('FCG NZ EQUITY'),
('FCT NZ EQUITY'),
('FFW NZ EQUITY'),
('FIN NZ EQUITY'),
('FNZ NZ EQUITY'),
('FPH NZ EQUITY'),
('FRE NZ EQUITY'),
('FRW NZ EQUITY'),
('FSF NZ EQUITY'),
('GBF NZ EQUITY'),
('GFI NZ EQUITY'),
('GFL NZ EQUITY'),
('GGB NZ EQUITY'),
('GMT NZ EQUITY'),
('GNE NZ EQUITY'),
('GPR NZ EQUITY'),
('GTK NZ EQUITY'),
('GXH NZ EQUITY'),
('HBL NZ EQUITY'),
('HFL NZ EQUITY'),
('HGH NZ EQUITY'),
('HLG NZ EQUITY'),
('IFT NZ EQUITY'),
('IKE NZ EQUITY'),
('INF NZ EQUITY'),
('INGAUSH NZ EQUITY'),
('INGBALF NZ EQUITY'),
('INGEQSL NZ EQUITY'),
('INGINTS NZ EQUITY'),
('INGNZSH NZ EQUITY'),
('INGPROP NZ EQUITY'),
('INGS6BL NZ EQUITY'),
('INGS6CP NZ EQUITY'),
('INGS6IN NZ EQUITY'),
('INGS6NZ NZ EQUITY'),
('IPL NZ EQUITY'),
('JPG NZ EQUITY'),
('JPN NZ EQUITY'),
('KFL NZ EQUITY'),
('KMD NZ EQUITY'),
('KPG NZ EQUITY'),
('LIC NZ EQUITY'),
('LIV NZ EQUITY'),
('MAD NZ EQUITY'),
('MCK NZ EQUITY'),
('MCY NZ EQUITY'),
('MDZ NZ EQUITY'),
('MEL NZ EQUITY'),
('MET NZ EQUITY'),
('MFB NZ EQUITY'),
('MFLPROP NZ EQUITY'),
('MFT NZ EQUITY'),
('MGL NZ EQUITY'),
('MHJ NZ EQUITY'),
('MHM NZ EQUITY'),
('MLN NZ EQUITY'),
('MMH NZ EQUITY'),
('MNTNZAE NZ EQUITY'),
('MNTNZRE NZ EQUITY'),
('MNW NZ EQUITY'),
('MOA NZ EQUITY'),
('MOV NZ EQUITY'),
('MPG NZ EQUITY'),
('MZY NZ EQUITY'),
('NGB NZ EQUITY'),
('NPF NZ EQUITY'),
('NPH NZ EQUITY'),
('NPT NZ EQUITY'),
('NTL NZ EQUITY'),
('NWF NZ EQUITY')

-- Step 3: Compare BB CODEs in the temporary table with the Bloomberg database
SELECT 
    b.BBCode,
    h.BloombergCode,
    h.AsAtDate,
    h.PX_ASK,
    h.PX_BID,
    h.PX_LAST,
    CASE 
        WHEN h.BloombergCode IS NOT NULL THEN 'Found'
        ELSE 'Missing'
    END AS Status
FROM 
    #BBCodes b
LEFT JOIN 
    [SQLCIP].[Bloomberg].[dbo].[History] h
    ON b.BBCode = h.BloombergCode
    AND h.AsAtDate = '2024-07-31'  -- Replace with your desired date

ORDER BY 
    Status DESC, BBCode;

-- Step 4: Clean up the temporary table
--DROP TABLE IF EXISTS #BBCodes;

