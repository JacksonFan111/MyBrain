<!DOCTYPE html>
<html>
    <head>
        <title>Jackson Fan : CRM-ACE + Fusion (Workspace)-TabularSecurity-Retired CodesFind out who retired</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Jackson Fan</a></span>
                            </li>
                                                    <li>
                                <span><a href="JF-Space-Overview_2554888272.html">JF Space Overview</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Jackson Fan : CRM-ACE + Fusion (Workspace)-TabularSecurity-Retired CodesFind out who retired
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                            
        
    
        
    
        
        
            Created by <span class='author'> Jackson Fan</span>, last modified on 12-08-25
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>Love the brief. I’m going to assume your typo “requtied adviser” meant <strong>retired adviser</strong> (given the whole thread). If you meant something else, say the word and I’ll pivot.</p><p>Below is a clean, <strong>redesigned end-to-end</strong> that bakes in all the gnarly realities you flagged: JOINT names are usually <strong>First + Last-initial</strong>, nicknames abound (“Tom” ⇄ “Thomas”), CRM is the <strong>retirement authority</strong>, TabularSecurity is the <strong>access/commission authority</strong>, and neither ACE nor Fusion has a true “primary role id”.</p><p>I’ve split this into: background &amp; principles → data lineage → definitions (what counts as <strong>retired</strong>) → high-level steps (runbook) → algorithm details (esp. JOINT parsing) → code goals (how to implement safely) → outputs &amp; KPIs → a tiny illustration.</p><hr/><h1 id="CRM-ACE+Fusion(Workspace)-TabularSecurity-RetiredCodesFindoutwhoretired-Background&amp;designprinciples">Background &amp; design principles</h1><p><strong>Business reality</strong></p><ul><li><p>Retired advisers may still receive <strong>commission</strong> (for months), but must <strong>lose client access</strong>.</p></li><li><p>CRM flags the <strong>code</strong> as retired; Workspace (Fusion/ACE) carries the <strong>labels &amp; memberships</strong> clients see.</p></li><li><p>Operations also need an <strong>Insights delta</strong> when CRM’s <em>Primary Adviser</em> changes but Workspace hasn’t caught up.</p></li></ul><p><strong>Design rules</strong></p><ol start="1"><li><p><strong>Source-of-truth</strong>:</p><ul><li><p>Retirement state → <strong>CRM</strong> <code>dsl_advisercommissioncode</code> (flag + date).</p></li><li><p>Access &amp; commission payout routing → <strong>TabularSecurity</strong> (<code>Is Adviser</code>, <code>InCommission</code>).</p></li><li><p>Client/adviser memberships + display names → <strong>ACE + Fusion</strong>.</p></li></ul></li><li><p><strong>Treat JOINT parsing as first-class</strong>: default pattern is <strong>First + Last-initial</strong>; support nicknames and initials on either side.</p></li><li><p><strong>Deterministic “operational primary”</strong> (no role id): pick the single best Workspace membership by activity and assignment recency.</p></li><li><p><strong>Explainability</strong>: every surfaced row shows <em>why</em> it’s here (ResultReason) and <em>how sure</em> we are (ConfidenceScore, Ambiguous flags).</p></li><li><p><strong>Safety &amp; auditability</strong>: idempotent loads, minimal permissions, evidence columns (raw+normalised names), and run logs.</p></li></ol><hr/><h1 id="CRM-ACE+Fusion(Workspace)-TabularSecurity-RetiredCodesFindoutwhoretired-Datalineage(linkedviaOPENQUERYonSQLCIP)">Data lineage (linked via OPENQUERY on SQLCIP)</h1><p><strong>CRM</strong> <code>[TGASQLPROD\TGASQLCRM]</code></p><ul><li><p><code>dsl_portfolioservice</code> (+ <code>StringMap</code>, <code>account</code>, <code>BusinessUnitBase</code>) → PortfolioCode, CRM Primary Adviser <em>name</em>, Branch, Status.</p></li><li><p><code>dsl_advisercommissioncode</code> (+ <code>dsl_advisercommissionlink</code>, <code>SystemUser</code>, <code>BusinessUnitBase</code>) → <strong>Retired codes</strong> + Full adviser names.</p></li></ul><p><strong>ACE / Workspace (Chelmer)</strong> <code>AACARPTSRV</code></p><ul><li><p>ACE: <code>StClients_Master</code>, <code>StClientParents</code>, <code>StClientAdvisor</code>, <code>StAdvisors</code>, <code>AcHoldings</code>.</p></li><li><p>Fusion: <code>Portfolio</code>, <code>Drum</code>, <code>DrumMbs</code>, <code>SysUser</code>.</p></li><li><p>Keys: <strong>Client</strong> <code>ACE.LedgerID ⇄ Fusion.Drum.code</code>; <strong>Adviser</strong> <code>'AG_' + AdvisorID ⇄ Fusion.AdviserGroup.code</code>.</p></li></ul><p><strong>TabularSecurity</strong> <code>KAPSQLDAT-PRD01</code></p><ul><li><p><code>ReferenceBI.dbo.TabularSecurity_v</code> → AdviserCode, ADUserName, UserType, <strong>Is Adviser</strong>, <strong>InCommission</strong> (no WHERE filter).</p></li></ul><hr/><h1 id="CRM-ACE+Fusion(Workspace)-TabularSecurity-RetiredCodesFindoutwhoretired-Whatcountsasaretiredadviser(decisiontree)">What counts as a <strong>retired adviser</strong> (decision tree)</h1><p><strong>A. Code-retired (authoritative)</strong></p><ul><li><p>CRM <code>dsl_advisercommissioncode.dsl_Retired = 1</code> → <strong>Retired</strong> (record RetiredDate).</p><ul><li><p>If TabularSecurity shows <code>Is Adviser = 'Yes'</code> → <strong>Access removal needed</strong> (but commission may remain).</p></li></ul></li></ul><p><strong>B. JOINT-retired (name-based)</strong></p><ul><li><p>The ACE/Workspace adviser <strong>display name</strong> (often “JOINT – …”) contains a person who is retired in CRM, matched via:</p><ul><li><p><strong>First + Last-initial</strong> (e.g., <code>TOM D</code>) <strong>or</strong></p></li><li><p><strong>First-initial + Last</strong> (<code>T DAVIS</code>) <strong>or</strong></p></li><li><p><strong>First + Last</strong> (<code>TOM DAVIS</code>)<br/>with <strong>nickname variants</strong> (TOM⇄THOMAS, BOB⇄ROBERT…) and <strong>branch narrowing</strong>.</p></li></ul></li></ul><p>If either A or B is true → treat as <strong>retired present</strong> for reporting &amp; remediation.</p><hr/><h1 id="CRM-ACE+Fusion(Workspace)-TabularSecurity-RetiredCodesFindoutwhoretired-High-levelrunbook(end-to-endsteps)">High-level runbook (end-to-end steps)</h1><ol start="1"><li><p><strong>Ingest (staging)</strong></p><ul><li><p>Pull CRM parents, ACE parents, retired codes, and full TabularSecurity into <strong>staging temp/permanent</strong> tables.</p></li><li><p>Record <code>run_id</code>, <code>source_rowcount</code>, <code>pulled_at</code>.</p></li></ul></li><li><p><strong>Normalise</strong></p><ul><li><p>Name cleaning on both sides: uppercase; strip “JOINT –”, “INHERITED –”, “HEAD OFFICE –”; punctuation→space; collapse doubles; <code>&amp;/AND</code> unified.</p></li><li><p>Keep both <strong>raw</strong> and <strong>normalised</strong> strings.</p></li></ul></li><li><p><strong>Mismatch classification</strong></p><ul><li><p>Compute <strong>Adviser code / Branch / Status</strong> mismatches and <strong>Name similarity</strong> (token Jaccard).</p></li><li><p>Keep “SUSPENDED” names (flag them), don’t filter out.</p></li></ul></li><li><p><strong>JOINT retired detection (core)</strong></p><ul><li><p>Build <strong>RetiredVariants</strong> from CRM retirees: {Formal first, Nick first, First-initial} × {Last, Last-initial}.</p></li><li><p>Parse JOINT names into fragments; match by:</p><ul><li><p><code>FirstVariant + Last</code>, <code>FirstVariant + LastInitial</code>, <code>FirstInitial + Last</code>.</p></li></ul></li><li><p><strong>Narrow by branch</strong> when multiple hits; flag <strong>Ambiguous</strong> when still &gt;1.</p></li></ul></li><li><p><strong>Operational primary (derived)</strong></p><ul><li><p>For each client (LedgerID), pick <strong>Workspace primary</strong> as the active adviser membership with: <code>dm.status=1</code>, <code>s.status=1</code>, non-null <code>lastLogonTime</code>, <strong>latest</strong> <code>lastLogonTime</code> (tie-break by <code>assignmentDate</code> when present).</p></li><li><p>Map ACE adviser to <code>'AG_' + AdvisorID</code>.</p></li><li><p>Surface <strong>differences only</strong> (ACE vs Fusion group).</p></li></ul></li><li><p><strong>Whitelist &amp; business filters</strong></p><ul><li><p>Drop known JOINT strings <strong>only if</strong> <code>CRM_AdviserCode = ACE_AdviserCode</code> (your rule).</p></li><li><p>Exclude one-off/office/house codes per your masks.</p></li></ul></li><li><p><strong>Confidence &amp; reason</strong></p><ul><li><p>Compute a <strong>ConfidenceScore</strong> (e.g., +2 full last match; +1 last-initial match; +1 nickname match; +1 branch match; −2 ambiguous).</p></li><li><p>Set <code>ResultReason</code> to the strongest trigger (Missing in TS / Adviser Code Marked Retired / Name/Code Mismatch).</p></li></ul></li><li><p><strong>Publish outputs</strong></p><ul><li><p><strong>Action queue</strong> table/view with all flags; <strong>Primary-adviser delta</strong> table/view.</p></li><li><p>Optional rollups by Branch / Error / ResultReason.</p></li></ul></li><li><p><strong>Logging &amp; QA</strong></p><ul><li><p>Insert to a <strong>run log</strong> with counts by category; store sample rows for each bucket.</p></li><li><p>(Optional) Compare against a <strong>gold list</strong> of known retirees to monitor precision/recall.</p></li></ul></li></ol><hr/><h1 id="CRM-ACE+Fusion(Workspace)-TabularSecurity-RetiredCodesFindoutwhoretired-Algorithmdetails(thetrickyparts)">Algorithm details (the tricky parts)</h1><h2 id="CRM-ACE+Fusion(Workspace)-TabularSecurity-RetiredCodesFindoutwhoretired-JOINTparser(first-class)">JOINT parser (first-class)</h2><ul><li><p><strong>Clean</strong>: remove leading “JOINT –”, unify “&amp;/AND/,” to a single delimiter <code>|</code>, trim punctuation.</p></li><li><p><strong>Split</strong> into fragments on <code>|</code>.</p></li><li><p>For each fragment:</p><ul><li><p>Extract <code>FirstCandidate</code> (first token), <code>LastCandidate</code> (last token).</p></li><li><p>Compute <code>FirstInitial</code>, <code>LastInitial</code>.</p></li><li><p>Match against <strong>RetiredVariants</strong>:</p><ul><li><p><code>FirstVariant + Last</code> → <strong>strong</strong></p></li><li><p><code>FirstVariant + LastInitial</code> → <strong>normal</strong></p></li><li><p><code>FirstInitial + Last</code> → <strong>normal</strong></p></li></ul></li><li><p>If multiple retiree hits:</p><ul><li><p><strong>Branch narrow</strong>: prefer retiree whose <code>BranchCode</code> = ACE/CRM branch.</p></li><li><p>If still &gt;1 → <strong>Ambiguous = 1</strong>.</p></li></ul></li></ul></li><li><p>Build <code>JointRetiredNames</code> CSV from positive matches.</p></li></ul><h2 id="CRM-ACE+Fusion(Workspace)-TabularSecurity-RetiredCodesFindoutwhoretired-Derivedprimary(noroleid)">Derived primary (no role id)</h2><ul><li><p>Rank candidate Workspace memberships by:</p><ol start="1"><li><p><code>s.lastLogonTime</code> (desc)</p></li><li><p><code>dm.assignmentDate</code> (desc, if populated)</p></li><li><p><code>Advisergroup</code> alphabetical (stable tie-break)</p></li></ol></li><li><p>Output the winner as <strong>Fusion_AdviserGroup</strong> (+ Adviser name/login).</p></li><li><p>Compare to <strong>ACE_AdvisorGroup</strong> = <code>'AG_' + AdvisorID</code> from ACE.</p></li></ul><hr/><h1 id="CRM-ACE+Fusion(Workspace)-TabularSecurity-RetiredCodesFindoutwhoretired-Codegoals(howtoimplementcleanly)">Code goals (how to implement cleanly)</h1><p><strong>Objects (modular)</strong></p><ul><li><p><code>stg.CRM_Parents</code>, <code>stg.ACE_Parents</code>, <code>stg.RetiredCodes</code>, <code>stg.TabSec</code> (per-run replace; keep <code>run_id</code>).</p></li><li><p><code>cur.ReconcileBase</code> (normalised; indexed on codes, branch).</p></li><li><p><code>dim.RetiredVariants</code> (re-built each run).</p></li><li><p><code>mart.Recon_ActionQueue</code> and <code>mart.Recon_PrimaryDelta</code>.</p></li><li><p><code>ops.Recon_RunLog</code>, <code>ops.Recon_Rollup</code>.</p></li></ul><p><strong>Stored procedures</strong></p><ul><li><p><code>ops.usp_Recon_Extract(@run_id)</code> → OPENQUERY pulls.</p></li><li><p><code>ops.usp_Recon_Normalise(@run_id)</code> → names, keys.</p></li><li><p><code>ops.usp_Recon_Classify(@run_id)</code> → mismatches, JOINT detection, confidence.</p></li><li><p><code>ops.usp_Recon_Publish(@run_id)</code> → marts, rollups, logging.</p></li></ul><p><strong>Implementation notes</strong></p><ul><li><p>Use <strong>OPENQUERY</strong> for cross-server; keep <strong>collation</strong> consistent (<code>DATABASE_DEFAULT</code>) on comparisons.</p></li><li><p>Index on <code>(ACEAdviserCode, CRMAdviserCode, PortfolioCode, ACEBranch, CRMBranch)</code>.</p></li><li><p>Keep <strong>raw</strong> and <strong>normalised</strong> name columns for audit.</p></li><li><p>Maintain a small <strong>Nicknames</strong> table; allow business to add rows (TOM⇄THOMAS, BOB⇄ROBERT…).</p></li></ul><hr/><h1 id="CRM-ACE+Fusion(Workspace)-TabularSecurity-RetiredCodesFindoutwhoretired-Outputs(whatyourteamsees)">Outputs (what your team sees)</h1><p><strong>A) Action queue (one row per portfolio when surfaced)</strong><br/>Key columns:</p><ul><li><p>PortfolioCode, AccountName, CRMBranch, ACEBranch</p></li><li><p>CRM_AdviserCode, ACE_AdviserCode, CRM_PS_PrimaryAdviserName, ACEAdviserName</p></li><li><p>CRM_PS_Status, ACEStatus, <strong>ACENameHasSuspended</strong></p></li><li><p>RetiredFlag, RetiredDate, <strong>JointContainsRetired</strong>, <strong>JointRetiredNames</strong>, <strong>AmbiguousNickMatch</strong></p></li><li><p>TS_AdviserCode, <strong>IsAdviserFlag</strong>, <strong>InCommission</strong></p></li><li><p><strong>ResultReason</strong>, <strong>ConfidenceScore</strong></p></li></ul><p><strong>B) Primary-adviser delta (differences only)</strong></p><ul><li><p>LedgerID, ClientName</p></li><li><p>ACE_AdvisorGroup, Fusion_AdviserGroup</p></li><li><p>Fusion_AdviserName, Fusion_Login, Fusion_LastLogon</p></li></ul><p><strong>C) Rollups</strong></p><ul><li><p>Counts by <code>ResultReason</code>, by Branch; trend by run.</p></li></ul><hr/><h1 id="CRM-ACE+Fusion(Workspace)-TabularSecurity-RetiredCodesFindoutwhoretired-KPIstomonitorquality">KPIs to monitor quality</h1><ul><li><p><strong>Recall on retirees</strong> = % of known retirees appearing either as <code>RetiredFlag=1</code> or <code>JointContainsRetired=1</code>.</p></li><li><p><strong>Precision on JOINT</strong> = % of JOINT-flagged that ops confirm are true retirees (low ambiguity, correct branch).</p></li><li><p><strong>Lag</strong>: median days between CRM change and Workspace alignment (from Primary-delta list).</p></li></ul><hr/><h1 id="CRM-ACE+Fusion(Workspace)-TabularSecurity-RetiredCodesFindoutwhoretired-Simpleillustration—whois“retiredpresent”?">Simple illustration — who is “retired present”?</h1><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">               ┌───────────────────────────────────────┐
               │   CRM.advisercode Retired = 1 ?       │
               └───────────────┬───────────────────────┘
                               │Yes
                               ▼
                     Retired present (code)
                               │
                               │   (Also check TabSec:
                               │    If IsAdviser=&#39;Yes&#39; → remove access)
                               │
No                            Yes
┌─────────────────────┐       ┌───────────────────────────────────────┐
│ JOINT name contains │◄──────┤  Parse fragments:                    │
│ retired person via  │       │   - First+Last   (TOM DAVIS)         │
│  First+LastInitial, │       │   - First+L.Init (TOM D)   ← default │
│  FirstInitial+Last, │       │   - F.Init+Last  (T DAVIS)           │
│  with nicknames?    │       │  Narrow by branch; flag ambiguous     │
└─────────┬───────────┘       └───────────────────────────────────────┘
          │Yes
          ▼
  Retired present (JOINT)
</pre>
</div></div><hr/><h2 id="CRM-ACE+Fusion(Workspace)-TabularSecurity-RetiredCodesFindoutwhoretired-Whythiswillworkbetterforyourdata">Why this will work better for your data</h2><ul><li><p><strong>Assumes First+Last-initial</strong> is the <em>normal</em> JOINT format → the matcher is tuned for it, not as an edge case.</p></li><li><p><strong>Nickname-aware</strong> and <strong>branch-narrowed</strong> → fewer false hits on “Tom D”.</p></li><li><p><strong>No role id required</strong> → primary is derived from real activity; exactly what the business cares about.</p></li><li><p><strong>Actionable flags</strong> (SUSPENDED labels kept; commission vs access separated) → clear next steps for ops.</p></li><li><p><strong>ConfidenceScore</strong> and ambiguity flag → you can sort the queue by “easy wins” first.</p></li></ul><hr/><p>If you want, I can turn this into:</p><ul><li><p>a <strong>single deploy script</strong> (schemas + procs + indexes + views),</p></li><li><p>plus a <strong>5-minute quickstart</strong> (how to run, what to open in Insights, and who owns fixes per bucket).</p></li></ul>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 18-08-25 20:54</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
