<!DOCTYPE html>
<html>
    <head>
        <title>Jackson Fan : FATCA/CRS Stories so far</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Jackson Fan</a></span>
                            </li>
                                                    <li>
                                <span><a href="JF-Space-Overview_2554888272.html">JF Space Overview</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Jackson Fan : FATCA/CRS Stories so far
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                            
        
    
        
    
        
        
            Created by <span class='author'> Jackson Fan</span>, last modified on 08-01-25
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>Once upon a time, <strong>Jackson Fan</strong>, a meticulous and curious data engineer, embarked on a mission to build a robust <strong>FATCA/CRS</strong> data-processing workflow for his firm. Jackson had a keen eye for detail and a talent for spotting hidden pitfalls in complex systems.</p><p>In late 2024, Jackson found himself wrestling with the <strong>CRM</strong> system’s data. He noticed it contained multiple inaccuracies—some were due to rushed data entries by the firm’s assistants, others stemmed from confusion around entity-level versus individual-level flags. Worse, nested (“layered”) entities, such as trusts-within-trusts and multi-layer partnerships, were only half-understood in the existing scripts.</p><p>Determined to fix it, Jackson drafted a new stored procedure, called <strong>FATCAFATCA.USP01FATCACRSExtractAndPrepareDataUSP_01_FATCA_CRS_ExtractAndPrepareData</strong>, which tackled steps <strong>1 through 6</strong> of the FATCA/CRS reporting process. He poured long hours into recoding the logic:</p><ol start="1"><li><p><strong>Creating a Master Mapping Table</strong><br/>He designed a <code>#TaxRegimeMapping</code> table to consolidate the CRM’s cryptic “ReportCode” flags into straightforward regimes: <strong>FATCA</strong>, <strong>CRS</strong>, or <strong>FATCA_CRS</strong>.</p></li><li><p><strong>Unraveling Layered Entities with Recursive CTEs</strong><br/>Since the CRM stored trust structures in a labyrinth of parent-child relationships, Jackson built <code>#RecursiveHierarchy</code> to systematically delve multiple levels deep. He tested everything, from a single-level limited company to a many-layered trust, ensuring no infinite loops.</p></li><li><p><strong>Gathering Individuals</strong><br/>Jackson understood that an entity’s real controlling players weren’t always obvious. A single trust could hide multiple beneficiaries, directors, or corporate trustee agents. So, he created <code>#HierarchyIndividuals</code> to pull them all together.</p></li><li><p><strong>Extracting Entity Data with TIN Checks</strong><br/>He realized some entities had missing or invalid “foreign tax record” fields. By carefully joining on individual-level TIN data, Jackson made sure only legitimate foreign connections appeared—no more phantom foreign flags or erroneous TINs.</p></li><li><p><strong>Focusing on Individuals</strong><br/>Up next, Jackson measured how many TINs each beneficial owner held (e.g., single TIN vs. multiple TINs). This step was especially critical in global tax reporting, since multiple nationalities could each require separate compliance actions.</p></li><li><p><strong>Complex Filtering &amp; Final Consolidation</strong><br/>Finally, Jackson brought it all together, merging entities and individuals into a single staging dataset. He enforced a series of rules—like excluding pure New Zealand TINs, ignoring certain KiwiSaver portfolios, and dropping financial institutions that should do their own FATCA/CRS reporting.</p></li></ol><p>Despite the complexities, Jackson’s procedure eventually ran smoothly, finishing in about six and a half minutes—unless someone requested a holdings refresh, which could push it to nearly thirty! This code laid the groundwork for <strong>Step 7</strong>, where data would be pivoted and further adjusted to catch non-foreign co-holders of accounts that had at least one foreign controlling individual.</p><p>Jackson felt a wave of relief and pride. By methodically rewriting (and heavily commenting) the original scripts, he had dispelled confusion around layered entities, validated TIN data, and produced a tidy staging table named <code>FATCA.Stage_crmdatafatcacrs_jf</code>. Now, the firm finally had a <strong>solid</strong> foundation to comply with <strong>global tax</strong> regulations and to build out the rest of its <strong>FATCA/CRS</strong> reporting pipeline.</p><p>And so, with a well-structured stored procedure, Jackson successfully tamed the chaos of CRM data, one step closer to ensuring proper <strong>FATCA/CRS</strong> compliance for every trust, every partnership, and every layered entity that came his way.</p><p /><hr/><p><strong>Once Jackson Fan finalized the Step 7 logic</strong>—covering both <strong>CRS</strong> and <strong>FATCA</strong> sets, pivoting TINs, and ensuring that <strong>non-foreign account holders</strong> were included if they belonged to any entity with a foreign controlling individual—he breathed a sigh of relief. The second stored procedure, <strong>FATCAFATCA.USP02FATCACRSTransformRowtoColumnDataUSP_02_FATCA_CRS_TransformRowtoColumnData</strong>, had grown in complexity but was now <strong>robust</strong> enough to handle a variety of unexpected data issues.</p><ol start="1"><li><p><strong>Non-Foreign Account Holders</strong><br/>Jackson realized that sometimes a single account had both foreign and non-foreign members. If any member was foreign, the entire account had to be reported, which meant bringing in the names of the <strong>non-foreign</strong> individuals as well. To capture them, he built the logic that inserted these names into a reference table, <strong>FATCA.NonForeignAccHolderData_jf</strong>, then <strong>LEFT JOIN</strong>ed that table back after pivoting.</p></li><li><p><strong>CRS-Only vs. FATCA-Only Separation</strong><br/>Next, Jackson tackled the <strong>overlapping</strong> TIN problem by splitting the dataset into two temp tables:</p><ul><li><p><strong>#CRSOnlyData</strong>: Contains only TINs from <strong>non-US</strong> countries, ignoring rows with <code>Ind_TaxCodeCountryISO = 'USA'</code>.</p></li><li><p><strong>#FATCAOnlyData</strong>: Focuses exclusively on <strong>US</strong> TINs (<code>Ind_TaxCodeCountryISO = 'USA'</code>).</p></li></ul><p>By separating the data first, he avoided messy duplications, ensuring each individual’s TIN would appear only in the correct context.</p></li><li><p><strong>Assigning Row Numbers</strong><br/>Since some individuals hold multiple TINs (for different countries), Jackson needed a way to <strong>pivot</strong> TIN rows into columns. Using <code>DENSE_RANK()</code> solved the problem:</p><ul><li><p>For <strong>CRS</strong> individuals with up to 5 TINs, he labeled them TIN1..TIN5 in columns.</p></li><li><p>For <strong>FATCA</strong>, typically only one TIN (the US TIN) was needed, so the pivot logic was simpler.</p></li></ul></li><li><p><strong>Pivoting TINs</strong><br/>After numbering rows, Jackson performed a <strong>self join</strong>:</p><ul><li><p><strong>CRS</strong>: Up to 5 TIN columns (#CRSPivotedData).</p></li><li><p><strong>FATCA</strong>: Only TIN1 (#FATCAPivotedData).</p></li></ul><p>This layout aligns with <strong>reporting requirements</strong> where each record in the output represents either:</p><ul><li><p>A single account + single individual + multiple TINs in separate columns, or</p></li><li><p>A single TIN if the regime is strictly FATCA.</p></li></ul></li><li><p><strong>Handling Data Errors</strong><br/>He still had to <strong>guard</strong> against common data problems, especially <strong>NULL</strong> <code>IndividualIDTypeName</code> values. That’s why the code includes logic like <code>CASE WHEN ... THEN NULL ELSE ... END</code>, preventing duplicates or invalid ISO codes from slipping into the final stage.</p></li><li><p><strong>Final Staging Tables</strong><br/>The procedure ends by creating two staging tables:</p><ul><li><p><strong>FATCA.Stage_CRSPivotedData_jf</strong>: All CRS data, pivoted TIN columns, plus any discovered non-foreign holders.</p></li><li><p><strong>FATCA.Stage_FATCAPivotedData_jf</strong>: The US TIN data, also pivoted.</p></li></ul><p>Jackson’s final LEFT JOIN with <code>FATCA.NonForeignAccHolderData_jf</code> makes sure that if the account has a foreign person somewhere, the <strong>non-foreign</strong> person’s name also appears. If there isn’t a non-foreign holder, it simply displays <strong>'N/A'</strong>.</p></li></ol><hr/><h3 id="FATCA/CRSStoriessofar-WhyThisMatters">Why This Matters</h3><p>By this point, Jackson’s second stored procedure had become <strong>vital</strong> to the overall reporting pipeline. It showed how thoroughly he understood the complexities:</p><ol start="1"><li><p><strong>Avoiding Overlaps</strong>: Splitting CRS and FATCA data up front removes confusion about which TIN belongs to which regime.</p></li><li><p><strong>Pivoting Multiple TINs</strong>: Multi-national clients often have multiple tax IDs, so “row to column” transformations are a must.</p></li><li><p><strong>Including Non-Foreign Holders</strong>: Regulators need to see <strong>all</strong> main holders for an account if <strong>any</strong> foreign controlling person is present, ensuring a complete picture.</p></li><li><p><strong>Preserving Legacy Logic</strong>: Jackson carefully <strong>retained</strong> key steps from “Anease Scripts” so that the end-users and tax specialists who rely on those patterns wouldn’t face unexpected changes or mismatched output.</p></li></ol><hr/><h3 id="FATCA/CRSStoriessofar-Post-Script">Post-Script</h3><p>With <strong>USP02FATCACRSTransformRowtoColumnDataUSP_02_FATCA_CRS_TransformRowtoColumnData</strong> finalizing the TIN pivot, Jackson prepared his <strong>CRS</strong> and <strong>FATCA</strong> data streams for <strong>downstream</strong> processes, like generating XML submissions to tax authorities. Future enhancements might allow for more than five TIN columns, or additional validations if <strong>Anease Scripts</strong> undergo further revisions.</p><p>Still, from Jackson’s perspective, the biggest challenge had been <strong>data quality</strong>: ensuring that incomplete or incorrect fields in CRM wouldn’t disrupt the entire pipeline. Through careful checks, pivot logic, and step-by-step partitioning, he tamed the chaos and delivered <strong>two</strong> well-structured staging tables that <em><strong>just worked</strong></em>—and the compliance teams were <strong>delighted</strong> to see data they could trust.</p>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 18-08-25 20:53</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
