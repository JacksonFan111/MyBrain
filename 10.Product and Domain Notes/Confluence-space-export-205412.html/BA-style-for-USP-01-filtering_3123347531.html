<!DOCTYPE html>
<html>
    <head>
        <title>Jackson Fan : BA style for USP-01 filtering</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Jackson Fan</a></span>
                            </li>
                                                    <li>
                                <span><a href="JF-Space-Overview_2554888272.html">JF Space Overview</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Jackson Fan : BA style for USP-01 filtering
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                            
        
    
        
    
        
        
            Created by <span class='author'> Jackson Fan</span>, last modified on 13-04-25
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>Below is a full Business Analyst–style documentation table that breaks down the entire stored procedure by section. Each row (or group of rows) explains the key actions (i.e., code segments), the underlying business rules that drive the logic, and any additional notes or comments. This documentation is intended as a consolidated reference for the overall design of the FATCA/CRS extraction and preparation process.</p><hr/><div class="table-wrap"><table data-table-width="1800" data-layout="center" data-local-id="5019d399-0eed-4d6a-a7d3-5ce94f54bf12" class="confluenceTable"><colgroup><col style="width: 205.0px;"/><col style="width: 762.0px;"/><col style="width: 582.0px;"/><col style="width: 247.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p><strong>Step / Section</strong></p></th><th class="confluenceTh"><p><strong>Code / Action Description</strong></p></th><th class="confluenceTh"><p><strong>Business Analyst Explanation &amp; Business Rules</strong></p></th><th class="confluenceTh"><p><strong>Notes / Comments</strong></p></th></tr><tr><td class="confluenceTd"><p><strong>Step 0: Setup &amp; Preliminary Steps</strong></p></td><td class="confluenceTd"><ul><li><p>Set transaction isolation level to <code>READ UNCOMMITTED</code>• Declare key variables: <code>@PeriodStartDate</code>, <code>@PeriodEndDate</code>, <code>@RefreshHoldingsData</code>, <code>@rptYear</code>, <code>@USDNZDFxRate</code>, <code>@historyDate</code>• Conditionally call <code>spr_AEOI_Financials</code> if <code>@RefreshHoldingsData = 1</code></p></li></ul></td><td class="confluenceTd"><p><strong>Purpose:</strong> Initialize the environment and input parameters to ensure that the procedure uses the correct reporting dates and refreshed data when needed.<strong>Business Rule:</strong> The reporting year is derived from the end date; refreshing holdings is optional depending on operational needs.</p></td><td class="confluenceTd"><p>This step ensures consistency in the reporting period and minimizes locking issues by using a less restrictive isolation level.</p></td></tr><tr><td class="confluenceTd"><p><strong>Step 1: Create Tax Regime Mapping Table</strong></p></td><td class="confluenceTd"><ul><li><p>Drop the temp table <code>#TaxRegimeMapping</code> if it exists• Build a Common Table Expression (CTE) with multiple <code>SELECT ... UNION ALL</code> statements mapping numeric ReportCode values to human-readable TaxRegime descriptions and simplified regime codes (e.g., &quot;FATCA_CRS&quot;, &quot;CRS&quot;, &quot;FATCA&quot;)• Materialize the CTE into <code>#TaxRegimeMapping</code></p></li></ul></td><td class="confluenceTd"><p><strong>Purpose:</strong> Provide a lookup that translates CRM report codes into the reporting regimes required for FATCA and CRS processing.<strong>Business Rule:</strong> The mapping accounts for known CRM data errors by enforcing the correct regime even when internal flags may be incorrect.</p></td><td class="confluenceTd"><p>This lookup table is later joined to each record to assign the proper reporting classification.</p></td></tr><tr><td class="confluenceTd"><p><strong>Step 2: Build a Recursive Hierarchy of Entities</strong></p></td><td class="confluenceTd"><ul><li><p>Drop any existing <code>#RecursiveHierarchy</code> table• Use a recursive CTE to retrieve &quot;anchor&quot; entities that have explicit FATCA/CRS flags or have associated flagged individuals• Recursively join to child accounts (via roles) up to three levels deep• Materialize the result into <code>#RecursiveHierarchy</code></p></li></ul></td><td class="confluenceTd"><p><strong>Purpose:</strong> Capture complex, layered entity structures (e.g., trusts within trusts, partnerships within companies) to ensure that all controlling relationships are considered.<strong>Business Rule:</strong> Entities are classified as either &quot;Layered&quot; or &quot;Normal&quot; to support different reporting treatments; if an entity lacks explicit flags, flagged individuals can still trigger inclusion.</p></td><td class="confluenceTd"><p>Limits the recursion depth to avoid infinite loops and accounts for known data quality issues in CRM.</p></td></tr><tr><td class="confluenceTd"><p><strong>Step 3: Identify Individuals Tied to Each Entity</strong></p></td><td class="confluenceTd"><ul><li><p>Drop the temp table <code>#HierarchyIndividuals</code> if it exists• Join the recursive hierarchy with the <code>dsl_roles</code> and <code>Contact</code> tables to extract individuals (e.g., Trustees, Directors, Beneficiaries) based on defined role types• Materialize the results into <code>#HierarchyIndividuals</code></p></li></ul></td><td class="confluenceTd"><p><strong>Purpose:</strong> Link each entity (or sub-entity) with its controlling individuals.<strong>Business Rule:</strong> Use specific role filters (Director, Trustee, etc.) because CRM flags may be unreliable. This ensures that even if the entity-level flags are missing, individuals who are clearly in control are included.</p></td><td class="confluenceTd"><p>This creates a bridge between high-level entity data and the individual-level information required for reporting.</p></td></tr><tr><td class="confluenceTd"><p><strong>Step 4: Extract Comprehensive Entity Data (#EntityData)</strong></p></td><td class="confluenceTd"><p><strong>A. Entity Identification &amp; Classification:</strong>• Select entity ID, name, and classification (e.g., from <code>hi.EntityFlag</code> and <code>sm.Value</code> for trading type)</p><p><strong>B. Entity Financial &amp; Administrative Details:</strong>• Retrieve portfolio search IDs, highest service level, total holdings, last update date, closure date, and geographic details (TrustCountry, Domicile, etc.)</p><p><strong>C. Entity Flags for FATCA/CRS Reporting:</strong>• Extract derived flags from the hierarchy indicating US citizenship and foreign tax residency</p><p><strong>D. Role Information:</strong>• Join with roles to retrieve role types, beneficial ownership, and use a CASE logic to determine “SubstantialControllingInterest”</p><p><strong>E. Portfolio Service Details:</strong>• Pull the lowest grain details: portfolio IDs, portfolio number, service level, status, service-level holdings value, inception, close, and notification dates<strong>F. Individual Contact Information:</strong>• Include names and contact fields from the Contact table</p><p><strong>G. Additional Demographic &amp; Tax Info:</strong>• Retrieve citizenship, tax residency, birth country, and other personal flags</p><p><strong>H. Tax Record Details:</strong>• Join tax records (from <code>cip_foreigntaxrecord</code>) for both the entity and individuals<strong>I. Reporting Regime Mapping:</strong>• Join on <code>#TaxRegimeMapping</code> to assign a reporting regime based on the combination of entity and individual flags</p></td><td class="confluenceTd"><p><strong>Purpose:</strong> To consolidate entity-level data with controlling person information and portfolio service attributes into one dataset for reporting.<strong>Business Rules:</strong>– Only include entities with valid holdings data (non-zero, non-null values) except where special conditions apply (e.g., Cash Management rows use overall account value).– Ensure that only entities with valid foreign tax records (from individuals and/or entities) are carried forward.– The classification of the entity, its financial details, and role information all feed into identifying which records are reportable under FATCA/CRS.</p></td><td class="confluenceTd"><p>This step applies many filters to remove junk data (e.g., excluding pending/closed portfolio services with zero/null values) while accepting CRM defaults for active accounts.</p></td></tr><tr><td class="confluenceTd"><p><strong>Step 5: Extract Individual-Level Data with Potential Foreign TINs</strong></p></td><td class="confluenceTd"><p><strong>5.1 TIN Counts:</strong>• Drop and build <code>#TIN_Counts</code> by grouping Account, Portfolio (PortfolioNo and Service Level), and Individual, counting distinct TINs</p><p><strong>5.2 Individual Data Extraction:</strong>• Drop and build <code>#IndividualData</code> by joining Account, Roles, Contact, Portfolio Service, and Tax Record tables• Use a CASE statement to classify individuals as &quot;Foreign Controlling Individual&quot; when they hold specific roles (and are authorized) or else as “Single” or “Multiple TINs Individual” based on the TIN count from <code>#TIN_Counts</code>• Include individual contact, demographic, and tax record details</p></td><td class="confluenceTd"><p><strong>Purpose:</strong> To extract and classify individual-level reporting data that may not be captured at the entity level.<strong>Business Rules:</strong>– Only individuals with valid tax identification (TIN) and associated jurisdiction information are included.– Classification using role and TIN count is critical to differentiate between beneficial owners and other controlling persons.– Ensures that any account with a foreign individual is represented, even if the entity-level record is incomplete.</p></td><td class="confluenceTd"><p>This step complements the entity data by ensuring that all reportable individuals are captured and correctly classified, especially when CRM data for entities is incomplete or inconsistent.</p></td></tr><tr><td class="confluenceTd"><p><strong>Step 6: Combine, Filter, Deduplicate, and Standardize Data</strong></p></td><td class="confluenceTd"><p><strong>6.1 Combine Data:</strong>• Perform a <code>UNION ALL</code> of <code>#EntityData</code> and <code>#IndividualData</code> into a unified CTE (<code>CombinedData</code>)<strong>6.2 PortfolioServiceStatus Scenario-Based Date Filtering:</strong>• Apply filtering to keep records in one of these scenarios:   </p><p>- <strong>Scenario 1:</strong> Active accounts (where <code>PortfolioServiceStatus</code> is not &quot;Closed&quot;)  </p><p> - <strong>Scenario 2:</strong> Accounts marked as &quot;Closed&quot; or &quot;Pending Closure&quot; are retained only if <code>dsl_CloseDate</code> is within the reporting period and the account's inception date is on or before the period end (or, in some cases, a NULL close date may be tolerated)   </p><p>- <strong>Scenario 3:</strong> Explicitly exclude records with a &quot;Closed&quot; status if <code>dsl_CloseDate</code> is NULL (to filter out data quality issues)</p><p><strong>6.3 Additional Exclusions:</strong>• Further filter records to exclude:   - Accounts flagged as Financial Institutions (FI)   - Active NFFE accounts that do not meet reporting obligations (based on domicile and activity status)   - Entities with &quot;Estate Winding-Up&quot; type   - Non-reportable portfolios based on the portfolio service level and corresponding lists for FATCA and CRS</p><p><strong>6.4 Exclude Non-Holding Portfolios (Standard Broking Service):</strong>• Use two subqueries with <code>NOT EXISTS</code> to remove records where there are no qualifying holdings (e.g., no Safe Custody or associated Cash Management records)</p><p><strong>6.5 Deduplication:</strong>• Create a composite key using <code>PortfolioNo</code>, <code>PortfolioServiceLevelName</code>, and <code>cip_Identification</code>• Use <code>ROW_NUMBER()</code> partitioning by this composite key to select only the first occurrence of each record• Materialize the deduplicated result into <code>##crmdatafatcacrsDedup</code></p><p><strong>6.6 Standardize Country ISO Codes and Create Final Staging Table:</strong>• Join the deduplicated data with a CountryReference table to convert country names/3-letter codes to 2-digit ISO codes for fields (e.g., EntityTaxCodeCountryISO, Ind_TaxCodeCountryISO, Residential Country)• Insert the final dataset into the staging table <code>FATCA.Stage_crmdatafatcacrs_jf</code>, adding the ReportYear column</p></td><td class="confluenceTd"><p><strong>Purpose:</strong> To integrate the cleaned entity and individual data into a final dataset that meets regulatory requirements and can be used for downstream reporting.<strong>Business Rules:</strong>– The combined data must only include records with a valid reporting lifecycle: Active accounts, and those Closed or Pending Closure with appropriate date values.– Additional filters remove accounts not meeting specific criteria (e.g., FI, non-reportable portfolios).– Deduplication prevents double-counting by ensuring that each unique combination (portfolio, service level, TIN) appears only once.– Country codes must be standardized as 2-digit ISO codes, using a default value (e.g., 'XX') for missing values.</p></td><td class="confluenceTd"><p>This multi-part step (6.1–6.6) is the culmination of the data cleansing and integration process. It ensures that the final staging table contains only reportable, deduplicated, and standardized records ready for FATCA/CRS submission.</p></td></tr><tr><td class="confluenceTd"><p><strong>Final Output: Staging Table Creation</strong></p></td><td class="confluenceTd"><ul><li><p>Drop any existing staging table <code>FATCA.Stage_crmdatafatcacrs_jf</code>• Create the final staging table by selecting from the standardized data (with country codes) and include the reporting year• This table is then used by subsequent processes for reporting</p></li></ul></td><td class="confluenceTd"><p><strong>Purpose:</strong> To produce a single, consolidated staging table that feeds downstream reporting and compliance processes.<strong>Business Rule:</strong> The final dataset must be compliant with regulatory filing formats and contain clean, deduplicated, and validated data.</p></td><td class="confluenceTd"><p>This is the final product of the procedure. The historical comments in the procedure note iteration changes (e.g., row counts, filter adjustments) to validate the output.</p></td></tr></tbody></table></div><hr/><h3 id="BAstyleforUSP-01filtering-Summary">Summary</h3><p>The full BA table above documents the stored procedure’s flow—from preliminary setup to final staging table creation—by breaking down each major step and sub-step. It details how data is:</p><ul><li><p>Initialized and configured,</p></li><li><p>Mapped for tax regimes,</p></li><li><p>Organized into hierarchical relationships,</p></li><li><p>Merged with individual-level data (with careful classification using roles and TIN counts),</p></li><li><p>Cleansed through filtering (both at the portfolio service level and overall account level),</p></li><li><p>Combined and deduplicated, and finally</p></li><li><p>Standardized (with ISO country codes) for the final staging table used in FATCA/CRS reporting.</p></li></ul><p>This detailed documentation should help stakeholders (Business Analysts, Data Engineers, etc.) understand the logic behind each filtering step, verify compliance with regulatory requirements, and guide future enhancements or troubleshooting of the stored procedure.</p><hr/><p>Below is a summary of the primary date-related data quality issues identified in the stored procedure scripts:</p><ul><li><p><strong>Inconsistent Use of dsl_CloseDate:</strong></p><ul><li><p><strong>Valid Records Missing a Close Date:</strong> Some records may have a NULL close date even though they are active or in “Pending Closure” because CRM defaults to NULL when no closure date has ever been entered. This behavior can lead to valid records being misinterpreted by filtering logic.</p></li><li><p><strong>Filtering Contradictions for Closed Accounts:</strong> The filtering rules exclude records with a “Closed” status that have a NULL close date, assuming that a closed account should always have a close date. However, if the system (or users) defaults to NULL even for legitimate closures, valid records might get excluded erroneously.</p></li></ul></li><li><p><strong>Ambiguity in Date Range Filtering:</strong></p><ul><li><p><strong>Scenario 2 Overlap:</strong> When filtering for “Closed” or “Pending Closure” records, the condition attempts to include rows with either a valid close date falling between the reporting period or a NULL value. This creates ambiguity because:</p><ul><li><p>Allowing NULLs for “Pending Closure” might be acceptable in some cases.</p></li><li><p>For “Closed” accounts, a NULL close date is used to flag data quality issues, yet there is a risk that valid data might be inadvertently filtered out if inconsistent data entry practices exist.</p></li></ul></li></ul></li><li><p><strong>dsl_inceptiondate Reliability:</strong></p><ul><li><p>The inception date is used to ensure that an account was active on or before the end of the reporting period. If the inception date is missing or incorrectly recorded, it may lead to the improper filtering of accounts that should otherwise be included.</p></li></ul></li><li><p><strong>Impact on Downstream Reporting:</strong></p><ul><li><p>These date-related issues contribute to uncertainty in determining which accounts truly fall within the reporting period. Inaccurate or missing date data can lead to both the inclusion of junk records and the exclusion of valid records, which directly affects the compliance and accuracy of the final FATCA/CRS reports.</p></li></ul></li></ul><p>Overall, the combination of inconsistent date entries (primarily with the close date), ambiguous rules for handling NULL dates, and potential issues with inception dates highlights the need for better data quality controls and possibly additional manual review or data cleansing procedures before relying on these fields for regulatory reporting.</p>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 18-08-25 20:53</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
