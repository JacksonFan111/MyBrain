<!DOCTYPE html>
<html>
    <head>
        <title>Jackson Fan : [FATCA].[crmtaxdatafilt] table refactoring</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Jackson Fan</a></span>
                            </li>
                                                    <li>
                                <span><a href="JF-Space-Overview_2554888272.html">JF Space Overview</a></span>
                            </li>
                                                    <li>
                                <span><a href="4.-Service-Portal-Related_2555510852.html">4. Service Portal Related</a></span>
                            </li>
                                                    <li>
                                <span><a href="2762113156.html">18. Rebuild FATCA/CRS step 1 - 10</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Jackson Fan : [FATCA].[crmtaxdatafilt] table refactoring
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                            
        
    
        
    
        
        
            Created by <span class='author'> Jackson Fan</span>, last modified on 26-02-25
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>The table <code>[FATCA].[crmtaxdatafilt]</code> plays a <strong>crucial role</strong> in the entire process of the stored procedure <code>[FATCA].[usp_FATCA_CRS_Exceptions]</code>. </p><p>It serves as a foundational dataset against which other data is compared to identify exceptions in FATCA (Foreign Account Tax Compliance Act) and CRS (Common Reporting Standard) reporting. Here's a detailed explanation of its importance:</p><h3 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-1.DeterminingtheReportingYear">1. <strong>Determining the Reporting Year</strong></h3><p>At the very beginning of the stored procedure, the reporting year (<code>@rptYear</code>) is retrieved from <code>[FATCA].[crmtaxdatafilt]</code>:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">SELECT TOP 1 @rptYear = ReportYear FROM [FATCA].[crmtaxdatafilt];</pre>
</div></div><ul><li><p><strong>Purpose:</strong> The <code>@rptYear</code> variable is essential for setting the context of the data analysis. It ensures that all data processing and exception checks are performed for the correct reporting period.</p></li><li><p><strong>Usage:</strong> The reporting year is used to calculate the period start and end dates, which define the timeframe for data extraction and analysis:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">DECLARE @PeriodStartDate DATE = CONVERT(DATE, CONVERT(VARCHAR(4), @rptYear -1) + &#39;-04-01&#39;);
DECLARE @PeriodEndDate DATE = CONVERT(DATE, CONVERT(VARCHAR(4), @rptYear) + &#39;-03-31&#39;);</pre>
</div></div></li></ul><h3 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-2.FilteringandValidatingData"><span style="background-color: rgb(211,241,167);">2. </span><strong><span style="background-color: rgb(211,241,167);">Filtering and Validating Data</span></strong></h3><p>The stored procedure involves multiple steps where data is filtered, processed, and validated. The <code>[FATCA].[crmtaxdatafilt]</code> table<span style="background-color: rgb(211,241,167);"> is used as a reference point for these operations.</span></p><h4 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-a.IdentifyingMissingRecords(Exception1)">a. <strong>Identifying Missing Records (Exception 1)</strong></h4><ul><li><p><strong>Objective:</strong> Find accounts with foreign tax indications that are not present in the reporting dataset.</p></li><li><p><strong>Implementation:</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">LEFT JOIN [FATCA].[crmtaxdatafilt] b
    ON a.ReportYear = b.ReportYear
    AND a.AccountType COLLATE DATABASE_DEFAULT = b.AccountType COLLATE DATABASE_DEFAULT
    AND a.Regime COLLATE DATABASE_DEFAULT = b.Regime COLLATE DATABASE_DEFAULT
    AND a.AccountID = b.AccountID
    AND a.dsl_IndividualID = b.dsl_IndividualID
    AND a.dsl_PortfolioServiceLevelName COLLATE DATABASE_DEFAULT = b.dsl_PortfolioServiceLevelName COLLATE DATABASE_DEFAULT
WHERE b.AccountID IS NULL</pre>
</div></div></li><li><p><strong>Explanation:</strong> By left joining with <code>[FATCA].[crmtaxdatafilt]</code> and checking for <code>NULL</code> values in <code>b.AccountID</code>, the procedure identifies records that are missing from the main reporting dataset but should be included based on foreign tax indicators.</p></li></ul><h4 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-b.CheckingforDataDiscrepancies(Exception2)">b. <strong>Checking for Data Discrepancies (Exception 2)</strong></h4><ul><li><p><strong>Objective:</strong> Detect records where the country codes differ between datasets.</p></li><li><p><strong>Implementation:</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">LEFT JOIN [FATCA].[crmtaxdatafilt] b
    ON [same join conditions as above]
WHERE b.AccountID IS NOT NULL
  AND ISNULL(b.TaxCodeCountryISO, &#39;&#39;) = &#39;&#39;</pre>
</div></div></li><li><p><strong>Explanation:</strong> The procedure identifies records present in <code>[FATCA].[crmtaxdatafilt]</code> but lacking country codes, indicating potential data discrepancies.</p></li></ul><h3 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-3.ExceptionReportingandAnalysis">3. <strong>Exception Reporting and Analysis</strong></h3><p>Several exception types rely on comparisons with <code>[FATCA].[crmtaxdatafilt]</code>:</p><ul><li><p><strong>Exception 1:</strong> Foreign country detected but not on the report.</p></li><li><p><strong>Exception 2:</strong> Different country codes between datasets.</p></li><li><p><strong>Exception 3 &amp; 4:</strong> Issues with foreign tax records (e.g., missing TIN or country, duplicate IDs).</p></li><li><p><strong>Exception 5 &amp; 6:</strong> Inconsistencies with GIIN numbers (Global Intermediary Identification Numbers).</p></li></ul><p>By using <code>[FATCA].[crmtaxdatafilt]</code> as a baseline, the procedure can:</p><ul><li><p><strong>Identify Missing Data:</strong> Find records that should be reported but are absent.</p></li><li><p><strong>Ensure Data Consistency:</strong> Check for discrepancies in key data points like country codes and tax identification numbers.</p></li><li><p><strong>Validate Reporting Data:</strong> Ensure that the final reporting dataset is accurate and complete.</p></li></ul><h3 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-4.OverallDataIntegrity">4. <strong>Overall Data Integrity</strong></h3><p>The <code>[FATCA].[crmtaxdatafilt]</code> table is likely a curated dataset that represents the expected records for FATCA and CRS reporting. Using it as a reference helps maintain:</p><ul><li><p><strong>Data Accuracy:</strong> By comparing other datasets to <code>[FATCA].[crmtaxdatafilt]</code>, the procedure verifies that all necessary records are included and correctly reported.</p></li><li><p><strong>Compliance Assurance:</strong> Ensures that the organization meets regulatory requirements by reporting all required accounts and correcting any discrepancies.</p></li></ul><h3 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-Conclusion"><strong>Conclusion</strong></h3><p>The <code>[FATCA].[crmtaxdatafilt]</code> table is essential for the following reasons:</p><ul><li><p><strong>Central Reference Point:</strong> It provides a central dataset against which other data is compared to identify anomalies.</p></li><li><p><strong>Reporting Year Determination:</strong> Sets the timeframe for the entire data analysis and reporting process.</p></li><li><p><strong>Exception Identification:</strong> Critical for detecting exceptions that need attention before finalizing reports.</p></li><li><p><strong>Data Validation:</strong> Helps in cross-verifying data to ensure completeness and correctness.</p></li></ul><p>Without <code>[FATCA].[crmtaxdatafilt]</code>, the stored procedure would lack the necessary context and reference needed to accurately identify exceptions and ensure compliance with FATCA and CRS reporting requirements. It is integral to the data integrity and effectiveness of the entire reporting process implemented by the stored procedure.</p><p /><p>Certainly! Refactoring a stored procedure to replace a faulty table with a corrected one involves several systematic steps. Below, I will outline a strategy to help you refactor your stored procedure <code>[FATCA].[usp_FATCA_CRS_Exceptions]</code> by replacing <code>[FATCA].[crmtaxdatafilt]</code> with <code>DataServices.FATCA.Stage_crmdatafatcacrs_jf</code>.</p><h3 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-StrategyforRefactoringtheStoredProcedure"><strong>Strategy for Refactoring the Stored Procedure</strong></h3><ol start="1"><li><p><strong>Understand the Structure and Data of Both Tables</strong></p><ul><li><p><strong>Analyze </strong><code>[FATCA].[crmtaxdatafilt]</code>:</p><ul><li><p>Examine the schema (columns, data types, constraints).</p></li><li><p>Understand how the data is used within the stored procedure.</p></li><li><p>Identify any key columns or relationships.</p></li></ul></li><li><p><strong>Examine </strong><code>DataServices.FATCA.Stage_crmdatafatcacrs_jf</code>:</p><ul><li><p>Review the schema and data.</p></li><li><p>Note any differences in column names, data types, or additional columns.</p></li><li><p>Understand how this table corrects the faults in the original table.</p></li></ul></li></ul></li><li><p><strong>Map Columns Between the Two Tables</strong></p><ul><li><p>Create a mapping document that aligns columns from <code>[FATCA].[crmtaxdatafilt]</code> to <code>DataServices.FATCA.Stage_crmdatafatcacrs_jf</code>.</p></li><li><p>Note any columns that:</p><ul><li><p>Exist in the old table but not in the new one.</p></li><li><p>Exist in the new table but not in the old one.</p></li><li><p>Have different data types or formats.</p></li></ul></li><li><p>Identify any renamed columns.</p></li></ul></li><li><p><strong>Identify Usage of the Faulty Table in the Stored Procedure</strong></p><ul><li><p>Search for all instances where <code>[FATCA].[crmtaxdatafilt]</code> is referenced in the stored procedure.</p></li><li><p>Understand how data from this table is used in queries, joins, conditions, and calculations.</p></li><li><p>Note any dependencies or assumptions based on the old table's data.</p></li></ul></li><li><p><strong>Adjust Queries to Use the New Table</strong></p><ul><li><p><strong>Update Table References:</strong></p><ul><li><p>Replace <code>[FATCA].[crmtaxdatafilt]</code> with <code>DataServices.FATCA.Stage_crmdatafatcacrs_jf</code> in all relevant queries.</p></li></ul></li><li><p><strong>Modify Column References:</strong></p><ul><li><p>Update column names based on your mapping.</p></li><li><p>Ensure that any differences in data types are handled (e.g., casting if necessary).</p></li></ul></li><li><p><strong>Adjust Joins and Conditions:</strong></p><ul><li><p>Re-express any joins that rely on columns that have changed.</p></li><li><p>Update WHERE clauses and other conditions to reflect any changes in the data or structure.</p></li></ul></li></ul></li><li><p><strong>Review and Update Business Logic if Necessary</strong></p><ul><li><p><strong>Validate Assumptions:</strong></p><ul><li><p>Ensure that any business rules or logic in the stored procedure still hold true with the new data.</p></li><li><p>If the new table introduces new logic or corrects faulty logic, adjust the stored procedure accordingly.</p></li></ul></li><li><p><strong>Handle Additional Data:</strong></p><ul><li><p>If the new table includes additional data that could enhance the stored procedure, consider integrating it.</p></li><li><p>Conversely, if some data is no longer available, find alternative ways to achieve the same functionality.</p></li></ul></li></ul></li><li><p><strong>Test the Refactored Stored Procedure</strong></p><ul><li><p><strong>Unit Testing:</strong></p><ul><li><p>Run the stored procedure with test parameters.</p></li><li><p>Check for syntax errors, missing columns, or other issues.</p></li></ul></li><li><p><strong>Compare Results:</strong></p><ul><li><p>Compare the output of the refactored stored procedure with expected results.</p></li><li><p>Identify any discrepancies and trace them back to the changes made.</p></li></ul></li><li><p><strong>Edge Cases:</strong></p><ul><li><p>Test with edge case data to ensure the procedure handles all scenarios.</p></li></ul></li></ul></li><li><p><strong>Validate Against Known Correct Data</strong></p><ul><li><p><strong>Cross-Verification:</strong></p><ul><li><p>Use known correct datasets to validate the output.</p></li><li><p>Ensure that exceptions and reports generated match expectations.</p></li></ul></li><li><p><strong>User Acceptance Testing:</strong></p><ul><li><p>Engage with stakeholders or users to validate that the refactored procedure meets business requirements.</p></li></ul></li></ul></li><li><p><strong>Document Changes and Update Metadata</strong></p><ul><li><p><strong>Comments:</strong></p><ul><li><p>Update comments within the stored procedure to reflect the changes.</p></li><li><p>Document any important notes about the new table's usage.</p></li></ul></li><li><p><strong>Version Control:</strong></p><ul><li><p>Use version control systems to track changes.</p></li><li><p>Provide clear commit messages explaining the refactoring.</p></li></ul></li></ul></li><li><p><strong>Deploy and Monitor</strong></p><ul><li><p><strong>Deployment:</strong></p><ul><li><p>Deploy the refactored stored procedure to a testing environment first.</p></li><li><p>Once validated, promote it to production following your organization's deployment procedures.</p></li></ul></li><li><p><strong>Monitoring:</strong></p><ul><li><p>Monitor the stored procedure's execution in production for any unexpected issues.</p></li><li><p>Be prepared to roll back if critical issues are discovered.</p></li></ul></li></ul></li></ol><h3 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-DetailedStepsforYourSpecificScenario"><strong>Detailed Steps for Your Specific Scenario</strong></h3><p>Given that <code>[FATCA].[crmtaxdatafilt]</code> is incorrectly populated and the new table <code>DataServices.FATCA.Stage_crmdatafatcacrs_jf</code> has the correct logic, here's how you might proceed:</p><h4 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-1.AnalyzetheStoredProcedure&#39;sDependenceon[FATCA].[crmtaxdatafilt]"><strong>1. Analyze the Stored Procedure's Dependence on </strong><code>[FATCA].[crmtaxdatafilt]</code></h4><ul><li><p><strong>Determine How </strong><code>@rptYear</code> is Set:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">SELECT TOP 1 @rptYear = ReportYear FROM [FATCA].[crmtaxdatafilt];</pre>
</div></div><ul><li><p><strong>Action:</strong> Ensure that <code>DataServices.FATCA.Stage_crmdatafatcacrs_jf</code> contains the <code>ReportYear</code> column or equivalent.</p></li></ul></li><li><p><strong>Identify All References to </strong><code>[FATCA].[crmtaxdatafilt]</code>:</p><ul><li><p>For instance, in the exception checks:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">LEFT JOIN [FATCA].[crmtaxdatafilt] b ON ...</pre>
</div></div></li><li><p><strong>Action:</strong> Update these joins to reference the new table, adjusting join conditions as necessary.</p></li></ul></li></ul><h4 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-2.MapandUpdateColumnReferences"><strong>2. Map and Update Column References</strong></h4><ul><li><p><strong>Action:</strong> Use this mapping to update column references in the stored procedure.</p></li></ul><h4 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-3.AdjustJoinsandConditions"><strong>3. Adjust Joins and Conditions</strong></h4><ul><li><p><strong>Update Joins:</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">LEFT JOIN DataServices.FATCA.Stage_crmdatafatcacrs_jf b ON ...</pre>
</div></div></li><li><p><strong>Handle Any Differences in Data Types:</strong></p><ul><li><p>For example, if <code>AccountType</code> was <code>VARCHAR(50)</code> in the old table and is now <code>NVARCHAR(100)</code>:</p><ul><li><p><strong>Action:</strong> Ensure that data types are compatible or perform necessary conversions.</p></li></ul></li></ul></li></ul><h4 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-4.UpdateExceptionLogicifNeeded"><strong>4. Update Exception Logic if Needed</strong></h4><ul><li><p><strong>Review Exception Criteria:</strong></p><ul><li><p>The exception checks may rely on specific data patterns or values.</p></li><li><p><strong>Action:</strong> Ensure that the logic aligns with the corrected data in the new table.</p></li></ul></li></ul><h4 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-5.TestThoroughly"><strong>5. Test Thoroughly</strong></h4><ul><li><p><strong>Use Test Cases That Previously Failed:</strong></p><ul><li><p>If certain users were receiving faulty results, use their data to test the refactored procedure.</p></li></ul></li><li><p><strong>Verify All Exception Types:</strong></p><ul><li><p>Confirm that each exception (1 through 6) is correctly identified with the new data.</p></li></ul></li></ul><h4 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-6.EngagewiththeDeveloper"><strong>6. Engage with the Developer</strong></h4><ul><li><p><strong>Collaborate with the Developer Who Built the New Table:</strong></p><ul><li><p><strong>Gain Insights:</strong> Understand any nuances or important details about the new table.</p></li><li><p><strong>Clarify Changes:</strong> Ensure that any changes in logic are reflected in the stored procedure.</p></li></ul></li></ul><h4 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-7.DocumentandCommunicateChanges"><strong>7. Document and Communicate Changes</strong></h4><ul><li><p><strong>Update Procedure Header Comments:</strong></p><ul><li><p>Include notes about the change from <code>[FATCA].[crmtaxdatafilt]</code> to <code>DataServices.FATCA.Stage_crmdatafatcacrs_jf</code>.</p></li><li><p>Document any significant logic changes.</p></li></ul></li><li><p><strong>Inform Stakeholders:</strong></p><ul><li><p>Notify any teams or individuals who rely on this procedure about the changes.</p></li></ul></li></ul><h3 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-BestPracticesforRefactoring"><strong>Best Practices for Refactoring</strong></h3><ul><li><p><strong>Backup Before Changes:</strong></p><ul><li><p>Always keep a backup of the original stored procedure in case you need to revert.</p></li></ul></li><li><p><strong>Incremental Changes:</strong></p><ul><li><p>Make changes in small increments and test each step.</p></li></ul></li><li><p><strong>Use Transaction Handling:</strong></p><ul><li><p>If applicable, wrap changes in transactions to maintain data integrity during testing.</p></li></ul></li><li><p><strong>Consider Performance Implications:</strong></p><ul><li><p>The new table may have different indexing or performance characteristics.</p></li><li><p><strong>Action:</strong> Analyze query execution plans to optimize performance.</p></li></ul></li><li><p><strong>Ensure Compliance:</strong></p><ul><li><p>Since FATCA and CRS involve regulatory compliance, double-check that the refactored procedure still meets all compliance requirements.</p></li></ul></li></ul><h3 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-ExampleUpdateintheStoredProcedure"><strong>Example Update in the Stored Procedure</strong></h3><p>Here's how you might update the initial selection of <code>@rptYear</code>:</p><p><strong>Original:</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">SELECT TOP 1 @rptYear = ReportYear FROM [FATCA].[crmtaxdatafilt];</pre>
</div></div><p><strong>Refactored:</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">SELECT TOP 1 @rptYear = ReportYear FROM DataServices.FATCA.Stage_crmdatafatcacrs_jf;</pre>
</div></div><p>Similarly, update any other references accordingly.</p><h3 id="id-[FATCA].[crmtaxdatafilt]tablerefactoring-Conclusion.1"><strong>Conclusion</strong></h3><p>Refactoring a stored procedure to replace a faulty table involves careful analysis and methodical updates. By following the strategy outlined above, you can systematically update <code>[FATCA].[usp_FATCA_CRS_Exceptions]</code> to use <code>DataServices.FATCA.Stage_crmdatafatcacrs_jf</code>, ensuring that the procedure produces accurate and reliable results for FATCA/CRS reporting.</p><p>If you encounter specific challenges or have questions about particular parts of the stored procedure during the refactoring process, feel free to ask for further assistance.</p>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 18-08-25 20:53</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
