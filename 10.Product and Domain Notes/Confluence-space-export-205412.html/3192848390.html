<!DOCTYPE html>
<html>
    <head>
        <title>Jackson Fan : FATCA/CRS USP_01 with Google</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Jackson Fan</a></span>
                            </li>
                                                    <li>
                                <span><a href="JF-Space-Overview_2554888272.html">JF Space Overview</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Jackson Fan : FATCA/CRS USP_01 with Google
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                            
        
    
        
    
        
        
            Created by <span class='author'> Jackson Fan</span>, last modified on 03-06-25
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>Okay, this is a fantastic challenge! Let's put on our &quot;30 years of experience&quot; hat and scrutinize this code line by line, thinking about the FATCA IDES 2.0 XML schema, potential pitfalls from human error in CRM, and then simplify it for a high school learner.</p><p>This will be a multi-part review because of the code's length and complexity. I'll break it down by the major steps in your stored procedure.</p><p><strong>Guiding Principles for the Audit:</strong></p><ol start="1"><li><p><strong>FATCA IDES 2.0 Mapping:</strong> Does the data selected and transformed directly support a required or optional element/attribute in the schema? Is the data type and format compatible?</p></li><li><p><strong>Human Error Mitigation:</strong> How does this line or block attempt to correct or work around expected CRM data entry mistakes (incorrect flags, missing links, inconsistent formats)? Is it robust enough?</p></li><li><p><strong>Complexity vs. Necessity:</strong> Is the complexity justified? Can it be simplified without losing critical functionality or accuracy?</p></li><li><p><strong>Assumptions:</strong> What assumptions is this code making about the CRM data? Are these assumptions safe?</p></li><li><p><strong>SQL Server 2008 Constraints:</strong> Are there more efficient or clearer ways to do this even within SQL 2008 limitations?</p></li></ol><hr/><p><strong>Part 1: Initial Setup and Step 1 (Tax Regime Mapping)</strong></p><hr/><p><strong>Overall Procedure Header and Parameters</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">-- =============================================
-- Author:          Jackson Fan
-- Updated :    09.04.2025 (...)
-- Description:     
--     This stored procedure initiates the first steps in the FATCA/CRS reporting process, specifically tailored for FATCA IDES 2.0 XML submission.
--     ...
-- Output:
--     FATCA.Stage_crmdatafatcacrs_jf (A staging table ready for further processing into FATCA XML format)
-- ...
-- =============================================
CREATE PROCEDURE [FATCA].[USP_01_FATCA_CRS_ExtractAndPrepareData]
(
   @PeriodStartDate					DATETIME	 
 , @PeriodEndDate					DATETIME	
 , @RefreshHoldingsData				BIT = 0
)
AS
BEGIN
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED; </pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><strong>Procedure Naming:</strong> Good, descriptive. <code>USP_01_</code> implies a sequence.</p></li><li><p><strong>Parameters:</strong> <code>@PeriodStartDate</code>, <code>@PeriodEndDate</code> are essential for defining the <code>&lt;ReportingPeriod&gt;</code> in the XML. <code>@RefreshHoldingsData</code> is a good operational control.</p></li><li><p><code>TRANSACTION ISOLATION LEVEL READ UNCOMMITTED</code>: Standard for reporting to avoid blocking and being blocked. Acceptable risk for reporting if minor data changes during run are tolerable. For financial reporting, this is a common trade-off.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p><code>@PeriodEndDate</code> directly feeds into <code>YEAR(@PeriodEndDate)</code> which becomes <code>&lt;MessageSpec&gt;&lt;ReportingPeriod&gt;</code>.</p></li></ul></li><li><p><strong>Human Error:</strong></p><ul><li><p>The parameters themselves are inputs; validation (e.g., StartDate before EndDate) would typically be in the calling process or a very early check here if critical. Assumed correct for now.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Think of this whole thing as a recipe to get information ready for a big tax report the government needs.</p></li><li><p><code>@PeriodStartDate</code> and <code>@PeriodEndDate</code> are like telling the recipe, 'We only want information from this date to that date.'</p></li><li><p><code>@RefreshHoldingsData</code> is like asking, 'Should we get the very latest bank balances before we start, or is yesterday's info okay?'</p></li><li><p><code>READ UNCOMMITTED</code> is like peeking at the information while others might still be updating it. It's faster, but you might see something change by a tiny bit if you look again a second later.&quot;</p></li></ul></li></ul><hr/><p><strong>STEP 0: Setup and Preliminary Steps</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">DECLARE	@rptYear			INT				SET			@rptYear		=		YEAR(@PeriodEndDate) 

    IF @RefreshHoldingsData = 1
        EXEC [dbo].[spr_AEOI_Financials] @rptYear;</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><code>@rptYear</code>: Cleanly derived. Essential for financial data context and the XML's <code>&lt;ReportingPeriod&gt;</code>.</p></li><li><p><code>EXEC [dbo].[spr_AEOI_Financials] @rptYear;</code>: This is a dependency. The success and correctness of this entire procedure hinge on <code>spr_AEOI_Financials</code> working correctly and populating necessary financial data (like <code>&lt;AccountBalance&gt;</code>). This external call is a potential point of failure or inconsistent data if not managed well. Error handling around this <code>EXEC</code> might be considered if it's prone to issues (e.g., <code>TRY...CATCH</code> in newer SQL, or checking <code>@@ERROR</code> in SQL 2008).</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p><code>@rptYear</code> directly defines the year for <code>&lt;MessageSpec&gt;&lt;ReportingPeriod&gt;</code>. The data refreshed by <code>spr_AEOI_Financials</code> is crucial for <code>&lt;AccountReport&gt;&lt;AccountBalance&gt;</code>.</p></li></ul></li><li><p><strong>Human Error:</strong></p><ul><li><p>If <code>spr_AEOI_Financials</code> relies on CRM flags that are wrong, it could refresh incorrect financial data. This SP attempts to correct flags <em>later</em>, so there's a potential order-of-operations dependency if <code>spr_AEOI_Financials</code> <em>also</em> tries to interpret these flags.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;<code>@rptYear</code> is just grabbing the year from the end date, like '2025'.</p></li><li><p>The <code>IF</code> statement says: 'If we decided to get fresh bank balances, then run another recipe called <code>spr_AEOI_Financials</code> to do that job for the year we care about.'&quot;</p></li></ul></li></ul><hr/><p><strong>STEP 1: Create Tax Regime Mapping Table</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">IF OBJECT_ID(&#39;tempdb..#TaxRegimeMapping&#39;) IS NOT NULL DROP TABLE #TaxRegimeMapping;
WITH TaxRegimeMapping AS (
    -- Each ReportCode is a bitmask combination of EntityCRS, EntityFATCA, IndivCRS, IndivFATCA flags.
    -- ...
    SELECT 15 AS ReportCode, &#39;CRS &amp; FATCA (Entity &amp; Individual)&#39; AS TaxRegime,&#39;FATCA_CRS&#39; AS Regime UNION ALL 
    -- ... (other 15 cases)
    SELECT 0,  &#39;Other&#39;, &#39;Other&#39; 
)SELECT ReportCode, TaxRegime, Regime INTO #TaxRegimeMapping FROM TaxRegimeMapping;</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><strong>Purpose:</strong> Excellent idea. Abstracting the complex bitmask logic derived from (likely unreliable) CRM flags into a clean mapping table is good practice. This table becomes the &quot;source of truth&quot; for regime determination within this SP.</p></li><li><p><strong>Bitmask Logic:</strong> The &quot;ReportCode&quot; is essentially a 4-bit value representing <code>EntityCRS (8) | EntityFATCA (4) | IndivCRS (2) | IndivFATCA (1)</code>. This is clever.</p></li><li><p><strong>Error Handling in Mapping:</strong> Cases like <code>ReportCode 11 ('CRS (Entity) &amp; FATCA (Individual)')</code> being mapped to <code>'FATCA_CRS'</code> with the comment &quot;CRM Data Error likely&quot; is exactly the kind of defensive programming needed. It acknowledges that some combinations from CRM don't make logical sense but still need to be channeled into a reportable category.</p></li><li><p><strong>Assumptions:</strong></p><ul><li><p>Assumes the 4 input flags from CRM (Entity CRS/FATCA, Individual CRS/FATCA) are the <em>only</em> drivers for this initial regime classification.</p></li><li><p>Assumes the interpretations of &quot;CRM Data Error&quot; are correct and cover the most likely scenarios. This mapping is critical and should be reviewed with business analysts who understand FATCA/CRS rules and common CRM data issues.</p></li></ul></li><li><p><strong>SQL 2008:</strong> <code>WITH CTE AS (...) SELECT ... INTO #Table FROM CTE</code> is perfectly fine.</p></li><li><p><strong>Maintainability:</strong> If the CRM flags change or new interpretations arise, this <code>UNION ALL</code> section is the single place to update.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>The <code>Regime</code> column (<code>'FATCA'</code>, <code>'FATCA_CRS'</code>) will be crucial for filtering records that need to go into a FATCA XML file.</p></li><li><p>The <code>&lt;DocSpec&gt;</code> element in the FATCA XML (part of <code>&lt;AccountReport&gt;</code>) indicates the type of report. While this mapping doesn't directly create the <code>DocTypeIndic</code> (e.g., <code>FATCA1</code> for US Reportable Account), it's a precursor to deciding if an account needs such a report.</p></li></ul></li><li><p><strong>Human Error:</strong></p><ul><li><p>This entire step <em>is</em> about handling human error in CRM flagging. For instance, a user might flag an individual as a US person but forget to flag the associated entity account. This mapping (e.g., <code>ReportCode 3</code>) tries to correct this by pushing it towards <code>FATCA_CRS</code>.</p></li><li><p><strong>Risk:</strong> If a truly &quot;Other&quot; (non-reportable) case gets miscoded in CRM to look like a reportable combination, it could be incorrectly pulled in. The &quot;Other&quot; mapping for <code>ReportCode 0</code> is the catch-all for &quot;definitely not flagged&quot;.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Imagine the computer looks at four checkboxes in the customer's file:</p><ol start="1"><li><p>Is the company a foreign taxpayer for Country X?</p></li><li><p>Is the company a US taxpayer?</p></li><li><p>Is the person a foreign taxpayer for Country X?</p></li><li><p>Is the person a US taxpayer?</p></li></ol></li><li><p>Sometimes people tick these boxes wrong in the customer file.</p></li><li><p>This step creates a secret decoder ring (<code>#TaxRegimeMapping</code>).</p></li><li><p>For every possible way the boxes <em>could</em> be ticked (even the wrong ways!), the decoder ring tells us: 'Okay, based on these ticks, we should treat this customer as needing a US Tax Report, or a Country X Tax Report, or both, or neither.'</p></li><li><p>For example, if only 'Is the person a US taxpayer?' is ticked, the decoder says, 'That's probably a mistake, the company should also be involved. Let's treat it as needing a US Tax report for both.'</p></li><li><p>The <code>ReportCode</code> is like a secret number for each combination of ticks. <code>15</code> means all boxes ticked. <code>0</code> means no boxes ticked.&quot;</p></li></ul></li></ul><hr/><p>This covers the initial setup and Step 1. I'll continue with Step 2 in the next part. This detailed approach is making the complexity very clear!</p><hr/><p><strong>Part 2: Step 2 (Recursive Hierarchy of Entities)</strong></p><hr/><p><strong>Step 2: Build a Recursive Hierarchy of Entities - Overview</strong></p><ul><li><p><strong>Problem Statement Recap:</strong> Entities can own other entities. FATCA requires understanding these chains, especially for &quot;Passive NFFEs&quot; where you need to identify US &quot;Controlling Persons&quot; of that Passive NFFE, who might themselves be individuals or other entities further down the chain. CRM often doesn't provide a clean, deep view of these relationships.</p></li></ul><p><strong>Step 2.1: </strong><code>#EntitiesWithFlaggedIndividuals</code></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">IF OBJECT_ID(&#39;tempdb..#EntitiesWithFlaggedIndividuals&#39;) IS NOT NULL DROP TABLE #EntitiesWithFlaggedIndividuals;
SELECT DISTINCT r.dsl_TradingEntityID AS EntityId
INTO #EntitiesWithFlaggedIndividuals
FROM [DynamicsPROD].[CRM_MSCRM].dbo.dsl_roles r
INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.Contact i ON r.dsl_IndividualId = i.ContactId
WHERE r.statuscode = 1 -- Active roles
  AND (i.dsl_USCitizensforTaxPurposes = 1 OR i.ots_foreigntaxresident = 1); -- Individual is US person or foreign tax resident.</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><strong>Purpose:</strong> This is a critical workaround for unreliable entity-level FATCA flags in CRM. The logic is: if an <em>individual</em> connected to an entity has US/foreign indicia, then the entity itself is <em>potentially</em> in scope for FATCA, even if the entity's direct flag is 'No' or missing.</p></li><li><p><code>dsl_TradingEntityID</code>: Assumed to be the <code>AccountId</code> of the entity the role pertains to.</p></li><li><p><code>statuscode = 1</code>: Good filter for active roles.</p></li><li><p><code>i.dsl_USCitizensforTaxPurposes = 1 OR i.ots_foreigntaxresident = 1</code>: This correctly identifies individuals with foreign tax residency or US citizenship.</p></li><li><p><code>DISTINCT</code>: Important, as multiple foreign individuals could be linked to the same entity.</p></li><li><p><strong>Assumption:</strong> A role linking a foreign individual to an entity implies the entity might be reportable. This is a broad but generally safe assumption for initial scoping when source flags are poor.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>This step doesn't directly map to an XML element but is crucial for identifying <em>which entities</em> need to be considered for <code>&lt;AccountHolder&gt;&lt;Organisation&gt;</code> and subsequently for their <code>&lt;ControllingPerson&gt;</code> elements.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>Directly addresses the human error of PWA/users <em>not</em> flagging an entity as FATCA-relevant when it has US controlling persons or owners.</p></li><li><p><strong>Risk:</strong> Could pull in entities that are legitimately <em>not</em> FATCA reportable but happen to have a foreign-flagged individual in a non-controlling, non-ownership role (e.g., a foreign contact person with no financial interest). Later filtering (Step 3, 4 by role type and beneficial ownership %) is needed to refine this.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Imagine a company (Entity). Sometimes, the main file for the company doesn't say it's important for US taxes, even if it should.</p></li><li><p>This step is like a detective looking at all the <em>people</em> connected to any company.</p></li><li><p>If the detective finds a person who <em>is</em> important for US taxes (e.g., a US citizen) and that person is linked to a company, the detective makes a note: 'Hey, this company (<code>EntityId</code>) might be important too, even if its own file doesn't say so! Let's keep an eye on it.'</p></li><li><p><code>#EntitiesWithFlaggedIndividuals</code> is the detective's list of these suspicious companies.&quot;</p></li></ul></li></ul><hr/><p><strong>Step 2.2: </strong><code>RecursiveHierarchy</code> CTE</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">IF OBJECT_ID(&#39;tempdb..#RecursiveHierarchy&#39;) IS NOT NULL DROP TABLE #RecursiveHierarchy;
;WITH RecursiveHierarchy AS (
    -- Anchor Member:
    SELECT
        a.AccountId AS EntityId,
        a.Name AS EntityName,
        0 AS Level,
        CAST(a.Name AS NVARCHAR(MAX)) AS Path,
        a.AccountId AS RootEntityId,
        CASE WHEN a.dsl_USCitizensforTaxPurposes = 1 THEN 1 ELSE 0 END AS Entity_FATCA_Flag,
        CASE WHEN a.ots_foreigntaxresident = 1 THEN 1 ELSE 0 END AS Entity_CRS_Flag,
        CASE 
            WHEN EXISTS (
                SELECT 1 FROM [DynamicsPROD].[CRM_MSCRM].dbo.dsl_roles r_inner
                WHERE r_inner.dsl_TradingEntityID = a.AccountId AND r_inner.statuscode = 1 AND r_inner.dsl_OrganisationName IS NOT NULL
            ) THEN &#39;Layered Entity&#39;
            ELSE &#39;Normal Entity&#39;
        END AS EntityFlag
    FROM [DynamicsPROD].[CRM_MSCRM].dbo.Account AS a
    LEFT JOIN [DynamicsPROD].[CRM_MSCRM].dbo.StringMap AS sm 
        ON sm.AttributeValue = a.dsl_TradingEntityType AND sm.AttributeName = &#39;dsl_tradingentitytype&#39; AND sm.ObjectTypeCode = 1
    WHERE
        sm.Value IN (&#39;Trust&#39;, &#39;Company&#39;, &#39;Incorporated Entity&#39;, &#39;Partnership&#39;)
        AND (
            a.dsl_USCitizensforTaxPurposes = 1
            OR a.ots_foreigntaxresident = 1 
            OR a.AccountId IN (SELECT EntityId FROM #EntitiesWithFlaggedIndividuals) -- Crucial join
        )
        AND NOT (sm.Value = &#39;Trust&#39; AND a.cip_CharityNumber IS NOT NULL)

    UNION ALL

    -- Recursive Member:
    SELECT
        c.AccountId AS EntityId,
        c.Name AS EntityName,
        rh.Level + 1 AS Level,
        CAST(rh.Path + N&#39; -&gt; &#39; + c.Name AS NVARCHAR(MAX)) AS Path,
        rh.RootEntityId, -- Inherits from anchor or previous level
        rh.Entity_FATCA_Flag, -- Inherits FATCA flag from the ROOT
        rh.Entity_CRS_Flag,   -- Inherits CRS flag from the ROOT
        CASE 
            WHEN EXISTS (
                SELECT 1 FROM [DynamicsPROD].[CRM_MSCRM].dbo.dsl_roles r_inner
                WHERE r_inner.dsl_TradingEntityID = c.AccountId AND r_inner.statuscode = 1 AND r_inner.dsl_OrganisationName IS NOT NULL
            ) THEN &#39;Layered Entity&#39;
            ELSE &#39;Normal Entity&#39;
        END AS EntityFlag
    FROM RecursiveHierarchy rh
    INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.dsl_roles AS r 
        ON rh.EntityId = r.dsl_TradingEntityID AND r.statuscode = 1 AND r.dsl_OrganisationName IS NOT NULL AND r.dsl_Organisation IS NOT NULL
    INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.Account AS c 
        ON r.dsl_Organisation = c.AccountId
    WHERE rh.Level &lt; 3 
)
SELECT EntityId, EntityName, Level, Path, RootEntityId, Entity_FATCA_Flag, Entity_CRS_Flag, EntityFlag
INTO #RecursiveHierarchy
FROM RecursiveHierarchy;</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><strong>Anchor Member:</strong></p><ul><li><p><code>a.AccountId AS RootEntityId</code>: Correctly establishes the top-level entity for this particular chain.</p></li><li><p><code>Entity_FATCA_Flag</code>, <code>Entity_CRS_Flag</code>: These are taken <em>directly from the anchor entity</em>. This is important. The FATCA/CRS status of the entire hierarchy (for reporting purposes of that root) will be determined by this root entity's flags (as corrected by <code>#EntitiesWithFlaggedIndividuals</code>).</p></li><li><p><code>EntityFlag</code> (<code>Layered Entity</code>/<code>Normal Entity</code>): Useful for understanding structure; <code>dsl_OrganisationName IS NOT NULL</code> is the indicator that the role links to another <em>organisation</em> rather than an individual.</p></li><li><p><code>sm.Value IN ('Trust', ...)</code>: Correctly filters for entity types that can be part of ownership chains.</p></li><li><p><code>OR a.AccountId IN (SELECT EntityId FROM #EntitiesWithFlaggedIndividuals)</code>: This is where the previous workaround pays off, bringing potentially misflagged entities into the starting set for recursion.</p></li><li><p><code>NOT (sm.Value = 'Trust' AND a.cip_CharityNumber IS NOT NULL)</code>: Valid exclusion for charities.</p></li></ul></li><li><p><strong>Recursive Member:</strong></p><ul><li><p><code>rh.RootEntityId</code>: Crucially propagates the <em>original</em> anchor's ID down the chain. All sub-entities and their controlling persons will eventually roll up to this <code>RootEntityId</code>.</p></li><li><p><code>rh.Entity_FATCA_Flag</code>, <code>rh.Entity_CRS_Flag</code>: <strong>This is a key design choice.</strong> The FATCA/CRS status for reporting any part of this chain is determined by the <em>root</em> of that specific chain. This means if a US-flagged trust (Root) owns a non-US-flagged company, that company is still considered within a US-FATCA context <em>because its ultimate parent is US-flagged</em>. This is generally correct for determining if Controlling Persons of the sub-entity need to be reported for the root account.</p></li><li><p><code>JOIN ... ON rh.EntityId = r.dsl_TradingEntityID ... AND r.dsl_Organisation = c.AccountId</code>: This correctly links a parent entity (<code>rh.EntityId</code>) to a role (<code>r</code>) that points to a child organisation (<code>r.dsl_Organisation</code>, which is <code>c.AccountId</code>).</p></li><li><p><code>r.dsl_OrganisationName IS NOT NULL AND r.dsl_Organisation IS NOT NULL</code>: Good checks. <code>dsl_OrganisationName</code> might exist but <code>dsl_Organisation</code> (the GUID link) could be missing due to CRM data issues. Both are needed.</p></li><li><p><code>rh.Level &lt; 3</code>: Practical limit to prevent infinite loops from bad CRM data (e.g., A owns B, B owns A). &quot;JF only discover one 3-layered-entity&quot; justifies this for now. If deeper legitimate structures exist, this is a data truncation.</p></li></ul></li><li><p><strong>Overall Logic:</strong> This CTE structure correctly identifies chains and, importantly, attributes the FATCA/CRS context of the <em>entire chain</em> to its root.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p><code>RootEntityId</code> will eventually map to an <code>&lt;AccountHolder&gt;&lt;Organisation&gt;</code>.</p></li><li><p>Subsequent entities in the chain (<code>EntityId</code> where <code>Level &gt; 0</code>) are important if the <code>RootEntityId</code> is a Passive NFFE, as these sub-entities might contain the <code>&lt;ControllingPerson&gt;</code>s.</p></li><li><p>The <code>Entity_FATCA_Flag</code> (from the root) determines if this entire structure is considered for FATCA reporting.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>The anchor uses <code>#EntitiesWithFlaggedIndividuals</code> to catch poorly flagged root entities.</p></li><li><p>The recursion limit (<code>Level &lt; 3</code>) prevents system runaway from circular references in CRM, which are a common data quality issue.</p></li><li><p>By taking <code>Entity_FATCA_Flag</code> from the <code>RootEntityId</code> and propagating it, it ensures that even if a sub-entity is <em>not</em> directly flagged in CRM as FATCA-relevant, it's still processed within the FATCA context of its parent.</p></li><li><p><strong>Risk:</strong> If <code>dsl_OrganisationName</code> is populated but <code>dsl_Organisation</code> (the GUID) is NULL, that link in the chain is broken. The <code>AND r.dsl_Organisation IS NOT NULL</code> handles this by not following that broken link.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Okay, we have our list of 'suspicious' companies (and ones that were obviously important from their own files). Now we want to see if these companies own <em>other</em> companies, and if <em>those</em> companies own even <em>more</em> companies – like Russian nesting dolls.</p></li><li><p><strong>Anchor (Starting Point):</strong></p><ul><li><p>We take each company from our starting list. This is <code>Level 0</code>, the biggest doll. We call it the <code>RootEntityId</code>.</p></li><li><p>We check its own US tax flag. This flag is super important for this whole doll set.</p></li><li><p>We see if <em>this</em> doll has smaller dolls inside it (<code>Layered Entity</code> or <code>Normal Entity</code>).</p></li></ul></li><li><p><strong>Recursive (Finding Smaller Dolls):</strong></p><ul><li><p>If a doll has a smaller doll inside, we open it. That smaller doll is now <code>Level 1</code>.</p></li><li><p>The <code>RootEntityId</code> (the biggest doll's ID) stays the same for all dolls in this set.</p></li><li><p>The US tax flag from the biggest doll also applies to all smaller dolls in its set.</p></li><li><p>We check if this <code>Level 1</code> doll <em>also</em> has even smaller dolls inside.</p></li><li><p>We only go down 2 levels of smaller dolls (Level 0 -&gt; Level 1 -&gt; Level 2). This is like saying we only care about dolls nested 3 deep at most, to stop if the dolls are messed up and go in circles.</p></li></ul></li><li><p><code>#RecursiveHierarchy</code> becomes a list of all dolls, saying which big doll set they belong to, how deep they are nested, and what the US tax flag of their biggest doll was.&quot;</p></li></ul></li></ul><hr/><p>This step is complex but fundamental for FATCA's look-through requirements for Passive NFFEs. The inheritance of <code>RootEntityId</code> and its <code>Entity_FATCA_Flag</code> is the most critical concept here for correct downstream processing.</p><p>Next, Step 3: Linking individuals to these hierarchical entities.</p><hr/><p><strong>Part 3: Step 3 (Identify Individuals Tied to Entities)</strong></p><hr/><p><strong>STEP 3: Identify Individuals Tied to Each Entity in the Hierarchy</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">IF OBJECT_ID(&#39;tempdb..#HierarchyIndividuals&#39;) IS NOT NULL DROP TABLE #HierarchyIndividuals;
;WITH HierarchyIndividuals AS (
    SELECT DISTINCT
        rh.RootEntityId, 
        rh.EntityId, 
        rh.Level,    
        i.ContactId AS IndividualId, 
        i.FullName AS IndividualName, 
        rh.Path, 
        rh.Entity_FATCA_Flag, 
        rh.Entity_CRS_Flag,   
        rh.EntityFlag         
    FROM
        #RecursiveHierarchy rh
    INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.dsl_roles AS r
        ON rh.EntityId = r.dsl_TradingEntityID 
        AND r.statuscode = 1 
        AND r.dsl_IndividualId IS NOT NULL 
        AND r.dsl_RoleTypeIdName IN (
            &#39;Director&#39;, &#39;Trustee&#39;, &#39;Authorised Person&#39;, &#39;Corporate Trustee Agent&#39;, 
            &#39;Shareholder&#39;, &#39;Settlor (Trust)&#39;, &#39;Officer&#39;, &#39;Other&#39;, 
            &#39;Beneficiary&#39;, &#39;Executor&#39;, &#39;Appointer&#39;, &#39;Partner&#39;
        )
    INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.Contact AS i 
        ON r.dsl_IndividualId = i.ContactId
)
SELECT RootEntityId, EntityId, Level, IndividualId, IndividualName, Path, Entity_FATCA_Flag, Entity_CRS_Flag, EntityFlag
INTO #HierarchyIndividuals
FROM HierarchyIndividuals;</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><strong>Purpose:</strong> To connect individuals (potential Controlling Persons or individual Account Holders if the entity itself is an FI proxy for individuals) to each layer of the entities identified in Step 2.</p></li><li><p><strong>Join Logic:</strong></p><ul><li><p><code>#RecursiveHierarchy rh INNER JOIN dsl_roles r ON rh.EntityId = r.dsl_TradingEntityID</code>: Correctly joins each entity (at any level in any hierarchy) to its associated roles.</p></li><li><p><code>r.dsl_IndividualId IS NOT NULL</code>: Ensures the role points to an individual, not another organisation (organisational links were handled in Step 2).</p></li><li><p><code>INNER JOIN Contact i ON r.dsl_IndividualId = i.ContactId</code>: Retrieves the individual's details.</p></li></ul></li><li><p><code>r.dsl_RoleTypeIdName IN (...)</code>: This is a <strong>very important filter</strong>.</p><ul><li><p>It's a pragmatic approach to identify individuals who <em>might</em> be Controlling Persons, especially when CRM's <code>dsl_BeneficialOwner</code> flag is unreliable (as stated in your comments).</p></li><li><p>The list of roles (<code>'Director'</code>, <code>'Trustee'</code>, etc.) appears comprehensive for typical controlling person types.</p></li><li><p><strong>&quot;Other&quot; Role:</strong> This is a potential risk. If &quot;Other&quot; is used too broadly in CRM for non-controlling roles, it might pull in irrelevant individuals. This needs careful monitoring. The assumption is &quot;Other&quot; implies some significance.</p></li><li><p><strong>&quot;Shareholder&quot;, &quot;Beneficiary&quot;:</strong> These roles alone don't automatically make someone a Controlling Person for FATCA. For shareholders, a &gt;25% ownership threshold usually applies. For beneficiaries of a trust, it depends on certainty and distribution rights. This role filter is a <em>first pass</em>; subsequent logic (like <code>SubstantialControllingInterest</code> in Step 4) should refine this.</p></li></ul></li><li><p><strong>Data Propagation:</strong></p><ul><li><p><code>rh.RootEntityId</code>, <code>rh.Entity_FATCA_Flag</code>, <code>rh.Entity_CRS_Flag</code>: Correctly carries forward the context of the ultimate parent entity and its FATCA/CRS status. This ensures that an individual linked to a sub-sub-company is still associated with the main reportable <code>RootEntityId</code>.</p></li></ul></li><li><p><code>DISTINCT</code>: Necessary because an individual might have multiple roles in the same entity that match the filter, or be linked through different paths if the hierarchy data is messy (though Step 2 tries to make paths unique by root).</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p><code>IndividualId</code> and <code>IndividualName</code> are precursors to the <code>&lt;ControllingPerson&gt;&lt;Individual&gt;&lt;Personतना&gt;</code> and <code>&lt;ControllingPerson&gt;&lt;Individual&gt;&lt;Name&gt;</code> elements.</p></li><li><p>The <code>Entity_FATCA_Flag</code> (from the root) determines if these potential Controlling Persons are relevant in a FATCA context.</p></li><li><p>If the <code>rh.EntityId</code> (the entity this individual is directly linked to) is a Passive NFFE, and <code>rh.Entity_FATCA_Flag</code> indicates a US reportable <code>RootEntityId</code>, then this <code>IndividualId</code> is a strong candidate for a <code>&lt;ControllingPerson&gt;</code>.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>The primary mitigation here is relying on <code>dsl_RoleTypeIdName</code> instead of a potentially incorrect <code>dsl_BeneficialOwner</code> flag in CRM. This is a good strategy.</p></li><li><p>If roles are misassigned in CRM (e.g., a clerk given a 'Director' role type by mistake), this step would incorrectly pull them in as potentially controlling. The accuracy of <code>dsl_RoleTypeIdName</code> assignment in CRM is a key dependency.</p></li><li><p><strong>Assumption:</strong> The listed <code>dsl_RoleTypeIdName</code> values are reasonably accurate indicators of potential control or significant beneficial interest.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Remember our Russian nesting dolls (the companies owning other companies)? Now, for <em>each</em> doll (big or small), we want to see which <em>people</em> are connected to it in important ways.</p></li><li><p>We look at the roles these people have with that specific doll/company:</p><ul><li><p>Are they a 'Director'? A 'Trustee'? A 'Shareholder'? etc. (We have a list of important-sounding roles).</p></li><li><p>We ignore people whose roles are <em>not</em> on our important list.</p></li><li><p>We also ignore if the role links to <em>another company</em> because we already dealt with company-to-company links. We only want people here.</p></li></ul></li><li><p>For every person with an important role in any doll, we make a note:</p><ul><li><p>'This Person (<code>IndividualId</code>, <code>IndividualName</code>) is linked to This Specific Doll (<code>EntityId</code>).'</p></li><li><p>'This Specific Doll belongs to This Big Nesting Set (<code>RootEntityId</code>).'</p></li><li><p>'The US Tax Flag for this whole set is [whatever the biggest doll's flag was].'</p></li></ul></li><li><p><code>#HierarchyIndividuals</code> is our list of all these 'person linked to a specific doll in a specific set' connections.&quot;</p></li></ul></li></ul><hr/><p>This step effectively identifies a pool of individuals associated with entities in potentially controlling capacities. The next step (Step 4) will enrich this data with more details about both the entity and the individual, and start applying more specific FATCA logic like ownership thresholds.</p><p>The reliance on <code>dsl_RoleTypeIdName</code> is a smart move given the context of unreliable CRM flags. The main vulnerability is the accuracy of those role type assignments themselves in the source CRM.</p><hr/><p><strong>Part 4: Step 4 (Extract Comprehensive Entity Data with Each Controlling Individual - #EntityData)</strong></p><hr/><p>This is a very large and crucial step. I'll break it down into subsections for clarity.</p><p><strong>Step 4: </strong><code>#EntityData</code> - Overview</p><ul><li><p><strong>Purpose:</strong> This CTE is designed to gather a comprehensive set of data points for situations where an <strong>Entity (Organisation)</strong> is the Account Holder. It combines:</p><ol start="1"><li><p>Details of the Entity itself (from <code>Account</code> table via <code>#RecursiveHierarchy</code>).</p></li><li><p>Details of an Individual linked to that Entity (from <code>Contact</code> table via <code>#HierarchyIndividuals</code>), who is a potential Controlling Person.</p></li><li><p>Portfolio information associated with the Entity.</p></li><li><p>Tax Identification Numbers (TINs) for both the Entity and the Individual.</p></li><li><p>Calculated <code>SubstantialControllingInterest</code> and <code>Regime</code>.</p></li></ol></li></ul><p><strong>Step 4.1: SELECT list - Section A, B, C (Entity Details)</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">-- Section A: Entity Identification &amp; Classification (for &lt;AccountHolder&gt;&lt;Organisation&gt;)
rh.EntityId         AS AccountID,       
rh.EntityId         AS EntityID,        
a.Name              AS EntityName,      
hi.EntityFlag       AS AccountType,     
sm.Value            AS TradingEntityType,
sm3.Value           AS TradingEntityStatus, 

-- Section B: Entity Financial &amp; Administrative Details
a.dsl_PortfolioSearchingIDs AS TE_AllPortfolioIDs, 
a.dsl_HighestPSLIdName  AS TE_HighestPSL,     
a.dsl_TotalHoldingsValue AS Acc_HoldingsValue, 
a.dsl_HoldingsUpdatedOn AS Acc_HoldingsUpdatedOn, 
a.dsl_ClosedDate        AS Acc_ClosedDate,    
a.dsl_CountryTrustEstablishedIdName AS TrustCountry, 
a.dsl_PrimaryTaxDomicileName  AS OrgPrimaryTaxDomicile, 
a.dsl_Address1CountryLookupIdName AS CountryofResidence, 
-- ... more address countries ...
sm2.Value AS PassiveActive, 
smfi.Value AS dsl_finffe,  

-- Section C: Entity Flags for FATCA/CRS Reporting (from hierarchy root)
rh.Entity_FATCA_Flag    AS USCitizensforTaxPurposes_acc, 
rh.Entity_CRS_Flag      AS ForeignTaxResident_acc,  </pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><code>rh.EntityId AS AccountID, rh.EntityId AS EntityID</code>: <code>EntityID</code> seems to be the primary identifier for the AccountHolder entity. <code>AccountID</code> might be redundant here if it's always the same as <code>EntityID</code> in this context (it comes from <code>rh.EntityId</code> which is <code>a.AccountId</code> from Step 2). Check if <code>AccountID</code> has a different purpose later. For now, assume <code>EntityID</code> is key.</p></li><li><p><code>a.Name AS EntityName</code>: Maps to <code>&lt;Organisation&gt;&lt;Name&gt;</code>.</p></li><li><p><code>AccountType</code> (Layered/Normal): Internal classification, good for understanding.</p></li><li><p><code>TradingEntityType</code>: Internal context.</p></li><li><p><code>Acc_HoldingsValue</code>: Basis for <code>&lt;AccountBalance currency=&quot;XXX&quot;&gt;value&lt;/AccountBalance&gt;</code>. The currency code is missing here but is essential for the XML. Assumed to be handled later or implicitly NZD.</p></li><li><p><code>Acc_HoldingsUpdatedOn</code>: Good for context of the balance, though XML only needs the balance as of report period end.</p></li><li><p><code>TrustCountry</code>, <code>OrgPrimaryTaxDomicile</code>, <code>CountryofResidence</code>: All feed into <code>&lt;Organisation&gt;&lt;Address&gt;&lt;CountryCode&gt;</code> or <code>&lt;TIN issuedBy=&quot;...&quot;&gt;</code>. Need 2-letter ISO codes eventually (handled in Step 6.0).</p></li><li><p><code>PassiveActive</code> (sm2.Value): <strong>Crucial for FATCA.</strong> 'Passive NFFE' triggers Controlling Person reporting. 'Active NFFE' has different (often simpler) due diligence.</p></li><li><p><code>dsl_finffe</code> (smfi.Value): If 'FI', this entity might be a Sponsoring FI, Intermediary FI, or even the ReportingFI itself, not an AccountHolder in the typical sense unless it's a Financial Account held by another FI. This flag needs careful handling in later filtering (Step 6 includes <code>dsl_finffe != 'FI'</code>).</p></li><li><p><code>USCitizensforTaxPurposes_acc</code> (from <code>rh.Entity_FATCA_Flag</code>): This is the FATCA flag of the <em>root</em> of the hierarchy this <code>rh.EntityId</code> belongs to. This is consistent with Step 2's logic.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping (Direct):</strong></p><ul><li><p><code>EntityName</code> -&gt; <code>&lt;Organisation&gt;&lt;Name&gt;</code></p></li><li><p><code>Acc_HoldingsValue</code> -&gt; <code>&lt;AccountBalance&gt;</code> (value part)</p></li><li><p>Address fields -&gt; <code>&lt;Organisation&gt;&lt;Address&gt;</code> (Street, City, CountryCode, etc.)</p></li><li><p><code>PassiveActive</code> -&gt; Determines NFFE type (PassiveNFFE vs ActiveNFFE in <code>ftc:FATCAEntityType</code> if that level of detail is in the specific HCTA's schema, or generally informs if CPs are needed).</p></li><li><p><code>dsl_finffe</code> -&gt; Informs <code>&lt;FATCAEntityType&gt;</code> (e.g., <code>FATCA101</code> for Passive NFFE, <code>FATCA102</code> for Active NFFE). If it's an FI, it would have a GIIN and a different entity type.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>Using <code>rh.Entity_FATCA_Flag</code> (from the root) for <code>USCitizensforTaxPurposes_acc</code> is a major guard against sub-entities in a chain being misflagged in CRM.</p></li><li><p>Reliance on <code>StringMap</code> (sm, sm2, sm3, smfi) for type/status values is good practice to avoid hardcoding numeric codes, assuming <code>StringMap</code> itself is accurate.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;We're making a detailed file for each COMPANY that has an account.</p></li><li><p><strong>Section A (Who is this company?):</strong> Its ID, its official Name (<code>EntityName</code>), and if it's a simple company or one that owns other companies.</p></li><li><p><strong>Section B (Company Details):</strong> How much money is in its account (<code>Acc_HoldingsValue</code>), when that balance was checked. Where it's based (its address countries: <code>TrustCountry</code>, <code>OrgPrimaryTaxDomicile</code>, <code>CountryofResidence</code>).</p><ul><li><p>Very Important: Is it an 'Active' company (like a shop selling things) or a 'Passive' one (mostly just holds investments)? This is <code>PassiveActive</code>.</p></li><li><p>Also Important: Is it a 'Financial Institution' (like a bank itself) or a 'Non-Financial Entity' (most other businesses)? This is <code>dsl_finffe</code>.</p></li></ul></li><li><p><strong>Section C (Company Tax Flags):</strong> Does this company (or the main company it belongs to if it's part of a chain) seem important for US taxes (<code>USCitizensforTaxPurposes_acc</code>)?&quot;</p></li></ul></li></ul><hr/><p><strong>Step 4.2: SELECT list - Section D (Role &amp; Controlling Interest)</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">-- Section D: Role Information at the Entity-Individual Level (for &lt;ControllingPerson&gt;)
r.dsl_RoleTypeIdName,      
r.dsl_BeneficialOwner,     
r.dsl_BeneficiaryOwnership,
-- ... other role flags ...
CASE
    WHEN rh.Entity_FATCA_Flag = 1 AND ( (r.dsl_BeneficiaryOwnership &gt; 25 AND sm.Value = &#39;Company&#39;) OR (sm.Value NOT IN (... &#39;Company&#39;)) ) THEN 1
    WHEN rh.Entity_CRS_Flag = 1 AND ( (r.dsl_BeneficiaryOwnership &gt; 10 AND sm.Value = &#39;Company&#39;) OR (sm.Value NOT IN (... &#39;Company&#39;)) ) THEN 1 -- CRS logic, FATCA is primary
    ELSE 0
END AS SubstantialControllingInterest, </pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><code>r.dsl_RoleTypeIdName</code>: Carried forward from Step 3. Maps to <code>&lt;ControllingPerson&gt;&lt;CtrlgPersonType&gt;</code> (e.g., <code>CPTY01</code> for Director, <code>CPTY04</code> for Trustee, etc. - needs mapping to OECD enum).</p></li><li><p><code>dsl_BeneficialOwner</code> (CRM flag): Kept for reference but acknowledged as unreliable.</p></li><li><p><code>dsl_BeneficiaryOwnership</code> (% value): <strong>Crucial for </strong><code>SubstantialControllingInterest</code>.</p></li><li><p><code>SubstantialControllingInterest</code> CASE statement:</p><ul><li><p><code>WHEN rh.Entity_FATCA_Flag = 1</code>: Correctly scopes this to FATCA.</p></li><li><p><code>r.dsl_BeneficiaryOwnership &gt; 25 AND sm.Value = 'Company'</code>: Standard FATCA threshold for substantial ownership of a company by percentage.</p></li><li><p><code>sm.Value NOT IN ('Individual', 'Joint', 'Minor Under 18 yrs', 'Company')</code>: This part covers entities like Trusts, Partnerships. For these, FATCA often treats <em>all</em> trustees, settlors (if US), general partners, or certain beneficiaries as Controlling Persons, irrespective of a fixed percentage. This logic effectively says &quot;if it's a Trust/Partnership etc., and the context is FATCA, then this person (in a relevant role from Step 3) is considered to have substantial control.&quot; This is a reasonable interpretation for these entity types.</p></li><li><p>The CRS part (<code>rh.Entity_CRS_Flag = 1 AND ... &gt; 10 ...</code>) is also present but the primary focus for FATCA output is the first <code>WHEN</code>.</p></li></ul></li><li><p><strong>Assumption:</strong> <code>dsl_BeneficiaryOwnership</code> in CRM is a reliable percentage. If it's free-text or inconsistently populated, this calculation will be flawed.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>If <code>SubstantialControllingInterest</code> is 1, and the entity is a Passive NFFE, and <code>USCitizensforTaxPurposes_ind</code> (for the individual) is true, then this individual becomes a reportable <code>&lt;ControllingPerson&gt;</code>.</p></li><li><p><code>dsl_RoleTypeIdName</code> maps to <code>&lt;ControllingPerson&gt;&lt;CtrlgPersonType&gt;</code> (after mapping to OECD codes).</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>The logic for Trusts/Partnerships (not relying on percentage) is a good way to handle situations where percentage ownership isn't applicable or well-defined for control.</p></li><li><p>If <code>dsl_BeneficiaryOwnership</code> is missing or zero for a Company Shareholder who <em>is</em> a &gt;25% owner, they would be missed by the percentage check. This relies on CRM data accuracy for percentages. The role-based inclusion from Step 3 provides a partial safety net if the role is &quot;Shareholder&quot; but percentage is bad.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Now we look at the PERSON linked to this company.</p></li><li><p>What's their role (<code>dsl_RoleTypeIdName</code>)? Like 'Director' or 'Trustee'.</p></li><li><p>How much of the company do they own, as a percentage (<code>dsl_BeneficiaryOwnership</code>)?</p></li><li><p><code>SubstantialControllingInterest</code>: This is a YES/NO flag.</p><ul><li><p>If it's a normal Company: YES if they own more than 25%.</p></li><li><p>If it's something like a Trust or Partnership: It's usually YES if their role is important (like Trustee), because 'owning' a trust is different.</p></li><li><p>(It also looks at rules for Country X tax, but we care most about the US rules here).&quot;</p></li></ul></li></ul></li></ul><hr/><p><strong>Step 4.3: SELECT list - Section E (Portfolio Details)</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">-- Section E: Portfolio Service Details
ps.dsl_PortfolioId,        
ps.dsl_PortfolioIdName      AS PortfolioNo,        
ps.dsl_PortfolioServiceLevelName, 
smPS.Value                  AS PortfolioServiceStatus, 
ROUND(CAST(ps.dsl_TotalHoldingsValue AS FLOAT), 2) AS ps_HoldingsValue, 
ps.dsl_inceptiondate        AS dsl_inceptiondate,   
-- ... other portfolio closure fields ...
ps.dsl_CloseDate,          
ps.dsl_CloseDate            AS ClosureDate, </pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><code>PortfolioNo</code>, <code>dsl_PortfolioServiceLevelName</code>: These are often combined to form the unique <code>&lt;AcctNumber&gt;</code> in the FATCA XML. The exact construction of <code>AcctNumber</code> (e.g., concatenation, delimiters) needs to be defined.</p></li><li><p><code>PortfolioServiceStatus</code>: Used for filtering reportable accounts (e.g., excluding fully closed accounts before the period).</p></li><li><p><code>ps_HoldingsValue</code>: This is portfolio-level holdings. <code>Acc_HoldingsValue</code> (from Section B) was account-level. If an Account (Entity) has multiple Portfolios, FATCA usually requires reporting the aggregate balance or each sub-account. The schema supports sub-accounts. This SP seems to produce one row per (Entity, Individual, Portfolio). This means <code>ps_HoldingsValue</code> is likely the <code>&lt;AccountBalance&gt;</code> for <em>this specific portfolio line</em>.</p></li><li><p><code>dsl_inceptiondate</code>, <code>dsl_CloseDate</code>: Important for determining if the account was open during the reporting period.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p><code>PortfolioNo</code> (often combined with <code>dsl_PortfolioServiceLevelName</code> or other identifiers) -&gt; <code>&lt;AccountReport&gt;&lt;AcctNumber&gt;</code>.</p></li><li><p><code>ps_HoldingsValue</code> -&gt; <code>&lt;AccountReport&gt;&lt;AccountBalance&gt;</code> (for this specific portfolio/sub-account). Currency is still missing.</p></li><li><p><code>PortfolioServiceStatus</code>, <code>dsl_inceptiondate</code>, <code>dsl_CloseDate</code> -&gt; Used to determine if an <code>&lt;AccountReport&gt;</code> is needed at all, and potentially for <code>&lt;ClosedAccount&gt;true&lt;/ClosedAccount&gt;</code> or <code>&lt;DormantAccount&gt;</code>.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>The <code>INNER JOIN</code> to <code>dsl_portfolioservice</code> in the <code>FROM</code> clause (and its <code>NOT</code> conditions) already filters out some irrelevant portfolios.</p></li><li><p>If portfolio statuses or dates are wrong in CRM, incorrect accounts might be included/excluded.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Each company account can have one or more 'sub-accounts' or 'portfolios' (<code>PortfolioNo</code>, <code>dsl_PortfolioServiceLevelName</code>).</p></li><li><p>We get the balance for <em>each</em> of these sub-accounts (<code>ps_HoldingsValue</code>).</p></li><li><p>We also check if this sub-account is 'Active' or 'Closed' (<code>PortfolioServiceStatus</code>), and when it was opened or closed (<code>dsl_inceptiondate</code>, <code>dsl_CloseDate</code>).&quot;</p></li></ul></li></ul><hr/><p><strong>Step 4.4: SELECT list - Section F, G (Individual/Controlling Person Details)</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">-- Section F: Individual Identification &amp; Contact Information (for &lt;ControllingPerson&gt;&lt;Individual&gt;)
hi.IndividualId,           
hi.IndividualName,         
i.FirstName,               
i.MiddleName,              
i.LastName,                
-- ... Tel numbers (not for XML) ...
-- ... Address lines ... ResidentialCity, ResidentialPostalCode ...

-- Section G: Additional Demographic &amp; Tax Information for Individuals (for &lt;ControllingPerson&gt;&lt;Individual&gt;)
i.dsl_Address1CountryLookupIdName AS ResidentialCountry1, 
-- ... other address country lookups ...
i.dsl_CountryofCitizenshipIdName  AS CountryofCitizenship, 
i.dsl_CountryofTaxResidencyName   AS CountryofTaxResidency, 
i.dsl_CountryOfBirthIdName AS CountryofBirthIdName, 
i.dsl_USCitizensforTaxPurposes AS USCitizensforTaxPurposes_ind, 
i.ots_ForeignTaxResident     AS ForeignTaxResident_ind,   
sm1.Value AS CRSCert,          
CONVERT(VARCHAR(10), DATEADD(hour, 0, i.BirthDate), 101) AS DOB, 
i.cip_TownCityofBirth AS TownCityofBirth, </pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><code>IndividualId</code>: Key for the individual.</p></li><li><p><code>FirstName</code>, <code>MiddleName</code>, <code>LastName</code>: Direct mapping to <code>&lt;Individual&gt;&lt;Name&gt;</code>. FATCA schema has <code>PrecedingTitle</code>, <code>Title</code>, <code>NamePrefix</code>, <code>GivenName</code>, <code>MiddleName</code>, <code>NameSuffix</code>, <code>GeneralSuffix</code>. <code>FirstName</code> likely maps to <code>GivenName</code>. Consider if CRM has more granular name parts.</p></li><li><p>Address fields: Map to <code>&lt;Individual&gt;&lt;Address&gt;</code>. Country codes need 2-letter ISO.</p></li><li><p><code>CountryofCitizenship</code>: Important for identifying US Persons (if &quot;US&quot;).</p></li><li><p><code>CountryofTaxResidency</code>: Maps to <code>&lt;Individual&gt;&lt;ResCountryCode&gt;</code> (can be multiple in XML if individual is resident in multiple countries for tax). This query picks up one (<code>dsl_CountryofTaxResidencyName</code>). If CRM stores multiple, this needs adjustment.</p></li><li><p><code>CountryofBirthIdName</code>: Maps to <code>&lt;BirthInfo&gt;&lt;CountryInfo&gt;&lt;CountryCode&gt;</code>.</p></li><li><p><code>USCitizensforTaxPurposes_ind</code>: <strong>Critical flag.</strong> If 1, this individual is a US Person.</p></li><li><p><code>DOB</code>: <code>CONVERT(VARCHAR(10), ..., 101)</code> gives MM/DD/YYYY. FATCA XML needs <code>YYYY-MM-DD</code>. The <code>DATEADD(hour, 0, i.BirthDate)</code> is unusual. The original had <code>DATEADD(HOUR, 13, i.BirthDate)</code>. This was explained as a UTC to NZST/DT conversion. If <code>i.BirthDate</code> is truly UTC, then <code>DATEADD(hour, 13, ...)</code> is needed for correct local date, then format to <code>YYYY-MM-DD</code>. If <code>BirthDate</code> is already local, no <code>DATEADD</code> needed. The current <code>DATEADD(hour, 0, ...)</code> is a no-op if <code>BirthDate</code> is already datetime. <strong>This needs clarification.</strong> For now, assume the intention of the original <code>+13</code> was correct for timezone.</p></li><li><p><code>TownCityofBirth</code>: Maps to <code>&lt;BirthInfo&gt;&lt;City&gt;</code>. <code>&lt;BirthInfo&gt;</code> also has optional <code>BirthDateUnknown</code> boolean.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping (Direct):</strong></p><ul><li><p>Name parts -&gt; <code>&lt;Individual&gt;&lt;Name&gt;</code></p></li><li><p>Address parts -&gt; <code>&lt;Individual&gt;&lt;Address&gt;</code></p></li><li><p><code>ResidentialCountry1</code> (once ISO 2-char) -&gt; <code>&lt;Individual&gt;&lt;Address&gt;&lt;CountryCode&gt;</code></p></li><li><p><code>CountryofTaxResidency</code> (once ISO 2-char) -&gt; <code>&lt;Individual&gt;&lt;ResCountryCode&gt;</code></p></li><li><p><code>USCitizensforTaxPurposes_ind = 1</code> -&gt; Indicates this person is a US Person.</p></li><li><p><code>DOB</code> (formatted YYYY-MM-DD) -&gt; <code>&lt;Individual&gt;&lt;BirthInfo&gt;&lt;BirthDate&gt;</code></p></li><li><p><code>TownCityofBirth</code> -&gt; <code>&lt;Individual&gt;&lt;BirthInfo&gt;&lt;City&gt;</code></p></li><li><p><code>CountryofBirthIdName</code> (once ISO 2-char) -&gt; <code>&lt;Individual&gt;&lt;BirthInfo&gt;&lt;CountryInfo&gt;&lt;CountryCode&gt;</code></p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>Relies heavily on CRM data accuracy for names, addresses, DOB, citizenship, tax residency.</p></li><li><p>The <code>USCitizensforTaxPurposes_ind</code> flag is taken directly from CRM. If this is wrong, the person's US status will be wrong.</p></li><li><p><strong>Date of Birth:</strong> If DOB is missing or invalid in CRM, this will cause issues. FATCA allows <code>BirthDateUnknown</code> but requires explanation if TIN is also missing.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Now, for the PERSON linked to the company, we get their details:</p></li><li><p><strong>Section F (Who is this person?):</strong> Their ID, full name, first/middle/last names. Their home address (street, city, postcode).</p></li><li><p><strong>Section G (Person's Tax Details):</strong></p><ul><li><p>Which country is their home address in (<code>ResidentialCountry1</code>)?</p></li><li><p>Which country are they a citizen of (<code>CountryofCitizenship</code>)? (Is it the USA?)</p></li><li><p>Which country do they pay taxes to (<code>CountryofTaxResidency</code>)?</p></li><li><p>Where were they born (country <code>CountryofBirthIdName</code>, city <code>TownCityofBirth</code>)?</p></li><li><p>When were they born (<code>DOB</code>)?</p></li><li><p>Is this person a US citizen for tax purposes (<code>USCitizensforTaxPurposes_ind</code>)? This is super important!&quot;</p></li></ul></li></ul></li></ul><hr/><p><strong>Step 4.5: SELECT list - Section H, I (TINs &amp; Regime)</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">-- Section H: Tax Record Details for Entity and Individual (for &lt;TIN&gt; elements)
-- (a) Entity-level Tax Identification (TIN) for &lt;AccountHolder&gt;&lt;Organisation&gt;&lt;TIN&gt;
ft1.cip_identification         AS EntityTIN,       
ft1.cip_CountryJurisdictionName AS EntityCountryJurisdictionName, 
cc1.cip_ISOcode AS EntityTaxCodeCountryISO, 
-- (b) Individual-level Tax Identification (TIN) for &lt;ControllingPerson&gt;&lt;Individual&gt;&lt;TIN&gt;
ft2.cip_identification         AS cip_Identification, 
ft2.cip_CountryJurisdictionName AS IndividualCountryJurisdictionName, 
cc2.cip_ISOcode AS Ind_TaxCodeCountryISO, 

-- Section I: Reporting Regime Mapping (based on combined FATCA/CRS flags from #TaxRegimeMapping)
trm.TaxRegime, 
trm.Regime     </pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><code>EntityTIN</code>, <code>EntityCountryJurisdictionName</code>: For the <code>&lt;Organisation&gt;&lt;TIN issuedBy=&quot;...&quot;&gt;value&lt;/TIN&gt;</code>. <code>issuedBy</code> will be the 2-char ISO from <code>EntityTaxCodeCountryISOShort</code> (Step 6.0).</p></li><li><p><code>cip_Identification</code> (ft2), <code>IndividualCountryJurisdictionName</code>: For the <code>&lt;Individual&gt;&lt;TIN issuedBy=&quot;...&quot;&gt;value&lt;/TIN&gt;</code> of the Controlling Person.</p></li><li><p><code>TaxRegime</code>, <code>Regime</code>: Derived from the <code>#TaxRegimeMapping</code> based on the combined flags (from root entity and individual). <code>Regime</code> ('FATCA', 'FATCA_CRS') will be key for filtering.</p></li><li><p>The joins to <code>cip_foreigntaxrecord</code> (ft1, ft2) and <code>dsl_countryBase</code> (cc1, cc2) are <code>LEFT JOIN</code>s. This is important because an entity or individual might not have a TIN recorded, or might not have a foreign TIN.</p><ul><li><p><strong>CRITICAL FILTER in WHERE clause</strong>: <code>AND ft2.cip_CountryJurisdiction IS NOT NULL AND ft2.cip_Identification IS NOT NULL</code>. This effectively turns the <code>LEFT JOIN</code> to <code>ft2</code> (individual's TIN) into an <code>INNER JOIN</code> for the purpose of this <code>#EntityData</code> CTE. It means <strong>an entity record will only appear in </strong><code>#EntityData</code> if its associated individual (potential CP) has a recorded foreign TIN.</p></li><li><p>This is a very strong filter. If a US person is a CP of a Passive NFFE but their US TIN is <em>not</em> recorded in <code>cip_foreigntaxrecord</code> in CRM, this entire Entity-CP combination will be excluded from <code>#EntityData</code>. This could lead to under-reporting if the person <em>is</em> a US person but their TIN is simply missing from CRM. FATCA has rules for missing TINs (requiring DOB, or explanation codes).</p></li><li><p>The entity's TIN (<code>ft1</code>) is still via <code>LEFT JOIN</code>, so an entity might appear if its CP has a TIN, even if the entity itself doesn't have a recorded foreign TIN.</p></li></ul></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p><code>EntityTIN</code> -&gt; <code>&lt;Organisation&gt;&lt;TIN&gt;</code> value. <code>EntityCountryJurisdictionName</code> (via <code>EntityTaxCodeCountryISOShort</code>) -&gt; <code>issuedBy</code> attribute.</p></li><li><p><code>cip_Identification</code> (individual's) -&gt; <code>&lt;ControllingPerson&gt;&lt;Individual&gt;&lt;TIN&gt;</code> value. <code>IndividualCountryJurisdictionName</code> (via <code>Ind_TaxCodeCountryISOShort</code>) -&gt; <code>issuedBy</code> attribute.</p></li><li><p><code>Regime</code> -&gt; Determines if this record is part of the FATCA file.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>The critical filter <code>AND ft2.cip_CountryJurisdiction IS NOT NULL AND ft2.cip_Identification IS NOT NULL</code> is a double-edged sword:</p><ul><li><p>It prevents reporting CPs where no foreign TIN is available (good, avoids sending blank TINs if that's the policy).</p></li><li><p>It risks under-reporting if a US CP's TIN is simply missing from CRM due to data entry error, but other indicia (like US Citizenship flag + DOB) exist. FATCA allows reporting with DOB if TIN is unavilable after reasonable efforts. This SP currently does <em>not</em> support that path for CPs of entities if this filter is active.</p></li></ul></li><li><p>Missing <code>EntityTIN</code> is handled by the <code>LEFT JOIN</code>.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;<strong>Section H (Tax Numbers):</strong></p><ul><li><p>Does the COMPANY have a tax number from another country (<code>EntityTIN</code>, <code>EntityCountryJurisdictionName</code>)?</p></li><li><p>Does the PERSON linked to the company have a tax number from another country (<code>cip_Identification</code>, <code>IndividualCountryJurisdictionName</code>)?</p></li><li><p><strong>Super Important Filter applied later:</strong> For this whole company-person file to be created, the <em>person</em> MUST have a foreign tax number listed. If they don't, we ignore this combination for now.</p></li></ul></li><li><p><strong>Section I (Which Tax Report?):</strong></p><ul><li><p>Based on all the flags we've seen (from the main company and the person), our 'secret decoder ring' from Step 1 tells us if this needs to go into the US Tax Report (<code>Regime</code> = 'FATCA' or 'FATCA_CRS').&quot;</p></li></ul></li></ul></li></ul><hr/><p><strong>Step 4.6: FROM and JOIN clauses</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">FROM #HierarchyIndividuals hi
INNER JOIN #RecursiveHierarchy rh ON hi.RootEntityId = rh.RootEntityId AND hi.EntityId = rh.EntityId
INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.Contact AS i ON hi.IndividualId = i.ContactId
INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.Account AS a ON rh.EntityId = a.AccountId
INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.dsl_roles AS r ON rh.EntityId = r.dsl_TradingEntityID AND r.dsl_IndividualId = hi.IndividualId AND r.statuscode = 1
INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.dsl_portfolioservice AS ps ON ps.dsl_TradingEntityId = a.AccountId
    AND NOT (ps.dsl_portfolioservicestatus IN (&#39;860910002&#39;, &#39;860910003&#39;) AND (ps.dsl_TotalHoldingsValue = 0 OR ps.dsl_TotalHoldingsValue IS NULL)) 
    AND NOT (ps.dsl_portfolioservicestatus IN (&#39;860910002&#39;, &#39;860910003&#39;) AND (ps.dsl_CloseDate IS NOT NULL AND ps.dsl_CloseDate &lt;= @PeriodStartDate)) 
-- ... LEFT JOINs to StringMap, cip_foreigntaxrecord, dsl_countryBase, #TaxRegimeMapping ...</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p>Core <code>INNER JOIN</code> structure: <code>hi</code> (Individual linked to an Entity in a Hierarchy) -&gt; <code>rh</code> (details of that Entity in that Hierarchy) -&gt; <code>i</code> (Individual's master details) -&gt; <code>a</code> (Entity's master details) -&gt; <code>r</code> (the specific Role linking <em>this</em> <code>rh.EntityId</code> to <em>this</em> <code>hi.IndividualId</code>). This chain is logical and ensures all parts are connected for the current row.</p></li><li><p><code>INNER JOIN ... dsl_portfolioservice ps</code>: This means an Entity-Individual pair will only appear if the Entity (<code>a.AccountId</code>) has at least one active, non-zero-value (if closed/pending) portfolio that wasn't closed before the reporting period. This is a strong filter. If an entity is reportable but all its portfolios are filtered out here, it won't appear.</p></li><li><p>The <code>NOT</code> conditions on <code>ps</code> effectively filter out:</p><ol start="1"><li><p>Portfolios Pending Closure or Closed that also have a zero/NULL total holdings value.</p></li><li><p>Portfolios Pending Closure or Closed that were actually closed <em>before</em> the <code>@PeriodStartDate</code>.</p></li></ol></li><li><p><code>LEFT JOIN</code>s for <code>StringMap</code>, <code>cip_foreigntaxrecord</code>, <code>dsl_countryBase</code>, <code>#TaxRegimeMapping</code>: Correctly used as these are lookups that might not always find a match (e.g., no TIN recorded, no country mapping).</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>The portfolio join is critical because <code>&lt;AccountReport&gt;</code> elements are per &quot;financial account.&quot; If an entity has no qualifying financial accounts (portfolios), it shouldn't be reported.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>The portfolio filters are good for excluding stale/irrelevant accounts based on status, value, and closure date, which might be mismanaged in CRM.</p></li><li><p>If <code>ps.dsl_TradingEntityId</code> (link from portfolio to account) is broken in CRM, portfolios would be missed.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;How do we connect all this information?</p></li><li><p>We start with our list of 'Person linked to a specific Doll (Company) in a specific Set' (<code>#HierarchyIndividuals</code>).</p></li><li><p>Then we get more details about that specific Doll/Company from our nesting doll list (<code>#RecursiveHierarchy</code>).</p></li><li><p>Then we get the Person's main file (<code>Contact</code> table).</p></li><li><p>Then we get the Company's main file (<code>Account</code> table).</p></li><li><p>Then we find the <em>exact role</em> that links this Person to this Company (<code>dsl_roles</code>).</p></li><li><p><strong>Very Important:</strong> We only care about this Company-Person pair if the Company has at least one 'sub-account' or 'portfolio' (<code>dsl_portfolioservice</code>) that:</p><ul><li><p>Isn't 'Closed' or 'Pending Closure' with a zero balance.</p></li><li><p>And wasn't already closed <em>before</em> our report start date.</p></li></ul></li><li><p>Then we look up extra details like country names, tax numbers, and our 'secret decoder ring' for tax reports using <code>LEFT JOIN</code> (meaning, if we can't find it, that's okay, we just leave it blank for now).&quot;</p></li></ul></li></ul><hr/><p><strong>Step 4.7: WHERE clause filters</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">WHERE 1=1
  AND (ft1.statecode = 0 OR ft1.statecode IS NULL) -- Active entity tax records.
  AND (ft2.statecode = 0 OR ft2.statecode IS NULL) -- Active individual tax records.
  AND sm.Value IN (&#39;Trust&#39;, &#39;Company&#39;, &#39;Incorporated Entity&#39;, &#39;Partnership&#39;) -- Only these entity types.
  AND (rh.Entity_FATCA_Flag = 1 OR rh.Entity_CRS_Flag = 1) -- Entity must have some foreign indication from root.
  AND ft2.cip_CountryJurisdiction IS NOT NULL 
  AND ft2.cip_Identification IS NOT NULL -- Individual (potential CP) must have a foreign TIN.
  AND ISNULL(cc1.cip_ISOCode, &#39;&#39;) &lt;&gt; &#39;NZL&#39; -- Exclude if Entity TIN is solely NZ.
  AND NOT (sm.Value = &#39;Trust&#39; AND ISNULL(sm2.Value, &#39;&#39;) = &#39;Passive&#39; AND a.cip_CharityNumber IS NOT NULL) -- Exclude passive charitable trusts.
  AND ISNULL(cc2.cip_ISOCode, &#39;&#39;) &lt;&gt; &#39;NZL&#39; -- Exclude if Individual&#39;s TIN is solely NZ.
  AND trm.TaxRegime NOT IN (&#39;CRS (Individual) &amp; FATCA (Entity)&#39;, &#39;CRS (Entity) &amp; FATCA (Individual)&#39;) -- Exclude CRM data errors.
  AND NOT (smPS.value = &#39;Pending Closure&#39; AND (a.dsl_TotalHoldingsValue = 0 OR a.dsl_TotalHoldingsValue IS NULL)) 
  AND NOT (smPS.value = &#39;Closed&#39; AND (a.dsl_TotalHoldingsValue = 0 OR a.dsl_TotalHoldingsValue IS NULL))</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><code>ft1.statecode</code>, <code>ft2.statecode</code>: Good to filter for active tax records.</p></li><li><p><code>sm.Value IN (...)</code>: Restricts to valid entity types for this logic path.</p></li><li><p><code>(rh.Entity_FATCA_Flag = 1 OR rh.Entity_CRS_Flag = 1)</code>: Ensures the root entity of the chain has some foreign indicia.</p></li><li><p><code>ft2.cip_CountryJurisdiction IS NOT NULL AND ft2.cip_Identification IS NOT NULL</code>: <strong>Re-iterating this critical filter.</strong> This record only makes it if the <em>individual</em> has a recorded foreign TIN.</p></li><li><p><code>ISNULL(cc1.cip_ISOCode, '') &lt;&gt; 'NZL'</code> and <code>ISNULL(cc2.cip_ISOCode, '') &lt;&gt; 'NZL'</code>: Excludes records if the <em>only</em> TIN available for the entity or individual is an NZ IRD number. If they have a US TIN <em>and</em> an NZ TIN, they would pass this (as the US TIN record would satisfy other conditions and this filter applies per TIN record effectively, then the overall record is kept). This is generally correct for foreign reporting.</p></li><li><p><code>NOT (sm.Value = 'Trust' ... CharityNumber IS NOT NULL)</code>: Charity exclusion.</p></li><li><p><code>trm.TaxRegime NOT IN (...)</code>: Excludes specific illogical flag combinations from the regime mapping that likely represent bad CRM data.</p></li><li><p>The last two <code>NOT (smPS.value ...)</code> filters on portfolio status/value: These seem to apply to the Account-level holdings (<code>a.dsl_TotalHoldingsValue</code>) whereas the portfolio join filter used <code>ps.dsl_TotalHoldingsValue</code>. This is a bit confusing.</p><ul><li><p>The <code>INNER JOIN ... ps</code> already filtered on <code>ps.dsl_TotalHoldingsValue</code>.</p></li><li><p>These final filters check <code>a.dsl_TotalHoldingsValue</code> (the aggregate for the Account/Entity). This means even if a <em>portfolio</em> had value, if the <em>overall account</em> shows zero/null for these statuses, it's excluded. This could be an additional safety net or potentially conflicting if <code>a.dsl_TotalHoldingsValue</code> isn't reliably updated when <code>ps.dsl_TotalHoldingsValue</code> is.</p></li><li><p><strong>Recommendation:</strong> Clarify the intent. Usually, if <em>any</em> sub-account/portfolio has reportable value and status, the main account is reportable. If <code>a.dsl_TotalHoldingsValue</code> is a true, reliable aggregate, this might be okay. Otherwise, relying on the sum of <code>ps.dsl_TotalHoldingsValue</code> for qualifying portfolios might be more robust.</p></li></ul></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>These filters collectively decide if an Entity-Individual-Portfolio combination is even provisionally reportable under FATCA.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>Exclusion of NZ-only TINs is good.</p></li><li><p>Exclusion of illogical <code>TaxRegime</code> combinations from Step 1 handles severe flag errors.</p></li><li><p>The filter on individual's foreign TIN being present is a strong stance against missing TIN data in CRM.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Finally, before we put this Company-Person file into our temporary box (<code>#EntityData</code>), we do some last checks:</p><ul><li><p>Are the tax records we found active?</p></li><li><p>Is the company one of the types we care about (Trust, Company, etc.)?</p></li><li><p>Does the main company in its nesting set have a US or foreign tax flag?</p></li><li><p><strong>Does the PERSON have a foreign tax number recorded? (Super important check again!)</strong></p></li><li><p>If the company's ONLY tax number is for New Zealand, we probably don't need it for <em>this</em> US report. Same for the person.</p></li><li><p>Is it a charity trust? Probably not needed.</p></li><li><p>Did our 'secret decoder ring' give a really weird tax report type that looks like a mistake? Ignore it.</p></li><li><p>One last check on 'Pending Closure' or 'Closed' accounts with zero balance for the <em>whole company account</em> – if so, ignore.&quot;</p></li></ul></li></ul></li></ul><hr/><p>Phew! Step 4 is a beast. The most contentious point is the hard requirement for the individual (potential CP) to have a foreign TIN recorded (<code>ft2.cip_Identification IS NOT NULL</code>). While it simplifies, it risks under-reporting US CPs whose TINs are merely missing from CRM. FATCA has provisions for this (report DOB, explain TIN absence).</p><p>Next up, Step 5, which focuses on direct Individual Account Holders.</p><hr/><p><strong>Part 5: Step 5 (Extract Individual-Level Data - #IndividualData)</strong></p><hr/><p><strong>Step 5: </strong><code>#IndividualData</code> - Overview</p><ul><li><p><strong>Purpose:</strong> This CTE is for accounts where the <strong>Individual</strong> is the direct Account Holder (e.g., personal accounts, joint accounts, minor accounts). This contrasts with Step 4, which was for Entity Account Holders.</p><ul><li><p>This will populate <code>&lt;AccountHolder&gt;&lt;Individual&gt;</code> in the FATCA XML.</p></li><li><p>It also identifies &quot;Foreign Controlling Individuals&quot; – a nuanced case where an individual might control <em>another individual's</em> account and be reportable.</p></li></ul></li></ul><p><strong>Step 5.1: </strong><code>#TIN_Counts</code> CTE</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">IF OBJECT_ID(&#39;tempdb..#TIN_Counts&#39;) IS NOT NULL DROP TABLE #TIN_Counts;
SELECT
    a.AccountId,
    ps.dsl_PortfolioIdName AS PortfolioNo,
    ps.dsl_PortfolioServiceLevelName,
    i.ContactId AS IndividualId,
    COUNT(DISTINCT ft2.cip_identification) AS TIN_Count
INTO #TIN_Counts
FROM [DynamicsPROD].[CRM_MSCRM].dbo.Account AS a
INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.dsl_roles AS r ON a.AccountId = r.dsl_TradingEntityID AND r.statuscode = 1 AND r.dsl_BeneficialOwner = 1
INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.Contact AS i ON i.ContactId = r.dsl_IndividualId
LEFT JOIN [DynamicsPROD].[CRM_MSCRM].dbo.dsl_portfolioservice AS ps ON ps.dsl_TradingEntityId = a.AccountId
LEFT JOIN [DynamicsPROD].[CRM_MSCRM].[dbo].[cip_foreigntaxrecord] AS ft2 ON ft2.cip_Individual = i.ContactId
WHERE
    ft2.cip_CountryJurisdiction IS NOT NULL AND ft2.cip_Identification IS NOT NULL 
    AND (i.dsl_USCitizensforTaxPurposes = 1 OR i.ots_foreigntaxresident = 1) 
GROUP BY a.AccountId, ps.dsl_PortfolioIdName, ps.dsl_PortfolioServiceLevelName, i.ContactId;</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><strong>Purpose:</strong> Counts the number of distinct foreign TINs for each individual beneficial owner of an account/portfolio. This is used later to classify individuals as &quot;Single TIN&quot; or &quot;Multiple TINs&quot; for the <code>AccountType</code> field.</p></li><li><p><code>r.dsl_BeneficialOwner = 1</code>: This is key. It's counting TINs for people flagged as beneficial owners in CRM.</p></li><li><p><code>ft2.cip_CountryJurisdiction IS NOT NULL AND ft2.cip_Identification IS NOT NULL</code>: Only counts <em>recorded foreign</em> TINs.</p></li><li><p><code>i.dsl_USCitizensforTaxPurposes = 1 OR i.ots_foreigntaxresident = 1</code>: Only for individuals who already have US/foreign indicia.</p></li><li><p><code>GROUP BY</code>: Correctly groups by Account, Portfolio, Service Level, and Individual.</p></li><li><p><strong>Utility:</strong> The &quot;Single/Multiple TINs&quot; distinction isn't directly required by FATCA XML (all available TINs are listed), but it can be useful for internal analysis or if there are specific business rules around it.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>Indirect. Helps classify <code>AccountType</code>, but the XML itself will contain all TINs provided.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>Relies on <code>dsl_BeneficialOwner = 1</code> being correctly set for the actual owners. If it's wrong, TINs for the true owner might not be counted here for <em>their</em> record if they aren't flagged as BO.</p></li><li><p>If foreign TINs are missing in <code>cip_foreigntaxrecord</code>, <code>TIN_Count</code> will be lower or zero.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Before we look at accounts owned directly by people, we do a quick count.</p></li><li><p>For every person who is listed as an 'owner' of an account:</p><ul><li><p>How many <em>different foreign tax numbers</em> do they have written down in their file?</p></li></ul></li><li><p><code>#TIN_Counts</code> is a list: Person A on Account 123 has 2 foreign tax numbers. Person B on Account 456 has 1 foreign tax number.&quot;</p></li></ul></li></ul><hr/><p><strong>Step 5.2: </strong><code>#IndividualData</code> CTE - SELECT list and Key Logic</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">-- Section A: Entity Identification &amp; Classification (here, &quot;Entity&quot; is the Individual Account Holder)
i.ContactId AS AccountID,       
a.AccountId AS EntityID,        
a.Name AS EntityName,          
CASE 
    WHEN r.dsl_BeneficialOwner &lt;&gt; 1 
         AND r.dsl_RoleTypeIdName IN (&#39;Authorised Person&#39;, ..., &#39;Guardian&#39;) 
         AND r.dsl_Authorised = 1 
         AND ft2.cip_identification IS NOT NULL 
    THEN &#39;Foreign Controlling Individual&#39; 
    WHEN tc.TIN_Count &gt; 1 THEN &#39;Multiple TINs Individual&#39; 
    ELSE &#39;Single TIN Individual&#39; 
END AS AccountType, 
sm.Value AS TradingEntityType, -- e.g., &#39;Individual&#39;, &#39;Joint&#39;.
-- ... (Sections B, C, E, F, G are very similar to Step 4 but contextualized for an Individual AccountHolder)

-- Section H: Tax Record Details (Entity TINs are blank for individual AccountHolders)
&#39;&#39; AS EntityTIN, &#39;&#39; AS EntityIDTypeName, ... , -- Entity TIN fields deliberately blank
ft2.cip_identification AS cip_Identification, -- Individual&#39;s TIN
-- ...

-- Section I: Reporting Regime Mapping
trm.TaxRegime, trm.Regime</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><code>i.ContactId AS AccountID</code>: Makes sense; the individual is the account holder, so their ID is primary. <code>a.AccountId AS EntityID</code> is the CRM Account record this role/portfolio links to.</p></li><li><p><code>AccountType</code> CASE statement:</p><ul><li><p><code>Foreign Controlling Individual</code>:</p><ul><li><p><code>r.dsl_BeneficialOwner &lt;&gt; 1</code>: Not the owner.</p></li><li><p><code>r.dsl_RoleTypeIdName IN (...) AND r.dsl_Authorised = 1</code>: Has a significant, authorized role (e.g., mandate holder, guardian of a minor's account).</p></li><li><p><code>ft2.cip_identification IS NOT NULL</code>: And this controlling non-owner <em>has a foreign TIN</em>.</p></li><li><p>This is an interesting category. For FATCA, if the account holder is Individual A (a US person), then Individual A is reported. If Individual B (a foreign person with a foreign TIN) has authority over A's account, B isn't typically a <em>FATCA reportable Controlling Person of A's individual account</em> in the same way CPs of Passive NFFEs are. However, this data might be relevant for AML, CRS, or specific HCTA interpretations. For pure FATCA IDES 2.0, this <code>AccountType</code> needs careful consideration on how it translates to XML – it likely still means the <em>original beneficial owner</em> is the <code>&lt;AccountHolder&gt;</code>. This category might be more for internal classification or other regimes.</p></li></ul></li><li><p><code>Multiple TINs Individual</code> / <code>Single TIN Individual</code>: Uses the <code>#TIN_Counts</code> from before. Informational.</p></li></ul></li><li><p><code>TradingEntityType</code>: Should be <code>'Individual'</code>, <code>'Joint'</code>, <code>'Minor Under 18 yrs'</code> as per the <code>WHERE</code> clause filter later.</p></li><li><p><strong>Blank Entity TINs:</strong> <code>'' AS EntityTIN, ...</code>: Correct. If the AccountHolder is an Individual, there's no separate Entity TIN for the AccountHolder block itself.</p></li><li><p><strong>Individual's Details (Sections F, G, H-Individual):</strong> Similar to Step 4, but now these map to <code>&lt;AccountHolder&gt;&lt;Individual&gt;&lt;Name&gt;</code>, <code>&lt;Address&gt;</code>, <code>&lt;TIN&gt;</code>, <code>&lt;BirthInfo&gt;</code>, <code>&lt;ResCountryCode&gt;</code> rather than a <code>&lt;ControllingPerson&gt;</code>.</p></li><li><p><strong>DOB format and Timezone:</strong> Same concern as in Step 4. <code>DATEADD(hour, 0, i.BirthDate)</code> is still present.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p><code>AccountType</code> (Single/Multiple TINs Individual) -&gt; maps to <code>&lt;AccountHolder&gt;&lt;Individual&gt;</code>.</p></li><li><p><code>AccountType</code> ('Foreign Controlling Individual'): This is the tricky one. If the <em>account itself</em> (e.g., held by a minor) is US reportable, then that account holder (the minor) is reported. The &quot;Foreign Controlling Individual&quot; (e.g., guardian) data would be part of due diligence but might not appear as a separate FATCA reportable person unless the guardian <em>also</em> holds an account or is a CP of an entity. If this SP intends to report the <em>guardian</em> as an account holder for the minor's account, that's a specific interpretation.</p></li><li><p>All individual detail fields (Name, Address, TINs, BirthInfo, ResCountryCodes) map directly to <code>&lt;AccountHolder&gt;&lt;Individual&gt;...&lt;/Individual&gt;</code>.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p><code>AccountType</code> logic tries to make sense of complex CRM roles.</p></li><li><p>Reliance on <code>dsl_BeneficialOwner</code> flag being correct for identifying the primary owner vs. a controlling non-owner. If a true owner is <em>not</em> flagged <code>dsl_BeneficialOwner=1</code> but has a controlling role, they might be miscategorized.</p></li><li><p>If a US Individual Account Holder's TIN is missing from CRM, they will still be included here if <code>USCitizensforTaxPurposes_ind=1</code> (due to later filters in Step 6 for <code>AccountType</code>), but their <code>cip_Identification</code> will be NULL. The XML generation step will then need to handle missing TINs (e.g., by providing DOB and using appropriate explanation codes if allowed by IRS). This is better than Step 4's hard filter on CP TINs.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Now we're looking at accounts owned directly by PEOPLE (not companies).</p></li><li><p><strong>Section A (Who is this person account for?):</strong> The person's ID (<code>AccountID</code>), the account's name (usually the person's name).</p></li><li><p>What <code>AccountType</code> is it?</p><ul><li><p>'Foreign Controlling Individual': This is rare. It's like if your Dad (who's foreign) has control over <em>your</em> bank account, and <em>your</em> account needs reporting. We note your Dad's foreign control.</p></li><li><p>'Multiple TINs Individual': The person has more than one foreign tax number.</p></li><li><p>'Single TIN Individual': The person has one foreign tax number.</p></li></ul></li><li><p>What kind of account is it (<code>TradingEntityType</code>)? Like 'Individual' or 'Joint'.</p></li><li><p>(Other details like account balance, open/close dates are similar to company accounts).</p></li><li><p><strong>Section H (Tax Numbers):</strong></p><ul><li><p>Company tax numbers are blank here, because it's a person's account.</p></li><li><p>We list the PERSON'S foreign tax number(s) (<code>cip_Identification</code>).</p></li></ul></li><li><p>(Other person details like name, address, birthday are similar to before, but this time they describe the <em>account owner</em>).&quot;</p></li></ul></li></ul><hr/><p><strong>Step 5.3: </strong><code>#IndividualData</code> CTE - FROM, JOINs, and WHERE clause</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">FROM [DynamicsPROD].[CRM_MSCRM].dbo.Account AS a
INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.dsl_roles AS r ON a.AccountId = r.dsl_TradingEntityID AND r.statuscode = 1
    AND (
        r.dsl_BeneficialOwner = 1 
        OR ( 
            r.dsl_BeneficialOwner &lt;&gt; 1 AND
            r.dsl_RoleTypeIdName IN (&#39;Authorised Person&#39;, ..., &#39;Executor&#39;) AND r.dsl_Authorised = 1
           )
        )
INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.Contact AS i ON i.ContactId = r.dsl_IndividualId
INNER JOIN [DynamicsPROD].[CRM_MSCRM].dbo.dsl_portfolioservice AS ps ON ps.dsl_TradingEntityId = a.AccountId
	-- Portfolio filters (same as Step 4)
-- ... LEFT JOINs (StringMap, ft2, cc2, #TaxRegimeMapping, #TIN_Counts) ...
WHERE 1=1
    AND (ft2.statecode = 0 OR ft2.statecode IS NULL) -- Active individual tax record
    AND ISNULL(cc2.cip_ISOCode, &#39;&#39;) &lt;&gt; &#39;NZL&#39; -- Exclude if individual&#39;s TIN is solely NZ.
    -- AND NOT (sm.Value = &#39;Trust&#39; ...) -- This was in original but sm.Value for #IndividualData is filtered to Indiv/Joint/Minor later. Redundant here.
    AND sm.Value &lt;&gt; &#39;Estate Winding-Up&#39; 
    AND ft2.cip_CountryJurisdiction IS NOT NULL AND ft2.cip_Identification IS NOT NULL -- Individual must have a recorded foreign TIN.
    AND sm.Value IN (&#39;Individual&#39;, &#39;Joint&#39;, &#39;Minor Under 18 yrs&#39;) -- Account type must be individual-based.
    AND trm.TaxRegime NOT IN (&#39;CRS (Individual) &amp; FATCA (Entity)&#39;, ...) -- Exclude CRM data errors.
    AND (i.dsl_USCitizensforTaxPurposes = 1 OR i.ots_foreigntaxresident = 1) -- Individual must have US indicia or be foreign tax resident.
	-- Portfolio value/status filters (same as Step 4, but applied to Account-level value &#39;a.dsl_TotalHoldingsValue&#39;)</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><strong>Role Join Condition:</strong></p><ul><li><p><code>r.dsl_BeneficialOwner = 1</code>: Gets the actual owners.</p></li><li><p><code>OR (r.dsl_BeneficialOwner &lt;&gt; 1 AND r.dsl_RoleTypeIdName IN (...) AND r.dsl_Authorised = 1)</code>: This is the logic to pick up the &quot;Foreign Controlling Individual&quot; type if they are not owners but have specific authorized roles.</p></li></ul></li><li><p><strong>Portfolio Join and Filters:</strong> Same as in Step 4, ensuring the individual account has an active, relevant portfolio.</p></li><li><p><code>LEFT JOIN #TIN_Counts tc</code>: Used for the <code>AccountType</code> classification.</p></li><li><p><code>WHERE</code> Clause:</p><ul><li><p><code>ISNULL(cc2.cip_ISOCode, '') &lt;&gt; 'NZL'</code>: Correctly excludes if <em>only</em> TIN is NZ.</p></li><li><p><code>ft2.cip_CountryJurisdiction IS NOT NULL AND ft2.cip_Identification IS NOT NULL</code>: <strong>This is a critical filter, same as in Step 4 but now for the direct Individual Account Holder.</strong> It means an individual account holder will <em>only</em> be included in <code>#IndividualData</code> if they have a recorded foreign TIN.</p><ul><li><p>This again risks under-reporting US persons whose US TIN is simply missing from CRM but other US indicia (citizenship flag + DOB) exist. FATCA IDES 2.0 allows reporting US persons with missing TINs if DOB is provided and specific reason codes are used. This SP currently filters them out at this stage if their foreign TIN isn't in <code>ft2</code>.</p></li></ul></li><li><p><code>sm.Value IN ('Individual', 'Joint', 'Minor Under 18 yrs')</code>: Correctly scopes this CTE to individual-type accounts.</p></li><li><p><code>(i.dsl_USCitizensforTaxPurposes = 1 OR i.ots_foreigntaxresident = 1)</code>: Ensures the individual account holder has US/foreign indicia. This is good.</p></li><li><p>The final portfolio value/status filters on <code>a.dsl_TotalHoldingsValue</code> are still present, same concern about potential conflict/redundancy with <code>ps.dsl_TotalHoldingsValue</code> filters in the join.</p></li></ul></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>The filters determine which Individual Account Holders are provisionally reportable.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>The <code>OR</code> in the role join tries to catch different CRM representations of control/ownership.</p></li><li><p>The hard filter on <code>ft2.cip_Identification IS NOT NULL</code> for the account holder is a strong stance against missing TIN data. If the business policy is &quot;no foreign TIN in CRM = no report for this step&quot;, then it's correct. If policy allows reporting US persons with missing TINs using DOB, this filter is too restrictive here.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;How do we find these people's accounts?</p></li><li><p>We look for roles where the person is an 'Owner' (<code>dsl_BeneficialOwner = 1</code>).</p></li><li><p>OR, for that rare 'Foreign Controlling Individual' case, where they are <em>not</em> an owner but have an important authorized role.</p></li><li><p>The person's account must also have a 'sub-account' or 'portfolio' that's active and relevant (same checks as for company accounts).</p></li><li><p>Then, final checks before putting them in the <code>#IndividualData</code> box:</p><ul><li><p>Is their tax record active?</p></li><li><p>If their ONLY tax number is for New Zealand, probably not for this US report.</p></li><li><p><strong>Does the PERSON have a foreign tax number recorded? (Again, super important check!)</strong></p></li><li><p>Is the account type 'Individual', 'Joint', or 'Minor'? (Yes, for this box).</p></li><li><p>Does our 'secret decoder ring' give a sensible tax report type?</p></li><li><p>Is the person themselves flagged as a US citizen or foreign tax resident? (Yes, they must be).</p></li><li><p>(And the same last checks on 'Pending Closure' or 'Closed' accounts with zero balance for the whole account).&quot;</p></li></ul></li></ul></li></ul><hr/><p>Step 5 is crucial for direct individual account holders. The recurring theme is the hard dependency on a foreign TIN being present in <code>cip_foreigntaxrecord</code>. This is a major policy decision embedded in the code. If this can be relaxed (e.g., for US Persons, allow reporting with DOB if TIN is missing and Citizenship flag is Yes), the <code>WHERE</code> clauses for <code>ft2.cip_Identification</code> would need adjustment, likely moving that check to the final <code>SELECT</code> into the staging table with <code>CASE</code> logic or handling it in the XML generation phase.</p><p>Next, Step 6, the grand finale of combining and filtering.</p><hr/><p><strong>Part 6: Step 6 (Combine, Final Filter, Output)</strong></p><hr/><p><strong>Step 6: </strong><code>#crmdatafatcacrs</code> (Combine and Initial Filter) &amp; <code>#crmdatafatcacrsDedup</code> (Deduplicate)</p><p><strong>Step 6.1: </strong><code>CombinedData</code> CTE (UNION ALL)</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">IF OBJECT_ID(&#39;tempdb..##crmdatafatcacrs&#39;) IS NOT NULL DROP TABLE ##crmdatafatcacrs; 
;WITH CombinedData AS (
    SELECT AccountType, AccountID, IndividualId, ..., Regime -- All columns from #EntityData
    FROM #EntityData
    UNION ALL
    SELECT AccountType, AccountID, IndividualId, ..., Regime -- All columns from #IndividualData
    FROM #IndividualData
)
SELECT *
INTO ##crmdatafatcacrs 
FROM CombinedData
WHERE 1 = 1
    -- ... followed by extensive WHERE clause filters ...</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><code>UNION ALL</code>: Correctly combines the two streams:</p><ol start="1"><li><p><code>#EntityData</code>: Represents an Entity as AccountHolder, with a linked Individual (potential Controlling Person).</p></li><li><p><code>#IndividualData</code>: Represents an Individual as AccountHolder.</p></li></ol></li><li><p>The column lists in the <code>SELECT</code> from <code>#EntityData</code> and <code>#IndividualData</code> must match in number, order, and be implicitly convertible in data type for <code>UNION ALL</code> to work. This was ensured by making the structures of <code>#EntityData</code> and <code>#IndividualData</code> very similar (e.g., blanking out <code>EntityTIN</code> in <code>#IndividualData</code>).</p></li><li><p><code>##crmdatafatcacrs</code>: Using a global temporary table. For processes confined to one SP execution, a local temp table (<code>#</code>) is generally safer to avoid session conflicts and ensure cleanup. If this <code>##</code> table is <em>intentionally</em> read by another process <em>outside</em> this SP but <em>within the same session context</em> before the session ends, then <code>##</code> is needed. Otherwise, <code>#</code> is preferred. Given the final step populates a permanent table, <code>#</code> should be sufficient.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>This CTE brings together all potential <code>AccountReport</code> candidates. Each row here will either become an <code>&lt;AccountHolder&gt;&lt;Organisation&gt;</code> (with potential <code>&lt;ControllingPerson&gt;</code>s derived from the <code>IndividualId</code> fields) or an <code>&lt;AccountHolder&gt;&lt;Individual&gt;</code>.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>The structuring of <code>#EntityData</code> and <code>#IndividualData</code> to be union-compatible, despite their different conceptual sources, is a way to manage complexity.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Now we take our two boxes of prepared files:</p><ol start="1"><li><p><code>#EntityData</code>: Files for COMPANY accounts (with details of important PEOPLE linked to them).</p></li><li><p><code>#IndividualData</code>: Files for PEOPLE'S accounts.</p></li></ol></li><li><p>We dump all these files together into one big pile called <code>##crmdatafatcacrs</code>. It's a temporary pile.</p></li><li><p>The <code>UNION ALL</code> just means stack them up; we'll sort out duplicates later if any look <em>exactly</em> the same after all this.&quot;</p></li></ul></li></ul><hr/><p><strong>Step 6.2: </strong><code>WHERE</code> Clause Filters on <code>CombinedData</code></p><p>This is the <strong>MAIN</strong> filtering stage. I'll group related filters.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">-- PortfolioServiceStatus Filtering (Account Closure/Activity)
AND (
    (PortfolioServiceStatus NOT IN (&#39;Closed&#39;) ) 
    OR 
    (PortfolioServiceStatus IN (&#39;Closed&#39;, &#39;Pending Closure&#39;) 
        AND dsl_CloseDate BETWEEN @PeriodStartDate AND @PeriodEndDate 
        AND (dsl_inceptiondate IS NULL OR dsl_inceptiondate &lt;= @PeriodEndDate)
    )
)
AND NOT (PortfolioServiceStatus = &#39;Closed&#39; AND dsl_CloseDate IS NULL) </pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p>Logic:</p><ol start="1"><li><p>Keep if NOT 'Closed'.</p></li><li><p>OR Keep if 'Closed' or 'Pending Closure' AND was closed within the reporting period AND was opened before the end of the reporting period.</p></li><li><p>THEN, explicitly exclude if 'Closed' but <code>dsl_CloseDate</code> is NULL (data quality issue).</p></li></ol></li><li><p>This seems robust for handling account lifecycle for reporting. An account closed <em>during</em> the period is reportable for that period. An account closed <em>before</em> the period is not.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>Determines if an <code>&lt;AccountReport&gt;</code> is needed for this <code>&lt;ReportingPeriod&gt;</code>.</p></li><li><p>If <code>PortfolioServiceStatus</code> is 'Closed' and it passes this filter, then <code>&lt;ClosedAccount&gt;true&lt;/ClosedAccount&gt;</code> might be set in the XML.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>The <code>NOT (PortfolioServiceStatus = 'Closed' AND dsl_CloseDate IS NULL)</code> directly targets inconsistent CRM data.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;From our big pile, we only keep files for accounts that were:</p><ul><li><p>Open and active.</p></li><li><p>OR, if they were closed, they must have been closed <em>during the tax year we care about</em>. (If closed long ago, we don't need them).</p></li><li><p>BUT, if a file says 'Closed' but forgets to say <em>when</em> it was closed, we ignore it (it's bad data).&quot;</p></li></ul></li></ul></li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">-- Exclude Financial Institutions (FIs) as AccountHolders
AND (dsl_finffe IS NULL OR dsl_finffe != &#39;FI&#39;)

-- Exclude Active NFFEs established in NZ (if they have no US controlling persons - this part is implicit, as US CPs would make it FATCA relevant)
AND (
    OrgPrimaryTaxDomicile IS NULL 
    OR OrgPrimaryTaxDomicile != &#39;New Zealand&#39; 
    OR PassiveActive IS NULL 
    OR PassiveActive != &#39;Active&#39;
)

AND TradingEntityType &lt;&gt; &#39;Estate Winding-Up&#39; </pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><code>dsl_finffe != 'FI'</code>: Correctly excludes other FIs from being reported as &quot;AccountHolders&quot; by this ReportingFI. (FFIs report their <em>own</em> account holders). This assumes <code>dsl_finffe</code> accurately identifies FIs.</p></li><li><p>Active NFFE Exclusion: <code>EXCLUDES if (OrgPrimaryTaxDomicile = 'New Zealand' AND PassiveActive = 'Active')</code>. This is a common carve-out for purely domestic, active businesses that pose low FATCA risk, <em>unless</em> they have US owners/CPs. The &quot;unless&quot; part is handled by the <code>Regime</code> and <code>AccountType</code> filters later – if such an entity <em>did</em> have US CPs making it <code>FATCA_CRS</code> relevant, it would still pass <em>this specific</em> filter line and then be caught by other criteria. This filter is for entities that are NZ Active NFFEs and have <em>no other reason</em> to be FATCA reported by <em>this</em> FI.</p></li><li><p><code>TradingEntityType &lt;&gt; 'Estate Winding-Up'</code>: Specific business rule.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p><code>dsl_finffe</code> influences <code>&lt;FATCAEntityType&gt;</code>.</p></li><li><p>Active NFFE status influences due diligence and whether CP reporting is mandatory.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>Relies on <code>dsl_finffe</code>, <code>OrgPrimaryTaxDomicile</code>, and <code>PassiveActive</code> being correctly set in CRM.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;More filtering on our big pile:</p><ul><li><p>If the account holder is another bank or financial company (<code>dsl_finffe = 'FI'</code>), we usually don't report them in <em>this</em> report (they do their own).</p></li><li><p>If it's a regular New Zealand company (<code>OrgPrimaryTaxDomicile = 'New Zealand'</code>) that's actively doing business (<code>PassiveActive = 'Active'</code>), we <em>might</em> not need to report it for US tax <em>unless</em> it has US owners/controllers (we check that later).</p></li><li><p>If it's an 'Estate Winding-Up', we ignore it.&quot;</p></li></ul></li></ul></li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">-- Exclude Non-Reportable Portfolios based on service level and regime
AND (
    (Regime = &#39;FATCA&#39; AND ISNULL(PortfolioServiceLevelName, &#39;&#39;) NOT IN (... &#39;Craigs KiwiSaver&#39; ...))
    OR 
    (Regime IN (&#39;CRS&#39;, &#39;FATCA_CRS&#39;) AND ISNULL(PortfolioServiceLevelName, &#39;&#39;) NOT IN (... &#39;QuayStreet KiwiSaver Scheme&#39; ...))
)</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p>This implements product-specific exclusions. Certain investment products (like some domestic retirement schemes) can be non-reportable or subject to simplified regimes under FATCA/CRS.</p></li><li><p>The list of <code>PortfolioServiceLevelName</code> values needs to be accurate and maintained.</p></li><li><p><code>ISNULL(..., '')</code> handles NULL service level names.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>This directly determines if an account (represented by this portfolio service level) is excluded.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>If a reportable product is mislabeled in CRM with an excluded <code>PortfolioServiceLevelName</code>, it would be wrongly excluded. Accuracy of this CRM field is key.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Some types of accounts (like certain KiwiSaver retirement accounts) don't need to be in the US tax report.</p></li><li><p>If the file is for one of those specific account types (<code>PortfolioServiceLevelName</code>), we remove it from the pile.&quot;</p></li></ul></li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">-- Final AccountType and Regime Filtering
AND (
    (AccountType IN (&#39;Layered Entity&#39;, &#39;Normal Entity&#39;) 
        AND Regime IN (&#39;FATCA&#39;, &#39;FATCA_CRS&#39;) 
        AND ISNULL(cip_Identification, &#39;&#39;) &lt;&gt; &#39;&#39; -- Individual (potential CP) linked to Entity must have a TIN.
    )
    OR 
    (AccountType IN (&#39;Multiple TINs Individual&#39;, &#39;Single TIN Individual&#39;,&#39;Foreign Controlling Individual&#39;)
        AND Regime IN (&#39;FATCA&#39;, &#39;FATCA_CRS&#39;) -- Implies individual themselves is US reportable
        AND ISNULL(cip_Identification, &#39;&#39;) &lt;&gt; &#39;&#39; -- Individual AccountHolder must have a TIN.
    )
)</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p>This is a <strong>MAJOR</strong> inclusion filter. A record must satisfy one of these OR conditions.</p></li><li><p><strong>Condition 1 (Entities):</strong></p><ul><li><p><code>AccountType IN ('Layered Entity', 'Normal Entity')</code>: It's an entity account holder.</p></li><li><p><code>Regime IN ('FATCA', 'FATCA_CRS')</code>: The tax regime (derived from root entity + individual flags) indicates FATCA relevance.</p></li><li><p><code>ISNULL(cip_Identification, '') &lt;&gt; ''</code>: This <code>cip_Identification</code> refers to the <strong>Individual's TIN</strong> (ft2) from <code>#EntityData</code> (the potential Controlling Person). This means an Entity account is only kept if its linked potential CP <em>has a recorded foreign TIN</em>. This re-enforces the strict TIN requirement for CPs seen in Step 4.</p></li></ul></li><li><p><strong>Condition 2 (Individuals):</strong></p><ul><li><p><code>AccountType IN ('Multiple TINs Individual', ...)</code>: It's an individual account holder (or a controlling non-owner).</p></li><li><p><code>Regime IN ('FATCA', 'FATCA_CRS')</code>: The tax regime (derived from account flags + individual flags) indicates FATCA relevance. This is somewhat redundant if <code>i.dsl_USCitizensforTaxPurposes = 1</code> was already a prerequisite in Step 5, but good for explicit clarity.</p></li><li><p><code>ISNULL(cip_Identification, '') &lt;&gt; ''</code>: This <code>cip_Identification</code> refers to the <strong>Individual Account Holder's TIN</strong> (ft2) from <code>#IndividualData</code>. This means an Individual account is only kept if the account holder <em>has a recorded foreign TIN</em>. This re-enforces the strict TIN requirement for direct individual account holders from Step 5.</p></li></ul></li><li><p><strong>Overall TIN Policy Impact:</strong> This final filter solidifies the policy: if the relevant individual (either CP of an Entity, or the Individual Account Holder themselves) does not have a non-blank <code>cip_Identification</code> (foreign TIN) in these records, the account is <strong>excluded</strong> from <code>##crmdatafatcacrs</code>. This is the primary point where records of US Persons with missing TINs (but other indicia like Citizenship + DOB) would be dropped if that TIN isn't in <code>ft2</code>.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>This is the gatekeeper for what gets into the staging table for FATCA XML.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>If a US Person's foreign TIN is missing from <code>cip_foreigntaxrecord</code> due to CRM error, they are excluded. This simplifies processing by avoiding missing TIN scenarios <em>later</em>, but at the cost of potential under-reporting if FATCA allows reporting them with DOB/explanation.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Almost done with the big pile! Two main reasons to KEEP a file:</p><ol start="1"><li><p><strong>It's a COMPANY account (</strong><code>AccountType</code> = 'Layered Entity' or 'Normal Entity'):</p><ul><li><p>AND our decoder ring says it's for the US Tax report (<code>Regime</code> = 'FATCA' or 'FATCA_CRS').</p></li><li><p>AND the important PERSON linked to that company HAS a foreign tax number written down.</p></li></ul></li><li><p><strong>OR, It's a PERSON'S account (</strong><code>AccountType</code> = '...Individual...'):</p><ul><li><p>AND our decoder ring says it's for the US Tax report.</p></li><li><p>AND that PERSON themselves HAS a foreign tax number written down.</p></li></ul></li></ol></li><li><p>If a file doesn't meet one of these, it's removed from the pile.&quot;</p></li></ul></li></ul><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">-- Standard Broking Service Exclusion
AND NOT (
    PortfolioServiceLevelName = &#39;Standard Broking Service&#39;
    AND NOT EXISTS ( -- i.e., AND HAS NO Safe Custody holdings &gt; 0
        SELECT 1 FROM [AACARPTSRV].[fusion].[dbo].[Trn] t ... HAVING SUM(t.nominal) &gt; 0
    )
    AND NOT EXISTS ( -- i.e., AND HAS NO associated Cash Management account
        SELECT 1 FROM CombinedData c2 WHERE ... c2.PortfolioServiceLevelName = &#39;Cash Management&#39;
    )
)</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p>Logic: Excludes &quot;Standard Broking Service&quot; (SBS) accounts UNLESS they (A) have safe custody holdings &gt; 0 OR (B) have an associated Cash Management account.</p></li><li><p>So, <code>NOT (SBS AND NOT A AND NOT B)</code> becomes <code>(NOT SBS) OR A OR B</code>. This means keep if:</p><ul><li><p>Not an SBS account.</p></li><li><p>OR Is an SBS account AND has Safe Custody holdings.</p></li><li><p>OR Is an SBS account AND has an associated Cash Management account.</p></li></ul></li><li><p>This is a complex but specific business rule to only report SBS accounts with tangible activity or related cash components.</p></li><li><p>The subqueries to <code>[AACARPTSRV].[fusion].[dbo].[Trn]</code> and <code>CombinedData</code> (self-referencing the CTE) are okay. The <code>fusion</code> join assumes that database is accessible and <code>d.code</code> correctly links to <code>PortfolioNo</code>. Collation on <code>d.code = CombinedData.PortfolioNo</code> might be needed if they differ (<code>COLLATE DATABASE_DEFAULT</code> was in original description but not in this final <code>WHERE</code> block's code for this subquery - ensure it's there if needed or that collations match).</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>Excludes certain low-activity brokerage accounts.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>Relies on <code>PortfolioServiceLevelName</code> being accurate and underlying <code>fusion</code> data for holdings being correct.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;One last special rule for 'Standard Broking Service' accounts:</p></li><li><p>We normally EXCLUDE these.</p></li><li><p>BUT, we KEEP them IF:</p><ul><li><p>They are holding some investments for the customer in 'Safe Custody'.</p></li><li><p>OR, if there's a 'Cash Management' account linked to this same customer and tax report type.</p></li></ul></li><li><p>Otherwise, plain 'Standard Broking Service' accounts are removed.&quot;</p></li></ul></li></ul><hr/><p><strong>Step 6.3: Deduplication into </strong><code>##crmdatafatcacrsDedup</code></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">IF OBJECT_ID(&#39;tempdb..##crmdatafatcacrsDedup&#39;) IS NOT NULL DROP TABLE ##crmdatafatcacrsDedup;
;WITH A AS (
    SELECT *, PortfolioNo + &#39; &#39; + PortfolioServiceLevelName + &#39; &#39; + cip_Identification AS PK
    FROM ##crmdatafatcacrs
),
Dedup AS (
    SELECT *, ROW_NUMBER() OVER (PARTITION BY PK ORDER BY (SELECT NULL)) AS rn 
    FROM A
)
SELECT *
INTO ##crmdatafatcacrsDedup
FROM Dedup
WHERE rn = 1;</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><code>PK = PortfolioNo + ' ' + PortfolioServiceLevelName + ' ' + cip_Identification</code>: This defines a unique key for a reportable instance. It means one report per individual TIN per unique portfolio product.</p><ul><li><p><code>cip_Identification</code> is the individual's TIN (either CP or Account Holder). If this is NULL/blank due to earlier logic (e.g., if the strict TIN filter was relaxed), this PK might not be unique or might group NULLs. But given the strict TIN filters, <code>cip_Identification</code> should be populated here.</p></li></ul></li><li><p><code>ROW_NUMBER() OVER (PARTITION BY PK ORDER BY (SELECT NULL))</code>: Standard way to deduplicate in SQL Server 2005+. <code>ORDER BY (SELECT NULL)</code> gives an arbitrary but consistent row for <code>rn=1</code> within each PK group (in absence of other unique columns to order by for determinism, which is fine for de-duping).</p></li><li><p><code>##crmdatafatcacrsDedup</code>: Again, consider <code>#</code> if scope allows.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>Ensures that the same individual related to the same specific account isn't reported multiple times due to CRM data path duplications that survived earlier <code>DISTINCT</code>s.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>Catches duplicates that might arise from complex joins or slightly varied source records in CRM that resolve to the same reportable facts.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Sometimes, after all our work, we might accidentally have a few files in our pile that are <em>exactly identical</em> for reporting purposes (same person, same account, same tax number).</p></li><li><p>This step quickly checks for these perfect copies.</p></li><li><p>It makes a unique 'label' for each file based on: Account Number + Account Type + Person's Tax Number.</p></li><li><p>If it finds multiple files with the exact same label, it keeps only one and throws away the extras.</p></li><li><p>The cleaned-up pile is now <code>##crmdatafatcacrsDedup</code>.&quot;</p></li></ul></li></ul><hr/><p><strong>Step 6.4: ISO Country Code Correction into </strong><code>##crmdatafatcacrsiso</code></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">IF OBJECT_ID(&#39;tempdb..##crmdatafatcacrsiso&#39;) IS NOT NULL DROP TABLE ##crmdatafatcacrsiso;
SELECT DISTINCT cr.*,
    ISNULL(etc.ISOCode,&#39;XX&#39;) AS EntityTaxCodeCountryISOShort, 
	ISNULL(itc.ISOCode,&#39;XX&#39;) AS Ind_TaxCodeCountryISOShort,   
    ISNULL(crf.ISOCode, &#39;XX&#39;) AS [Res Country Code],          
    ISNULL(pf.ISOCode, &#39;XX&#39;) AS [Postal Country Code],       
    ISNULL(cb.ISOCode, &#39;XX&#39;) AS [Country of Birth]           
INTO ##crmdatafatcacrsiso
FROM ##crmdatafatcacrsDedup cr
LEFT JOIN [SQLUAT].[DataServices].FATCA.CountryReference etc ON UPPER(etc.Country) = UPPER(LTRIM(RTRIM(cr.[EntityCountryJurisdictionName])))
-- ... other joins for other country fields ...</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p><strong>Purpose:</strong> Converts descriptive country names from CRM (e.g., &quot;United States of America&quot;, &quot;AUSTRALIA&quot;) into the 2-letter ISO 3166-1 alpha-2 codes required by FATCA XML (e.g., &quot;US&quot;, &quot;AU&quot;).</p></li><li><p><code>[SQLUAT].[DataServices].FATCA.CountryReference</code>: External dependency. This table must be accurate and comprehensive.</p></li><li><p><code>LEFT JOIN ... ON UPPER(etc.Country) = UPPER(LTRIM(RTRIM(cr.[FieldName])))</code>: Robust join logic, handling case differences and leading/trailing spaces in CRM country names.</p></li><li><p><code>ISNULL(..., 'XX')</code>: Good practice. If a country name from CRM isn't found in the reference table, it's flagged as 'XX'. This allows the process to continue but highlights data quality issues needing investigation. 'XX' is not a valid ISO code and would cause XML schema validation failure if submitted.</p></li><li><p><code>DISTINCT cr.*, ...</code>: The <code>SELECT DISTINCT</code> here is interesting. If <code>##crmdatafatcacrsDedup</code> was truly unique by its PK, and the country reference table provides a one-to-one mapping for country names, then <code>DISTINCT</code> might not be strictly necessary unless the country reference table itself could cause a fan-out (e.g., same CRM country name mapping to multiple ISO codes, which would be bad reference data). If <code>##crmdatafatcacrsDedup</code> is guaranteed unique by the previous step's PK, <code>DISTINCT</code> may be an unnecessary overhead unless there's a specific reason for it related to the reference table. However, it's safe.</p></li><li><p><code>##crmdatafatcacrsiso</code>: Again, consider <code>#</code>.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>This directly produces the values for <code>&lt;Address&gt;&lt;CountryCode&gt;</code>, <code>&lt;TIN issuedBy=&quot;...&quot;&gt;</code>, <code>&lt;BirthInfo&gt;&lt;CountryInfo&gt;&lt;CountryCode&gt;</code>, and <code>&lt;ResCountryCode&gt;</code>.</p></li></ul></li><li><p><strong>Human Error Mitigation:</strong></p><ul><li><p>Standardizes messy country name data from CRM.</p></li><li><p>The 'XX' highlights unmapped countries, which are data errors in CRM or omissions in the reference table.</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;The tax report needs country codes to be very specific: just two letters (like 'US' for United States, 'AU' for Australia).</p></li><li><p>Our customer files might have the full country name, or nicknames, or typos.</p></li><li><p>This step uses a 'Country Dictionary' (<code>CountryReference</code> table).</p></li><li><p>For every country name in our files (like Home Address Country, Tax Number Country, Birth Country), it looks it up in the dictionary and gets the proper 2-letter code.</p></li><li><p>If it can't find a country in the dictionary, it writes 'XX' – that means 'Oops, we need to fix this country name later!'</p></li><li><p>The pile with corrected country codes is <code>##crmdatafatcacrsiso</code>.&quot;</p></li></ul></li></ul><hr/><p><strong>Step 6.5: Output to Final Staging Table </strong><code>FATCA.Stage_crmdatafatcacrs_jf</code></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">IF OBJECT_ID(&#39;FATCA.Stage_crmdatafatcacrs_jf&#39;, &#39;U&#39;) IS NOT NULL
BEGIN
    DROP TABLE FATCA.Stage_crmdatafatcacrs_jf;
END
SELECT 
    @rptYear as ReportYear, 
    *
INTO FATCA.Stage_crmdatafatcacrs_jf
FROM ##crmdatafatcacrsiso;</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p>Standard <code>DROP TABLE / SELECT INTO</code> pattern for creating/populating the final staging table for this SP's scope.</p></li><li><p><code>@rptYear as ReportYear</code>: Adds the reporting year context to every row, good for partitioning or filtering in subsequent processes.</p></li><li><p>The schema of <code>FATCA.Stage_crmdatafatcacrs_jf</code> is implicitly defined by the columns in <code>##crmdatafatcacrsiso</code>.</p></li></ul></li><li><p><strong>FATCA IDES 2.0 Mapping:</strong></p><ul><li><p>This table is the direct source for the next process that will generate the FATCA XML. Each row here should correspond to one <code>&lt;AccountReport&gt;</code> (potentially with <code>&lt;ControllingPerson&gt;</code> sub-elements).</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;Finally! We take our super-cleaned-up pile (<code>##crmdatafatcacrsiso</code>) and save it into a permanent storage table called <code>FATCA.Stage_crmdatafatcacrs_jf</code>.</p></li><li><p>We also add the <code>ReportYear</code> (like '2025') to every file in this permanent table, so we know which year it's for.</p></li><li><p>This table is now ready for the next step: actually building the official tax report XML file.&quot;</p></li></ul></li></ul><hr/><p><strong>Step 6.6: Cleanup Temporary Tables</strong></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: sql; gutter: false; theme: Confluence" data-theme="Confluence">IF OBJECT_ID(&#39;tempdb..#TaxRegimeMapping&#39;) IS NOT NULL DROP TABLE #TaxRegimeMapping;
-- ... drops all # and ## tables used ...
IF OBJECT_ID(&#39;tempdb..##crmdatafatcacrsiso&#39;) IS NOT NULL DROP TABLE ##crmdatafatcacrsiso;</pre>
</div></div><ul><li><p><strong>Audit (30yr Dev):</strong></p><ul><li><p>Good practice to explicitly drop temporary tables, especially global ones (<code>##</code>). Local ones (<code>#</code>) are dropped automatically when the SP scope ends, but explicit drops don't hurt and can be useful if the SP is complex or has conditional execution paths (though not the case here for drops).</p></li></ul></li><li><p><strong>Simplification (High School Learner):</strong></p><ul><li><p>&quot;We clean up our workspace by throwing away all the temporary piles and lists we made along the way. We only keep the final permanent table.&quot;</p></li></ul></li></ul><hr/><p><strong>Overall Audit Summary &amp; Key Concerns/Recommendations for FATCA IDES 2.0:</strong></p><ol start="1"><li><p><strong>TIN Availability Policy (CRITICAL):</strong></p><ul><li><p>The SP currently <strong>filters out</strong> (excludes) Entity CPs and Individual Account Holders if their foreign TIN is not present in <code>ft2.cip_identification</code> (Steps 4 &amp; 5 WHERE clauses, reinforced in Step 6's main <code>CombinedData</code> filter).</p></li><li><p><strong>FATCA IDES 2.0 Impact:</strong> The IRS generally requires TINs for US Persons. However, if a TIN is unavailable after &quot;reasonable efforts,&quot; reporting is still required using the individual's Date of Birth. Specific codes are used in the XML schema's <code>TIN</code> element (e.g., <code>issuedBy</code> and value might be blank, or a specific string like &quot;NOTIN&quot; or &quot;APPLIEDFOR&quot; if HCTA allows, or rely on <code>BirthInfo</code> when TIN is absent and no specific placeholder string is used for TIN value).</p></li><li><p><strong>Recommendation:</strong></p><ul><li><p><strong>Clarify Business Policy:</strong> Is it acceptable to <em>not report</em> a known US Person (e.g., <code>USCitizensforTaxPurposes_ind = 1</code>) if their US TIN is simply missing from CRM? This is likely an <strong>under-reporting risk.</strong></p></li><li><p><strong>Potential Code Change:</strong> If US Persons with missing TINs <em>must</em> be reported, the filters <code>AND ft2.cip_Identification IS NOT NULL</code> (or <code>ISNULL(cip_Identification, '') &lt;&gt; ''</code>) need to be relaxed or made conditional.</p><ul><li><p>For US Persons (<code>USCitizensforTaxPurposes_ind = 1</code> or US <code>Ind_TaxCodeCountryISOShort</code>): Allow them through even if TIN is missing, provided <code>DOB</code> is present. The XML generation stage would then handle the missing TIN logic (e.g., provide <code>&lt;BirthInfo&gt;</code>).</p></li><li><p>For Non-US Persons relevant for FATCA (e.g., foreign CP of a US-owned Passive NFFE): The TIN requirement might be stricter.</p></li></ul></li><li><p>This change would primarily affect the <code>WHERE</code> clauses in Steps 4, 5, and the main filter in Step 6.</p></li></ul></li></ul></li><li><p><strong>Date of Birth (DOB) Formatting and Timezone:</strong></p><ul><li><p>The <code>CONVERT(VARCHAR(10), DATEADD(hour, 0, i.BirthDate), 101)</code> (originally <code>+13</code> hours) needs absolute clarity.</p><ul><li><p>If <code>i.BirthDate</code> in CRM is UTC: The <code>DATEADD(hour, 13, ...)</code> is likely an attempt to convert to NZ local time. FATCA XML expects <code>&lt;BirthDate&gt;</code> as <code>YYYY-MM-DD</code> local date.</p></li><li><p>If <code>i.BirthDate</code> in CRM is already local NZ time: No <code>DATEADD</code> for timezone is needed.</p></li><li><p><strong>Final Format:</strong> The output <code>DOB</code> column is MM/DD/YYYY. The XML requires <code>YYYY-MM-DD</code>. This conversion must happen either here or in the XML generation step. It's cleaner to stage it in the correct XML format if possible: <code>CONVERT(VARCHAR(10), [CorrectedTimezone_BirthDate], 120) AS DOB_XML</code>.</p></li></ul></li><li><p><strong>Recommendation:</strong> Verify <code>BirthDate</code> storage (UTC or local). Adjust <code>DATEADD</code> accordingly. Output <code>DOB</code> in <code>YYYY-MM-DD</code> format directly into <code>FATCA.Stage_crmdatafatcacrs_jf</code>.</p></li></ul></li><li><p><strong>Currency for </strong><code>&lt;AccountBalance&gt;</code>:</p><ul><li><p><code>Acc_HoldingsValue</code> and <code>ps_HoldingsValue</code> are selected, but the currency code (e.g., &quot;NZD&quot;, &quot;USD&quot;) is missing. FATCA XML requires <code>&lt;AccountBalance currency=&quot;XXX&quot;&gt;</code>.</p></li><li><p><strong>Recommendation:</strong> Add a column for currency to <code>FATCA.Stage_crmdatafatcacrs_jf</code>. This might come from <code>Account</code> or <code>PortfolioService</code> tables in CRM, or be a default.</p></li></ul></li><li><p><strong>Mapping </strong><code>dsl_RoleTypeIdName</code> to FATCA <code>&lt;CtrlgPersonType&gt;</code>:</p><ul><li><p>The <code>dsl_RoleTypeIdName</code> (e.g., 'Director', 'Trustee') needs to be mapped to the OECD CPTY enum values for FATCA (e.g., <code>CPTY01</code>, <code>CPTY04</code>). This mapping should occur either here or in the XML generation stage.</p></li><li><p><strong>Recommendation:</strong> Add a <code>ControllingPersonOECDType</code> column to <code>FATCA.Stage_crmdatafatcacrs_jf</code> populated via a <code>CASE</code> statement or lookup table based on <code>dsl_RoleTypeIdName</code>.</p></li></ul></li><li><p><strong>Global Temp Tables (</strong><code>##</code>):</p><ul><li><p>Consider changing <code>##crmdatafatcacrs</code>, <code>##crmdatafatcacrsDedup</code>, <code>##crmdatafatcacrsiso</code> to local temp tables (<code>#</code>) for better session isolation and automatic cleanup, unless there's a specific cross-session need (unlikely here).</p></li></ul></li><li><p><strong>&quot;Foreign Controlling Individual&quot; </strong><code>AccountType</code>:</p><ul><li><p>Clarify how this category is handled for FATCA XML. If Individual A (e.g., minor, US Person) holds the account, they are the <code>&lt;AccountHolder&gt;</code>. If Individual B (e.g., guardian, foreign) controls it, B's details are for due diligence/AML. B isn't typically a separate FATCA reportable <em>AccountHolder</em> or <em>ControllingPerson of A's individual account</em> for FATCA. This category might be generating rows that are not directly translatable to a standard FATCA <code>AccountReport</code> structure without specific interpretation.</p></li></ul></li><li><p><strong>Clarity of Account vs. Portfolio Holdings Filters (Step 4 &amp; 5 WHERE clause):</strong></p><ul><li><p>The final two portfolio filters in Step 4 and 5 (<code>AND NOT (smPS.value = 'Pending Closure' AND (a.dsl_TotalHoldingsValue = 0 ...))</code>) use <code>a.dsl_TotalHoldingsValue</code> (Account level). The <code>INNER JOIN</code> to <code>ps</code> used <code>ps.dsl_TotalHoldingsValue</code> (Portfolio level).</p></li><li><p>If <code>a.dsl_TotalHoldingsValue</code> is a reliable real-time aggregate of its constituent portfolios, this is fine as an extra check. If not, it could lead to confusion or incorrect exclusions if, say, one portfolio is fine but the stale Account-level aggregate is zero.</p></li><li><p><strong>Recommendation:</strong> Ensure <code>a.dsl_TotalHoldingsValue</code> is reliable or consider removing this potentially redundant/conflicting filter if the portfolio-level join conditions are sufficient.</p></li></ul></li><li><p><strong>Error Handling for </strong><code>EXEC [dbo].[spr_AEOI_Financials]</code>:</p><ul><li><p>In SQL 2008, check <code>@@ERROR</code> immediately after the <code>EXEC</code> if that SP can fail and affect downstream logic. (In newer SQL, <code>TRY...CATCH</code> is better).</p></li></ul></li></ol><p>This detailed audit highlights the procedure's strengths in handling complex CRM data and its clear structure. The primary concern for FATCA IDES 2.0 compliance revolves around the strict TIN availability policy and ensuring all necessary data elements (like currency, correctly formatted dates, OECD type codes) are staged for straightforward XML generation. Addressing the TIN policy is paramount to avoid potential under-reporting of US Persons.</p>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 18-08-25 20:53</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
