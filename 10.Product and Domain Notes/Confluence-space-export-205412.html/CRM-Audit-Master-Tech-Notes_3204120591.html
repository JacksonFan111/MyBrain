<!DOCTYPE html>
<html>
    <head>
        <title>Jackson Fan : CRM Audit Master Tech Notes</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">Jackson Fan</a></span>
                            </li>
                                                    <li>
                                <span><a href="JF-Space-Overview_2554888272.html">JF Space Overview</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            Jackson Fan : CRM Audit Master Tech Notes
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                            
        
    
        
    
        
        
            Created by <span class='author'> Jackson Fan</span>, last modified on 23-06-25
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <style type='text/css'>/*<![CDATA[*/
div.rbtoc1755550429920 {padding: 0px;}
div.rbtoc1755550429920 ul {list-style: none;margin-left: 0px;}
div.rbtoc1755550429920 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='toc-macro rbtoc1755550429920'>
<ul class='toc-indentation'>
<li><a href='#CRMAuditMasterTechNotes-CRMAuditMasterScript–Super-DetailedGuideforHigh-SchoolStudents'>CRM Audit Master Script – Super-Detailed Guide for High-School Students</a>
<ul class='toc-indentation'>
<li><a href='#CRMAuditMasterTechNotes-1.StoryboardoftheWholeProcess'>1. Storyboard of the Whole Process</a></li>
<li><a href='#CRMAuditMasterTechNotes-2.MainIdeas&amp;WordsYouMustKnow'>2. Main Ideas &amp; Words You Must Know</a></li>
<li><a href='#CRMAuditMasterTechNotes-3.Section-by-SectionWalk-Through'>3. Section-by-Section Walk-Through</a></li>
<li><a href='#CRMAuditMasterTechNotes-4.Example:ReadingOneChangeinPlainEnglish'>4. Example: Reading One Change in Plain English</a></li>
<li><a href='#CRMAuditMasterTechNotes-5.TipsforRunning/DebuggingtheScriptYourself'>5. Tips for Running / Debugging the Script Yourself</a></li>
<li><a href='#CRMAuditMasterTechNotes-6.RecapCheatSheet'>6. Recap Cheat Sheet</a></li>
</ul>
</li>
<li><a href='#CRMAuditMasterTechNotes-DiggingDeeper—HowCRMStoresOneChangeandHowtheScriptDecodesIt'>Digging Deeper — How CRM Stores One Change and How the Script Decodes It</a>
<ul class='toc-indentation'>
<li><a href='#CRMAuditMasterTechNotes-1.WhataRawAuditRowReallyLooksLike'>1. What a Raw Audit Row Really Looks Like</a></li>
<li><a href='#CRMAuditMasterTechNotes-2.AttributeMask&amp;ChangeDataDecoding'>2. AttributeMask &amp; ChangeData Decoding</a></li>
<li><a href='#CRMAuditMasterTechNotes-3.ExamplesofCommonFieldTypes'>3. Examples of Common Field Types</a></li>
<li><a href='#CRMAuditMasterTechNotes-4.Single-FieldvsMulti-FieldUpdateWalk-Through'>4. Single-Field vs Multi-Field Update Walk-Through</a>
<ul class='toc-indentation'>
<li><a href='#CRMAuditMasterTechNotes-4.1Onefieldupdated(easy)'>4.1 One field updated (easy)</a></li>
<li><a href='#CRMAuditMasterTechNotes-4.2Twofieldsupdatedinonesave(ourearlierexample)'>4.2 Two fields updated in one save (our earlier example)</a></li>
</ul>
</li>
<li><a href='#CRMAuditMasterTechNotes-5.ActionCodesCheat-Sheet'>5. Action Codes Cheat-Sheet</a></li>
<li><a href='#CRMAuditMasterTechNotes-6.HowtheScriptHandles“Table,GUID”Oddities(Section10)'>6. How the Script Handles “Table,GUID” Oddities (Section 10)</a></li>
<li><a href='#CRMAuditMasterTechNotes-7.PuttingItAllTogether–TimelineofaRow'>7. Putting It All Together – Timeline of a Row</a></li>
<li><a href='#CRMAuditMasterTechNotes-8.PracticeChallenge'>8. Practice Challenge</a></li>
<li><a href='#CRMAuditMasterTechNotes-9.KeyTakeaways'>9. Key Takeaways</a></li>
</ul>
</li>
<li><a href='#CRMAuditMasterTechNotes-“ThinkingBigger”—HowDynamicsCRMBuildstheAuditTableinRealTime'>“Thinking Bigger” — How Dynamics CRM Builds the Audit Table in Real Time</a>
<ul class='toc-indentation'>
<li><a href='#CRMAuditMasterTechNotes-1TheDecision:“ShouldIauditthissave?”'>1 The Decision: “Should I audit this save?”</a></li>
<li><a href='#CRMAuditMasterTechNotes-2Snapshot&amp;Compare'>2 Snapshot &amp; Compare</a></li>
<li><a href='#CRMAuditMasterTechNotes-3BuildingtheAuditRow(s)'>3 Building the Audit Row(s)</a></li>
<li><a href='#CRMAuditMasterTechNotes-4Edge-CaseEventTypes'>4 Edge-Case Event Types</a></li>
<li><a href='#CRMAuditMasterTechNotes-5SerialisationRulesforChangeData'>5 Serialisation Rules for ChangeData</a></li>
<li><a href='#CRMAuditMasterTechNotes-6WhereDoMultipleRowsComeFrom?'>6 Where Do Multiple Rows Come From?</a></li>
<li><a href='#CRMAuditMasterTechNotes-7Retention&amp;Partitioning(WhyYouSee“AuditBase_2023Q4”)'>7 Retention &amp; Partitioning (Why You See “AuditBase_2023Q4”)</a></li>
<li><a href='#CRMAuditMasterTechNotes-8MinimalPseudocodeoftheAuditEngine'>8 Minimal Pseudocode of the Audit Engine</a></li>
<li><a href='#CRMAuditMasterTechNotes-9WhyUnderstandingCaptureMattersBeforeNormalising'>9 Why Understanding Capture Matters Before Normalising</a></li>
<li><a href='#CRMAuditMasterTechNotes-10QuickQuiz(TestYourBiggerPicture)'>10 Quick Quiz (Test Your Bigger Picture)</a></li>
</ul>
</li>
<li><a href='#CRMAuditMasterTechNotes-AMathematicalAbstractionofCRMAuditing'>A Mathematical Abstraction of CRM Auditing</a>
<ul class='toc-indentation'>
<li><a href='#CRMAuditMasterTechNotes-1DefinetheCoreSets'>1 Define the Core Sets</a></li>
<li><a href='#CRMAuditMasterTechNotes-2RepresentOneRawAuditRow'>2 Represent One Raw Audit Row</a></li>
<li><a href='#CRMAuditMasterTechNotes-3Metadata&amp;LookupFunctions'>3 Metadata &amp; Lookup Functions</a></li>
<li><a href='#CRMAuditMasterTechNotes-4PipelineasFunctionComposition'>4 Pipeline as Function Composition</a></li>
<li><a href='#CRMAuditMasterTechNotes-5Event-StreamModel'>5 Event-Stream Model</a></li>
<li><a href='#CRMAuditMasterTechNotes-6TypicalPattern-MiningProblems(expressedformally)'>6 Typical Pattern-Mining Problems (expressed formally)</a></li>
<li><a href='#CRMAuditMasterTechNotes-7ExampleWalk-ThroughinSymbols'>7 Example Walk-Through in Symbols</a></li>
<li><a href='#CRMAuditMasterTechNotes-8WhyThisModelHelps'>8 Why This Model Helps</a></li>
<li><a href='#CRMAuditMasterTechNotes-9OpenExtensionsforResearchProjects'>9 Open Extensions for Research Projects</a></li>
<li><a href='#CRMAuditMasterTechNotes-10Cheat-SheetofAllSymbols'>10 Cheat-Sheet of All Symbols</a></li>
</ul>
</li>
</ul>
</div><p>Useful Links </p><p><a class="external-link" data-card-appearance="inline" href="https://dynamics-chronicles.com/article/dynamics-365-audit-explanation-deep-dive" rel="nofollow">https://dynamics-chronicles.com/article/dynamics-365-audit-explanation-deep-dive</a> </p><ul><li><p><a class="external-link" data-card-appearance="inline" href="https://docs.microsoft.com/en-us/power-platform/admin/audit-data-user-activity" rel="nofollow">https://docs.microsoft.com/en-us/power-platform/admin/audit-data-user-activity</a> </p></li><li><p><a class="external-link" data-card-appearance="inline" href="https://docs.microsoft.com/en-us/dynamics365/customerengagement/on-premises/developer/entities/audit#read-only-attributes" rel="nofollow">https://docs.microsoft.com/en-us/dynamics365/customerengagement/on-premises/developer/entities/audit#read-only-attributes</a> </p></li><li><p><a class="external-link" data-card-appearance="inline" href="https://mahadeomatre.blogspot.com/2015/02/ms-crm-audit-database-table-details.html" rel="nofollow">https://mahadeomatre.blogspot.com/2015/02/ms-crm-audit-database-table-details.html</a> </p></li><li><p><a class="external-link" data-card-appearance="inline" href="https://www.ahaapps.com/microsoft-dynamics-365-audit-management/" rel="nofollow">https://www.ahaapps.com/microsoft-dynamics-365-audit-management/</a> </p></li><li><p><a class="external-link" href="https://www.qgate.co.uk/knowledge/managing-audit-logs-in-microsoft-dynamics-crm/" rel="nofollow">https://www.qgate.co.uk/knowledge/managing-audit-logs-in-microsoft-dynamics-crm/</a></p></li></ul><h2 id="CRMAuditMasterTechNotes-CRMAuditMasterScript–Super-DetailedGuideforHigh-SchoolStudents">CRM Audit Master Script – <strong>Super-Detailed Guide for High-School Students</strong></h2><blockquote><p><strong>Goal in one sentence:</strong><br/>Turn the messy, computer-friendly log of “who changed what in CRM” into a tidy, human-friendly table you can read like a history book.</p></blockquote><hr/><h3 id="CRMAuditMasterTechNotes-1.StoryboardoftheWholeProcess">1. Storyboard of the Whole Process</h3><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">(A) dbo.Audit table  ➜ filter rows ➜  (#TempAudit)
           │
           ▼
(B) clean text + add labels         ➜  (#temp)
           │
           ▼
(C) split each change into pieces   ➜  (#AtribStore)
           │
           ▼
(D) translate everything to English ➜  (#Result1)
           │
           ▼
(E) glue old → new pairs together   ➜  final SELECT
</pre>
</div></div><p>Think of it like:</p><ol start="1"><li><p><strong>Sifting</strong> dirt to keep only the gold.</p></li><li><p><strong>Brushing</strong> each nugget clean.</p></li><li><p><strong>Cutting</strong> nuggets into sparkly gems.</p></li><li><p><strong>Labeling</strong> every gem with its name and colour.</p></li><li><p><strong>Lining</strong> them up in a museum case so visitors understand the story.</p></li></ol><hr/><h3 id="CRMAuditMasterTechNotes-2.MainIdeas&amp;WordsYouMustKnow">2. Main Ideas &amp; Words You Must Know</h3><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="f67d641c-4714-4e09-b6b1-39e627d4735c" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>Word</p></th><th class="confluenceTh"><p>What it really means (simple)</p></th></tr><tr><td class="confluenceTd"><p><strong>Audit row</strong></p></td><td class="confluenceTd"><p>One diary line that says “something on a record changed.”</p></td></tr><tr><td class="confluenceTd"><p><strong>ObjectTypeCode (OTC)</strong></p></td><td class="confluenceTd"><p>A numeric species tag (e.g., 1 = Account, 2 = Contact).</p></td></tr><tr><td class="confluenceTd"><p><strong>GUID</strong></p></td><td class="confluenceTd"><p>A record’s worldwide-unique passport number.</p></td></tr><tr><td class="confluenceTd"><p><strong>AttributeMask</strong></p></td><td class="confluenceTd"><p>A comma list of column numbers that changed.</p></td></tr><tr><td class="confluenceTd"><p><strong>ChangeData</strong></p></td><td class="confluenceTd"><p>The old values, separated by tildes <code>~</code>.</p></td></tr><tr><td class="confluenceTd"><p><strong>Lookup / GUID field</strong></p></td><td class="confluenceTd"><p>A foreign-key; it stores a GUID that points to another table.</p></td></tr><tr><td class="confluenceTd"><p><strong>Option-set / drop-down</strong></p></td><td class="confluenceTd"><p>CRM stores the <em>number</em> you chose, not the text you see.</p></td></tr><tr><td class="confluenceTd"><p><strong>Temp table</strong> (<code>#something</code>)</p></td><td class="confluenceTd"><p>A scratchpad that vanishes when the script ends.</p></td></tr></tbody></table></div><hr/><h3 id="CRMAuditMasterTechNotes-3.Section-by-SectionWalk-Through">3. Section-by-Section Walk-Through</h3><div class="table-wrap"><table data-table-width="1250" data-layout="center" data-local-id="b928081b-6739-4a9b-ba8f-4c25b5c8045b" class="confluenceTable"><colgroup><col style="width: 157.0px;"/><col style="width: 352.0px;"/><col style="width: 737.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p>Section</p></th><th class="confluenceTh"><p>Nickname</p></th><th class="confluenceTh"><p>What happens (kid-friendly)</p></th></tr><tr><td class="confluenceTd"><p>0</p></td><td class="confluenceTd"><p><strong>Set the clock &amp; inputs</strong></p></td><td class="confluenceTd"><p>Decide the start date (today − 30 days) and unpack the long “pipe-string” of IDs into rows.</p></td></tr><tr><td class="confluenceTd"><p>1</p></td><td class="confluenceTd"><p><strong>Time-zone maths</strong></p></td><td class="confluenceTd"><p>Converts UTC time to NZ time so the times look right for humans here.</p></td></tr><tr><td class="confluenceTd"><p>2</p></td><td class="confluenceTd"><p><strong>Make the ID list a table</strong></p></td><td class="confluenceTd"><p>Uses a clever JSON trick so the long text becomes neat columns in <code>#Parameter</code>.</p></td></tr><tr><td class="confluenceTd"><p>3</p></td><td class="confluenceTd"><p><strong>Clean the kitchen</strong></p></td><td class="confluenceTd"><p>Drops any left-over scratch tables and creates fresh ones (like wiping the whiteboard).</p></td></tr><tr><td class="confluenceTd"><p>4</p></td><td class="confluenceTd"><p><strong>Pick the rows we care about</strong></p></td><td class="confluenceTd"><p>Copies only the audit rows that match our IDs and ignores “noise” fields if <code>@ExcludeCompliance = 1</code>.</p></td></tr><tr><td class="confluenceTd"><p>5</p></td><td class="confluenceTd"><p><strong>Un-break single quotes</strong></p></td><td class="confluenceTd"><p>Removes <code>'</code> from text so dynamic SQL later doesn’t choke.</p></td></tr><tr><td class="confluenceTd"><p>6</p></td><td class="confluenceTd"><p><strong>Add basic labels</strong></p></td><td class="confluenceTd"><p>Turns action numbers into words (Update, Delete, …) and adds entity names; saves to <code>#temptemp</code>.</p></td></tr><tr><td class="confluenceTd"><p>7</p></td><td class="confluenceTd"><p><strong>Find every table’s PK name</strong></p></td><td class="confluenceTd"><p>Looks in system metadata to know each table’s primary-key column (e.g., <code>ContactId</code>).</p></td></tr><tr><td class="confluenceTd"><p>8</p></td><td class="confluenceTd"><p><strong>Flatten for easy looping</strong></p></td><td class="confluenceTd"><p>Moves cleaned rows into <code>#temp</code>, strips curly braces from masks.</p></td></tr><tr><td class="confluenceTd"><p>9</p></td><td class="confluenceTd"><p><strong><span style="background-color: rgb(211,241,167);">BIG LOOP: explode details</span></strong></p></td><td class="confluenceTd"><p>For each row:• split <code>AttributeMask</code> (comma) ➜ <code>#Mask</code>• split <code>ChangeData</code> (tilde) ➜ <code>#Vals</code>• combine and store per-field info in <code>#AtribStore</code>.Also queues little “SELECT” commands in <code>#QueryStore</code> to fetch current values later.</p></td></tr><tr><td class="confluenceTd"><p>10</p></td><td class="confluenceTd"><p><strong>Fix “table,GUID” weirdness</strong></p></td><td class="confluenceTd"><p>If old value looks like <code>contact,3F24…</code>, separate it into table name and GUID.</p></td></tr><tr><td class="confluenceTd"><p>11</p></td><td class="confluenceTd"><p><strong>More lookup prep</strong></p></td><td class="confluenceTd"><p>Find each lookup table’s PK column and the best “display name” column (e.g., choose <code>Name</code> over <code>Description</code>).</p></td></tr><tr><td class="confluenceTd"><p>12</p></td><td class="confluenceTd"><p><strong>Run queued SELECTs</strong></p></td><td class="confluenceTd"><p>Executes every little query in <code>#QueryStore</code> to pull the <em>current</em> value for each field.</p></td></tr><tr><td class="confluenceTd"><p>13</p></td><td class="confluenceTd"><p><strong>Translate codes to words</strong></p></td><td class="confluenceTd"><ul><li><p>Option-set numbers → text (5 ➜ “Active”).• Booleans “True/False” → “Yes/No”.• Build SQL strings to turn GUIDs into names.</p></li></ul></td></tr><tr><td class="confluenceTd"><p>14</p></td><td class="confluenceTd"><p><strong>Turn GUIDs into names</strong></p></td><td class="confluenceTd"><p>Executes those SQL strings so <code>OldValue</code> and <code>CurrentValue</code> now show “Daniel Wanigasekera” instead of <code>3AC9D8A4…</code>.</p></td></tr><tr><td class="confluenceTd"><p>15</p></td><td class="confluenceTd"><p><strong>Pretty-print date fields</strong></p></td><td class="confluenceTd"><p>Converts any UTC dates to NZ time and formats them as <code>dd/MM/yyyy hh:mm am/pm</code>.</p></td></tr><tr><td class="confluenceTd"><p>16</p></td><td class="confluenceTd"><p><strong>Assemble nice labels</strong></p></td><td class="confluenceTd"><p>Joins with language tables so each column shows friendly English labels (goes into <code>#Result1</code>).</p></td></tr><tr><td class="confluenceTd"><p>17</p></td><td class="confluenceTd"><p><strong>Glue old ↔ new</strong></p></td><td class="confluenceTd"><p>Uses <code>LEAD()</code> window function to pair “Old” with “New” in one line; filters out rows where nothing actually changed.</p></td></tr></tbody></table></div><hr/><h3 id="CRMAuditMasterTechNotes-4.Example:ReadingOneChangeinPlainEnglish">4. Example: Reading One Change in Plain English</h3><p>Imagine CRM logged this raw line:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">OTC=2  | ObjectId=3AC9… | AttributeMask={22,10366} |
ChangeData=&quot;OldCountry~OldPhone&quot; | Action=2 | CreatedOn=2025-06-11 01:30:00Z
</pre>
</div></div><p>After Sections 9-17 the final report row will read:</p><div class="table-wrap"><table data-table-width="1078" data-layout="center" data-local-id="b0d8e7e2-f83a-4b0e-8727-c9d84f93b3b6" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>DataGroupName</p></th><th class="confluenceTh"><p>Name</p></th><th class="confluenceTh"><p>FieldName</p></th><th class="confluenceTh"><p>OldValue</p></th><th class="confluenceTh"><p>NewValue</p></th><th class="confluenceTh"><p>ChangedDate (NZ)</p></th><th class="confluenceTh"><p>ChangedBy</p></th><th class="confluenceTh"><p>Event</p></th></tr><tr><td class="confluenceTd"><p>Contact</p></td><td class="confluenceTd"><p>Daniel Wanigasekera &lt;Active&gt;</p></td><td class="confluenceTd"><p>Country</p></td><td class="confluenceTd"><p>Sri Lanka</p></td><td class="confluenceTd"><p>New Zealand</p></td><td class="confluenceTd"><p>11/06/2025 03:30 pm</p></td><td class="confluenceTd"><p>Kaye Germann</p></td><td class="confluenceTd"><p>Update</p></td></tr></tbody></table></div><p>Magic achieved ✔️.</p><hr/><h3 id="CRMAuditMasterTechNotes-5.TipsforRunning/DebuggingtheScriptYourself">5. Tips for Running / Debugging the Script Yourself</h3><ol start="1"><li><p><strong>Work in small bites:</strong> comment out everything after Section 4, run, and inspect <code>#TempAudit</code> to be sure you filtered the right rows.</p></li><li><p><strong>Use </strong><code>TOP 10</code> when testing so you don’t flood SSMS.</p></li><li><p><strong>Check tempdb if things slow down:</strong> huge audits create huge temp tables.</p></li><li><p><strong>If GUIDs don’t resolve to names,</strong> revisit Section 11 ranking rules – maybe the display column guess was wrong for that table.</p></li><li><p>** daylight-savings bugs?** Verify the helper function <code>fn_UTCToLocalTime_rpt</code> has current NZ DST rules.</p></li></ol><hr/><h3 id="CRMAuditMasterTechNotes-6.RecapCheatSheet">6. Recap Cheat Sheet</h3><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">Audit → #TempAudit → #temp → #AtribStore → #Result1 → final SELECT
filter      clean     explode      translate      label      merge
</pre>
</div></div><p>Whenever you feel lost, jump back to this chain and ask: <em>“Which box am I filling right now, and why?”</em></p><hr/><p><strong>You now have a readable, step-by-step mental map of a 1 200-line enterprise audit script—no scary jargon, just clear purpose at every stop.</strong></p><p /><p /><h2 id="CRMAuditMasterTechNotes-DiggingDeeper—HowCRMStoresOneChangeandHowtheScriptDecodesIt">Digging Deeper — How CRM Stores One Change and How the Script Decodes It</h2><p><em>(“I want to see the messy stuff under the hood.”)</em></p><hr/><h3 id="CRMAuditMasterTechNotes-1.WhataRawAuditRowReallyLooksLike">1. <strong>What a Raw Audit Row Really Looks Like</strong></h3><p>Below is the <strong>dbo.Audit</strong> table trimmed to the six columns our script cares about.<br/>(There are ~25 columns in the real table; most are metadata we can ignore.)</p><div class="table-wrap"><table data-table-width="1314" data-layout="center" data-local-id="65937f1d-8cf7-4c71-85fe-a7e8cbb01d95" class="confluenceTable"><colgroup><col style="width: 169.0px;"/><col style="width: 706.0px;"/><col style="width: 438.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p>Column</p></th><th class="confluenceTh"><p>Example value</p></th><th class="confluenceTh"><p>Why it matters to the script</p></th></tr><tr><td class="confluenceTd"><p><strong>AuditId</strong></p></td><td class="confluenceTd"><p><code>1F96F109-99DD-ED11-B597-6045BD807DC5</code></p></td><td class="confluenceTd"><p>PK for this diary line (never reused).</p></td></tr><tr><td class="confluenceTd"><p><strong>ObjectTypeCode</strong></p></td><td class="confluenceTd"><p><code>2</code></p></td><td class="confluenceTd"><p>“2” is <em>Contact</em>. Every entity has a unique number.</p></td></tr><tr><td class="confluenceTd"><p><strong>ObjectId</strong></p></td><td class="confluenceTd"><p><code>3AC9D8A4-4DB6-ED11-A2DD-00505681265F</code></p></td><td class="confluenceTd"><p>The Contact record that changed.</p></td></tr><tr><td class="confluenceTd"><p><strong>Action</strong></p></td><td class="confluenceTd"><p><code>2</code></p></td><td class="confluenceTd"><p>1 = Create, 2 = Update, 3 = Delete, 4 = Activate, 5 = Deactivate, 6 = Assign.</p></td></tr><tr><td class="confluenceTd"><p><strong>AttributeMask</strong></p></td><td class="confluenceTd"><p><code>{22,10366}</code></p></td><td class="confluenceTd"><p>Comma list of “column numbers” that changed (curly braces by default).</p></td></tr><tr><td class="confluenceTd"><p><strong>ChangeData</strong></p></td><td class="confluenceTd"><p><code>702~64</code></p></td><td class="confluenceTd"><p>Tilde-list of <strong>old</strong> values. 1-to-1 order with AttributeMask.</p></td></tr><tr><td class="confluenceTd"><p><strong>CreatedOn</strong></p></td><td class="confluenceTd"><p><code>2025-06-11 01:30:00.000</code> <em>(UTC)</em></p></td><td class="confluenceTd"><p>When CRM wrote this row.</p></td></tr><tr><td class="confluenceTd"><p><strong>UserIdName</strong></p></td><td class="confluenceTd"><p><code>Kaye Germann</code></p></td><td class="confluenceTd"><p>Who made the change.</p></td></tr></tbody></table></div><blockquote><p><strong>Mental model:</strong><br/><em>Audit</em> is like a warehouse receipt. Columns 22 and 10366 changed.<br/>The receipt tells us the <strong>old</strong> values (702, 64).<br/>The <strong>new</strong> values are not here—they must be fetched from live tables.</p></blockquote><hr/><h3 id="CRMAuditMasterTechNotes-2.AttributeMask&amp;ChangeDataDecoding">2. <strong>AttributeMask &amp; ChangeData Decoding</strong></h3><div class="table-wrap"><table data-table-width="1098" data-layout="center" data-local-id="c75e2850-78ed-4fb6-924f-902b953d898c" class="confluenceTable"><colgroup><col style="width: 119.0px;"/><col style="width: 612.0px;"/><col style="width: 366.0px;"/></colgroup><tbody><tr><th class="confluenceTh"><p>Step</p></th><th class="confluenceTh"><p>What we do</p></th><th class="confluenceTh"><p>Example outcome</p></th></tr><tr><td class="confluenceTd"><ol start="1"><li><p /></li></ol></td><td class="confluenceTd"><p>Remove <code>{ }</code> so we get <code>22,10366</code>.</p></td><td class="confluenceTd"><p><code>&quot;22,10366&quot;</code></p></td></tr><tr><td class="confluenceTd"><ol start="2"><li><p /></li></ol></td><td class="confluenceTd"><p>Split by comma ➜ temp table <code>#Mask</code>.</p></td><td class="confluenceTd"><p><code>22</code> in row 1, <code>10366</code> in row 2</p></td></tr><tr><td class="confluenceTd"><ol start="3"><li><p /></li></ol></td><td class="confluenceTd"><p>Split <code>ChangeData</code> by <code>~</code> ➜ temp table <code>#Vals</code>.</p></td><td class="confluenceTd"><p><code>702</code> in row 1, <code>64</code> in row 2</p></td></tr><tr><td class="confluenceTd"><ol start="4"><li><p /></li></ol></td><td class="confluenceTd"><p>Zip them together <em>(position = position)</em>.</p></td><td class="confluenceTd"><p><code>(22,702)</code> and <code>(10366,64)</code></p></td></tr><tr><td class="confluenceTd"><ol start="5"><li><p /></li></ol></td><td class="confluenceTd"><p>Ask the <strong>Metadata</strong> tables: “Column 22 of Contact = <em>Country</em>, 10366 = <em>CitizenshipStatus</em>”.</p></td><td class="confluenceTd"><p>Now we have names, data types, option-set IDs, etc.</p></td></tr></tbody></table></div><p><strong>Why the positions matter</strong><br/>Think of two parallel trains: first carriage of Mask = first carriage of Values.<br/>If you lose position, “Country” might be matched to “64” (wrong field!).</p><hr/><h3 id="CRMAuditMasterTechNotes-3.ExamplesofCommonFieldTypes">3. <strong>Examples of Common Field Types</strong></h3><div class="table-wrap"><table data-table-width="1280" data-layout="center" data-local-id="44277823-2e0c-4a31-94c8-9c100efbb973" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>Field type</p></th><th class="confluenceTh"><p>Stored in ChangeData</p></th><th class="confluenceTh"><p>What the script must do</p></th><th class="confluenceTh"><p>Mini-example</p></th></tr><tr><td class="confluenceTd"><p><strong>Text</strong></p></td><td class="confluenceTd"><p>The literal string.</p></td><td class="confluenceTd"><p>Nothing (after apostrophe fix).</p></td><td class="confluenceTd"><p><code>OldValue = &quot;Acme Ltd&quot;</code></p></td></tr><tr><td class="confluenceTd"><p><strong>Option-set</strong> (drop-down)</p></td><td class="confluenceTd"><p>A <strong>number</strong>.</p></td><td class="confluenceTd"><p>Look up <code>StringMap</code> to get the friendly word.</p></td><td class="confluenceTd"><p><code>5 ➜ &quot;Active&quot;</code></p></td></tr><tr><td class="confluenceTd"><p><strong>Two-options</strong> (Yes/No)</p></td><td class="confluenceTd"><p><code>&quot;True&quot;</code> / <code>&quot;False&quot;</code>.</p></td><td class="confluenceTd"><p>Replace with <code>&quot;Yes&quot;</code> / <code>&quot;No&quot;</code>.</p></td><td class="confluenceTd"><p><code>&quot;False&quot; ➜ &quot;No&quot;</code></p></td></tr><tr><td class="confluenceTd"><p><strong>Lookup</strong></p></td><td class="confluenceTd"><p><em>Usually</em> a bare GUID.Sometimes <code>&quot;tablename,GUID&quot;</code>.</p></td><td class="confluenceTd"><ol start="1"><li><p>Strip table name if present.2) Later fetch the GUID’s <strong>Name</strong> from that table.</p></li></ol></td><td class="confluenceTd"><p><code>&quot;contact,3F24…&quot; ➜ &quot;3F24…&quot; ➜ &quot;Daniel Wanigasekera&quot;</code></p></td></tr><tr><td class="confluenceTd"><p><strong>DateTime</strong></p></td><td class="confluenceTd"><p>UTC string.</p></td><td class="confluenceTd"><p>Convert to NZT with <code>fn_UTCToLocalTime_rpt()</code> then <code>FORMAT(...)</code> into <code>dd/MM/yyyy hh:mm tt</code>.</p></td><td class="confluenceTd"><p><code>&quot;2025-06-11 01:30&quot;</code> ➜ <code>&quot;11/06/2025 03:30 pm&quot;</code></p></td></tr></tbody></table></div><hr/><h3 id="CRMAuditMasterTechNotes-4.Single-FieldvsMulti-FieldUpdateWalk-Through">4. <strong>Single-Field vs Multi-Field Update Walk-Through</strong></h3><h4 id="CRMAuditMasterTechNotes-4.1Onefieldupdated(easy)">4.1 One field updated (easy)</h4><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">AttributeMask = {10995}
ChangeData    = &quot;OldEmail@example.com&quot;
</pre>
</div></div><p><em>10995</em> in <em>Contact</em> metadata = <strong>EmailAddress1</strong>.<br/>Script output row:</p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="48fa2a49-1336-4504-b525-753b6cfe190e" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>FieldName</p></th><th class="confluenceTh"><p>OldValue</p></th><th class="confluenceTh"><p>NewValue</p></th></tr><tr><td class="confluenceTd"><p>Email Address</p></td><td class="confluenceTd"><p><a class="external-link" href="mailto:OldEmail@example.com" rel="nofollow">OldEmail@example.com</a></p></td><td class="confluenceTd"><p><strong>(fetched live)</strong></p></td></tr></tbody></table></div><h4 id="CRMAuditMasterTechNotes-4.2Twofieldsupdatedinonesave(ourearlierexample)">4.2 Two fields updated in one save (our earlier example)</h4><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">AttributeMask = {22,10366}
ChangeData    = &quot;702~64&quot;
</pre>
</div></div><p>After linking to metadata:</p><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="ddea0c89-4937-4045-b12c-6a2ef7e0c842" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>TargetFieldNo</p></th><th class="confluenceTh"><p>TargetFieldName</p></th><th class="confluenceTh"><p>OldValue</p></th><th class="confluenceTh"><p>CurrentValue (pulled later)</p></th></tr><tr><td class="confluenceTd"><p>22</p></td><td class="confluenceTd"><p>Country</p></td><td class="confluenceTd"><p>702</p></td><td class="confluenceTd"><p>New Country (string)</p></td></tr><tr><td class="confluenceTd"><p>10366</p></td><td class="confluenceTd"><p>CitizenshipStatus</p></td><td class="confluenceTd"><p>64</p></td><td class="confluenceTd"><p>New Status (string)</p></td></tr></tbody></table></div><p>Then:</p><ol start="1"><li><p>702 &amp; 64 are turned into text via <strong>StringMap</strong>.</p></li><li><p>Live values are fetched into <code>CurrentValue</code>.</p></li><li><p><code>LEAD()</code> pairs them so final row shows <strong>Old → New</strong>.</p></li></ol><hr/><h3 id="CRMAuditMasterTechNotes-5.ActionCodesCheat-Sheet">5. <strong>Action Codes Cheat-Sheet</strong></h3><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="88820e19-c7fb-4f65-a728-94ef8ab8aaac" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>Action (int)</p></th><th class="confluenceTh"><p>What happened</p></th><th class="confluenceTh"><p>Shown after Section 6</p></th></tr><tr><td class="confluenceTd"><p>1</p></td><td class="confluenceTd"><p>Create</p></td><td class="confluenceTd"><p>Create</p></td></tr><tr><td class="confluenceTd"><p>2</p></td><td class="confluenceTd"><p>Update <em>(most common)</em></p></td><td class="confluenceTd"><p>Update</p></td></tr><tr><td class="confluenceTd"><p>3</p></td><td class="confluenceTd"><p>Delete</p></td><td class="confluenceTd"><p>Delete</p></td></tr><tr><td class="confluenceTd"><p>4</p></td><td class="confluenceTd"><p>Activate (set state to Active)</p></td><td class="confluenceTd"><p>Activate</p></td></tr><tr><td class="confluenceTd"><p>5</p></td><td class="confluenceTd"><p>Deactivate (set state to Inactive)</p></td><td class="confluenceTd"><p>Deactivate</p></td></tr><tr><td class="confluenceTd"><p>6</p></td><td class="confluenceTd"><p>Assign (owner changed)</p></td><td class="confluenceTd"><p>Assign</p></td></tr><tr><td class="confluenceTd"><p>13</p></td><td class="confluenceTd"><p>Associate (many-to-many link added)</p></td><td class="confluenceTd"><p>Associate</p></td></tr><tr><td class="confluenceTd"><p>14</p></td><td class="confluenceTd"><p>Disassociate (link removed)</p></td><td class="confluenceTd"><p>Disassociate</p></td></tr></tbody></table></div><p>These numbers come from CRM internals; <strong>StringMap</strong> turns them into the words above in <code>#temptemp</code>.</p><hr/><h3 id="CRMAuditMasterTechNotes-6.HowtheScriptHandles“Table,GUID”Oddities(Section10)">6. <strong>How the Script Handles “Table,GUID” Oddities (Section 10)</strong></h3><p>Raw <code>OldValue</code> example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">&quot;account,1F96F109-99DD-ED11-B597-6045BD807DC5&quot;
</pre>
</div></div><p>Algorithm in plain words:</p><ol start="1"><li><p>Split on the first comma.<br/><em>TabNameExtracted = &quot;account&quot;</em><br/><em>GuidExtracted = &quot;1F96F109-...&quot;</em></p></li><li><p>Overwrite <code>OldValue</code> with <em>GuidExtracted</em> <strong>upper-cased</strong> (SQL likes upper-case GUIDs).</p></li><li><p>If <code>ReferenceTableName</code> is still null, fill it with <em>TabNameExtracted</em>.</p></li><li><p>Mark <code>IsGUID = 1</code> to signal later look-ups.</p></li></ol><p>Later (Section 14) the GUID is resolved to <code>&quot;Acme Holdings Ltd&quot;</code>.</p><hr/><h3 id="CRMAuditMasterTechNotes-7.PuttingItAllTogether–TimelineofaRow">7. <strong>Putting It All Together – Timeline of a Row</strong></h3><ol start="1"><li><p><strong>User hits Save</strong> on a Contact; CRM writes one Audit row.</p></li><li><p>Script runs nightly:</p><ol start="1"><li><p>Row copied to <code>#TempAudit</code> (Section 4).</p></li><li><p>Quotes cleaned (Section 5).</p></li><li><p>Labels added (Section 6).</p></li><li><p>Row flattened to <code>#temp</code>.</p></li><li><p><code>AttributeMask</code>/<code>ChangeData</code> exploded → <code>#AtribStore</code> (Section 9).</p></li><li><p>Current values fetched (Section 12).</p></li><li><p>Codes translated (Section 13).</p></li><li><p>GUIDs turned into names (Section 14).</p></li><li><p>Dates beautified (Section 15).</p></li><li><p>Joined with English labels → <code>#Result1</code> (Section 16).</p></li><li><p>Old/New glued → <strong>final SELECT</strong> (Section 17).</p></li></ol></li></ol><p>The very last table your analyst sees is <strong>pure words and local times</strong>—no numbers, no GUIDs, no braces.</p><hr/><h3 id="CRMAuditMasterTechNotes-8.PracticeChallenge">8. <strong>Practice Challenge</strong></h3><blockquote><p><strong>Decode this sample Audit row by hand</strong> (pretend you’re the script).</p></blockquote><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">ObjectTypeCode = 1      -- Account
ObjectId       = 5EA7…
Action         = 2      -- Update
AttributeMask  = {3,10166}
ChangeData     = &quot;False~100&quot;
</pre>
</div></div><ol start="1"><li><p>Look up column 3 and 10166 in <em>Account</em> metadata.</p><ul><li><p>3 = <code>AccountNumber</code> (string)</p></li><li><p>10166 = <code>dsl_PreviousCompliancePassed</code> (two-options)</p></li></ul></li><li><p>Split ChangeData: <code>&quot;False&quot;</code> and <code>&quot;100&quot;</code>.</p></li><li><p><code>&quot;False&quot;</code> ➜ <code>&quot;No&quot;</code>.</p></li><li><p><code>100</code> is an option-set code; <code>StringMap</code> says 100 = “Fail”.</p></li><li><p>Fetch live values for both fields to fill <strong>NewValue</strong>.</p></li><li><p>Produce final row, e.g.:</p></li></ol><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="51fcc1eb-c54b-41c3-86ef-d1befb145470" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>FieldName</p></th><th class="confluenceTh"><p>OldValue</p></th><th class="confluenceTh"><p>NewValue</p></th><th class="confluenceTh"><p>Event</p></th></tr><tr><td class="confluenceTd"><p>Account Number</p></td><td class="confluenceTd"><p><em>(blank)</em></p></td><td class="confluenceTd"><p>100045</p></td><td class="confluenceTd"><p>Update</p></td></tr><tr><td class="confluenceTd"><p>Previous Compliance Passed ?</p></td><td class="confluenceTd"><p>No</p></td><td class="confluenceTd"><p>Yes</p></td><td class="confluenceTd"><p>Update</p></td></tr></tbody></table></div><p><em>(Actual NewValue depends on current data.)</em></p><p>Try it—if you get stuck, walk back through Sections 9→15 and see where the info comes from.</p><hr/><h3 id="CRMAuditMasterTechNotes-9.KeyTakeaways">9. <strong>Key Takeaways</strong></h3><ol start="1"><li><p><strong>Positions are everything</strong> – AttributeMask and ChangeData are zipped by order, not value.</p></li><li><p>A <strong>lookup</strong> isn’t useful until its GUID is turned into a name.</p></li><li><p>Every data type needs its own clean-up: text, option-set, boolean, GUID, date.</p></li><li><p>Temp tables let you process mountains of rows in bite-sized steps.</p></li><li><p>Window functions (<code>LEAD</code>) are the secret sauce for Old/New pairing without cursors.</p></li></ol><p>Keep this page open next time you debug the script; each step will click into place. Happy decoding!</p><hr/><h2 id="CRMAuditMasterTechNotes-“ThinkingBigger”—HowDynamicsCRMBuildstheAuditTableinRealTime">“Thinking Bigger” — How Dynamics CRM Builds the <strong>Audit Table</strong> in Real Time</h2><p>Below we zoom out from the SQL-cleanup script and watch what happens <strong>inside the CRM platform</strong> the moment someone clicks <strong>Save</strong>.</p><hr/><h3 id="CRMAuditMasterTechNotes-1TheDecision:“ShouldIauditthissave?”">1 The Decision: <em>“Should I audit this save?”</em></h3><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="47097277-a6d3-4006-8e9d-65d1c8535d9f" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>Checkpoint (happens in platform code)</p></th><th class="confluenceTh"><p>What it looks at</p></th><th class="confluenceTh"><p>Result</p></th></tr><tr><td class="confluenceTd"><p><strong>Entity-level flag</strong></p></td><td class="confluenceTd"><p><code>IsAuditEnabled</code> on <em>Contact</em>, <em>Account</em>, etc.</p></td><td class="confluenceTd"><p>If off, no audit rows at all.</p></td></tr><tr><td class="confluenceTd"><p><strong>Field-level flags</strong></p></td><td class="confluenceTd"><p>Each attribute’s <code>IsAuditEnabled</code> bit in metadata.</p></td><td class="confluenceTd"><p>Only the ticked columns are considered.</p></td></tr><tr><td class="confluenceTd"><p><strong>Global Setting</strong></p></td><td class="confluenceTd"><p>System-wide “Enable Auditing” toggle in Admin.</p></td><td class="confluenceTd"><p>Disables everything in one shot.</p></td></tr></tbody></table></div><p>If <strong>all three</strong> say “yes”, the audit engine wakes up.</p><hr/><h3 id="CRMAuditMasterTechNotes-2Snapshot&amp;Compare">2 Snapshot &amp; Compare</h3><ol start="1"><li><p><strong>Before the SQL transaction starts</strong>, CRM copies the current row values into memory.</p></li><li><p><strong>After the user edits and hits Save</strong>, the new values are also in memory.</p></li><li><p>A tight loop compares <em>old vs new</em> <strong>column by column</strong>.</p><ul><li><p>If equal → skip.</p></li><li><p>If different <strong>and</strong> field-level audit flag is on → add to a <em>change list</em>.</p></li></ul></li></ol><hr/><h3 id="CRMAuditMasterTechNotes-3BuildingtheAuditRow(s)">3 Building the Audit Row(s)</h3><blockquote><p><strong>Key idea:</strong> <em>One CRM “save” may yield 1, many, or zero audit rows.</em></p></blockquote><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="d1a16f7e-996e-4b59-b066-6426a77a6504" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>Component in Audit table</p></th><th class="confluenceTh"><p>How the engine fills it</p></th></tr><tr><td class="confluenceTd"><p><strong>Action</strong></p></td><td class="confluenceTd"><p>Lookup from an internal enum:0 = Unknown, 1 = Create, 2 = Update, 3 = Delete, 4/5 = Activate / Deactivate, etc.</p></td></tr><tr><td class="confluenceTd"><p><strong>ObjectTypeCode</strong></p></td><td class="confluenceTd"><p>Pulled from entity metadata (e.g., Contact = 2).</p></td></tr><tr><td class="confluenceTd"><p><strong>ObjectId</strong></p></td><td class="confluenceTd"><p>The record’s GUID.</p></td></tr><tr><td class="confluenceTd"><p><strong>UserId</strong> / <strong>UserIdName</strong></p></td><td class="confluenceTd"><p>Caller’s systemuser record.</p></td></tr><tr><td class="confluenceTd"><p><strong>CreatedOn</strong></p></td><td class="confluenceTd"><p>UTC timestamp at commit time.</p></td></tr><tr><td class="confluenceTd"><p><strong>AttributeMask</strong></p></td><td class="confluenceTd"><p><strong>Comma list</strong> of the <em>column numbers</em> that changed, wrapped in <code>{}</code>.</p></td></tr><tr><td class="confluenceTd"><p><strong>ChangeData</strong></p></td><td class="confluenceTd"><p><strong>Tilde list</strong> of the <em>old</em> values, in the exact same order as AttributeMask.</p></td></tr><tr><td class="confluenceTd"><p><strong>Operation</strong> (hidden)</p></td><td class="confluenceTd"><p>0 = Core platform, 1 = Data import, 2 = Workflow, etc.—helps admins see where the change came from.</p></td></tr><tr><td class="confluenceTd"><p><strong>PartitionId</strong></p></td><td class="confluenceTd"><p>Each fiscal quarter, SQL creates a new partition so the big table stays fast.</p></td></tr></tbody></table></div><blockquote><p>🔍 <strong>Why only </strong><em><strong>old</strong></em><strong> values?</strong><br/>New values already live in the main tables; storing both would double the space.</p></blockquote><hr/><h3 id="CRMAuditMasterTechNotes-4Edge-CaseEventTypes">4 Edge-Case Event Types</h3><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="9324d817-cc7d-45f1-ab59-8b0479f3ae31" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>User action (UI/API)</p></th><th class="confluenceTh"><p>What the audit engine writes</p></th><th class="confluenceTh"><p>Key fields affected</p></th></tr><tr><td class="confluenceTd"><p><strong>Bulk Edit 100 rows</strong></p></td><td class="confluenceTd"><p>100 separate Update rows (looped server-side).</p></td><td class="confluenceTd"><p>Normal AttributeMask.</p></td></tr><tr><td class="confluenceTd"><p><strong>Assign Owner</strong></p></td><td class="confluenceTd"><p>Action = 6 (Assign); Mask contains the OwnerId column only.</p></td><td class="confluenceTd"><p /></td></tr><tr><td class="confluenceTd"><p><strong>Associate / N:N link</strong></p></td><td class="confluenceTd"><p>Action = 13 (Associate) or 14 (Disassociate); Mask and ChangeData are <em>blank</em> because nothing in the main record changed. Extra link data is stored in <code>AuditDetails</code> XML (rarely queried).</p></td><td class="confluenceTd"><p /></td></tr><tr><td class="confluenceTd"><p><strong>Delete</strong></p></td><td class="confluenceTd"><p>Action = 3; AttributeMask = <code>{}</code>; ChangeData = <code>NULL</code>.</p></td><td class="confluenceTd"><p /></td></tr><tr><td class="confluenceTd"><p><strong>State change (Activate)</strong></p></td><td class="confluenceTd"><p>Action = 4/5; Mask shows the <code>statecode</code> &amp; <code>statuscode</code> columns.</p></td><td class="confluenceTd"><p /></td></tr></tbody></table></div><hr/><h3 id="CRMAuditMasterTechNotes-5SerialisationRulesforChangeData">5 Serialisation Rules for <strong>ChangeData</strong></h3><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="1f62d830-7cf1-4a79-9f42-78c98a87cd8e" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>Field type</p></th><th class="confluenceTh"><p>Stored format</p></th><th class="confluenceTh"><p>Example in ChangeData</p></th></tr><tr><td class="confluenceTd"><p>Text / Number</p></td><td class="confluenceTd"><p>Literal text</p></td><td class="confluenceTd"><p><code>Acme Ltd</code>, <code>123.45</code></p></td></tr><tr><td class="confluenceTd"><p><strong>Option-set</strong></p></td><td class="confluenceTd"><p>Integer code</p></td><td class="confluenceTd"><p><code>702</code></p></td></tr><tr><td class="confluenceTd"><p><strong>Two-Option</strong></p></td><td class="confluenceTd"><p><code>True</code> / <code>False</code></p></td><td class="confluenceTd"><p><code>False</code></p></td></tr><tr><td class="confluenceTd"><p><strong>Lookup</strong></p></td><td class="confluenceTd"><p>GUID <em>or</em> <code>&quot;entityname,GUID&quot;</code></p></td><td class="confluenceTd"><p><code>contact,3AC9…</code></p></td></tr><tr><td class="confluenceTd"><p><strong>DateTime</strong></p></td><td class="confluenceTd"><p>UTC string <code>&quot;YYYY-MM-DD HH:MM:SS&quot;</code></p></td><td class="confluenceTd"><p><code>2025-06-11 01:30:00</code></p></td></tr><tr><td class="confluenceTd"><p><strong>Multi-select picklist</strong></p></td><td class="confluenceTd"><p>CSV string inside the tilde slot</p></td><td class="confluenceTd"><p><code>1,4,7</code></p></td></tr></tbody></table></div><p>The platform never stores nulls; blank = <code>''</code>.</p><hr/><h3 id="CRMAuditMasterTechNotes-6WhereDoMultipleRowsComeFrom?">6 Where Do Multiple Rows Come From?</h3><ul><li><p><strong>Create</strong> may spawn <strong>two</strong> audit rows:</p><ol start="1"><li><p><em>Pre-image</em> row with Action = 1 (all initial data).</p></li><li><p><em>Status reason</em> row if statecode/statuscode flips automatically.</p></li></ol></li><li><p><strong>Workflows</strong> that update a record later the same second create extra Update rows with the <strong>Workflow user</strong> as UserId.</p></li></ul><hr/><h3 id="CRMAuditMasterTechNotes-7Retention&amp;Partitioning(WhyYouSee“AuditBase_2023Q4”)">7 Retention &amp; Partitioning (Why You See “AuditBase_2023Q4”)</h3><ul><li><p>CRM auto-creates a new partition every quarter (<code>PartitionId = YYYYQx</code>).</p></li><li><p>Old partitions can be pruned via the Admin “Audit Log Management” page.</p></li><li><p>The main view <code>Audit</code> unions all partitions, so queries keep working.</p></li></ul><hr/><h3 id="CRMAuditMasterTechNotes-8MinimalPseudocodeoftheAuditEngine">8 Minimal Pseudocode of the Audit Engine</h3><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">foreach (Entity change in SaveBundle)
{
    if (!change.EntityMetadata.IsAuditEnabled) continue;

    var changedColumns = new List&lt;int&gt;();
    var oldValues      = new List&lt;string&gt;();

    foreach (AttributeMetadata att in change.Attributes)
    {
        if (!att.IsAuditEnabled) continue;

        if (!Equals(change.PreImage[att.LogicalName],
                    change.PostImage[att.LogicalName]))
        {
            changedColumns.Add(att.ColumnNumber);
            oldValues.Add(SerializeOldValue(change.PreImage[att.LogicalName]));
        }
    }

    if (changedColumns.Count &gt; 0 || action == Delete)
    {
        InsertAuditRow(
            actionCode,
            change.EntityMetadata.ObjectTypeCode,
            change.Id,
            String.Join(&quot;,&quot;, changedColumns).EncloseInBraces(),
            String.Join(&quot;~&quot;, oldValues),
            user.Id,
            UtcNow());
    }
}
</pre>
</div></div><p><em>(Greatly simplified, but the logic mirrors the real platform.)</em></p><hr/><h3 id="CRMAuditMasterTechNotes-9WhyUnderstandingCaptureMattersBeforeNormalising">9 Why Understanding Capture Matters Before Normalising</h3><ol start="1"><li><p><strong>Storage impact</strong> — knowing it only stores “old” shows why your script must pull “new” from live tables.</p></li><li><p><strong>Unexpected blanks</strong> — Delete and N:N events yield empty masks; your clean-up must allow for that.</p></li><li><p><strong>Partition dating</strong> — if you filter by <code>CreatedOn</code> only, you still scan every partition; adding <code>PartitionId</code> can accelerate big queries.</p></li><li><p><strong>Security reviews</strong> — Action + Operation columns let auditors trace whether a human, workflow, or import changed the data.</p></li></ol><hr/><h3 id="CRMAuditMasterTechNotes-10QuickQuiz(TestYourBiggerPicture)">10 Quick Quiz (Test Your Bigger Picture)</h3><ol start="1"><li><p><em>True / False:</em> A Boolean field’s <strong>new</strong> value is in <code>ChangeData</code>.</p></li><li><p>Which three switches must be ON for a field to be audited?</p></li><li><p>Why does the audit engine sometimes save <code>&quot;contact,GUID&quot;</code> instead of just <code>GUID</code>?</p></li><li><p>Name two Action codes where <code>AttributeMask</code> can legitimately be empty.</p></li><li><p>What quarterly process helps keep the <code>Audit</code> table performant?</p></li></ol><p><em>(Answers: 1 False; 2 Global Auditing, Entity-level Auditing, Field-level Auditing; 3 Older versions of CRM log lookups that way to hint the target table; 4 Delete (3) and Associate/Disassociate (13/14); 5 Partitioning – new partition each fiscal quarter.)</em></p><hr/><p><strong>Big takeaway:</strong> <em>Everything your normalisation script fixes originates from deliberate design choices inside CRM’s audit engine—understand those choices, and the downstream clean-up suddenly makes perfect sense.</em></p><hr/><h2 id="CRMAuditMasterTechNotes-AMathematicalAbstractionofCRMAuditing">A Mathematical Abstraction of CRM Auditing</h2><p><em>(turning the story into formulas you can analyse, optimise, or feed to an AI)</em></p><hr/><h3 id="CRMAuditMasterTechNotes-1DefinetheCoreSets">1 Define the Core Sets</h3><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="4433e559-043f-4ad7-acf7-4ddf0602dc4c" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>Symbol</p></th><th class="confluenceTh"><p>What it is</p></th><th class="confluenceTh"><p>Example element</p></th></tr><tr><td class="confluenceTd"><p><strong>𝔸</strong></p></td><td class="confluenceTd"><p>Set of <strong>actions</strong></p></td><td class="confluenceTd"><p>𝔸 = {Create = 1, Update = 2, Delete = 3, …}</p></td></tr><tr><td class="confluenceTd"><p><strong>𝕆</strong></p></td><td class="confluenceTd"><p>Set of <strong>entities</strong> (Object-Type-Codes)</p></td><td class="confluenceTd"><p>𝕆 = {1, 2, 3, 10042, …}</p></td></tr><tr><td class="confluenceTd"><p><strong>𝕌</strong></p></td><td class="confluenceTd"><p>Universe of <strong>GUIDs</strong></p></td><td class="confluenceTd"><p>“3AC9D8A4-…”</p></td></tr><tr><td class="confluenceTd"><p><strong>ℳ</strong></p></td><td class="confluenceTd"><p>Set of <strong>column numbers</strong> (Metadata IDs)</p></td><td class="confluenceTd"><p>ℳ = {1, 2, 3, …, 10995}</p></td></tr><tr><td class="confluenceTd"><p><strong>𝕍</strong></p></td><td class="confluenceTd"><p>Raw <strong>value strings</strong></p></td><td class="confluenceTd"><p>“702”, “False”, “account,GUID”, …</p></td></tr><tr><td class="confluenceTd"><p><strong>𝕋</strong></p></td><td class="confluenceTd"><p>Timestamps (UTC)</p></td><td class="confluenceTd"><p>2025-06-11 01∶30∶00</p></td></tr></tbody></table></div><hr/><h3 id="CRMAuditMasterTechNotes-2RepresentOneRawAuditRow">2 Represent One Raw Audit Row</h3><p>A raw row is an <strong>ordered tuple</strong></p><p>r  =  (a,  o,  g,  C,  D,  t,  u)r \;=\; (a,\; o,\; g,\; C,\; D,\; t,\; u)</p><p>where</p><ul><li><p>a∈𝔸a \in 𝔸 (Action)</p></li><li><p>o∈𝕆o \in 𝕆 (ObjectTypeCode)</p></li><li><p>g∈𝕌g \in 𝕌 (ObjectId)</p></li><li><p>C={c1,…,ck}⊆MC = \{c_1,\dots,c_k\} \subseteq ℳ (AttributeMask list)</p></li><li><p>D=⟨d1,…,dk⟩∈𝕍kD = \langle d_1,\dots,d_k\rangle \in 𝕍^{k} (ChangeData list, same length/order)</p></li><li><p>t∈𝕋t \in 𝕋 (UTC time)</p></li><li><p>u∈𝕌u \in 𝕌 (User GUID who acted)</p></li></ul><blockquote><p><strong>Positional invariant:</strong> cic_i describes the <strong>old</strong> value did_i.</p></blockquote><hr/><h3 id="CRMAuditMasterTechNotes-3Metadata&amp;LookupFunctions">3 Metadata &amp; Lookup Functions</h3><ul><li><p><strong>Column dictionary</strong> ϕ:M→FieldMeta \phi: ℳ \to \text{FieldMeta}<br/>– returns logical name, data-type, option-set ID, lookup target, etc.</p></li><li><p><strong>String-map resolver</strong> σopt:(OTC,Field,Code)→Label σ_{\text{opt}}: (\text{OTC},\text{Field},\text{Code}) \to \text{Label}</p></li><li><p><strong>Lookup resolver</strong> λ:(Table,GUID)→Name λ: ( \text{Table},\text{GUID} ) \to \text{Name}</p></li><li><p><strong>Time-zone converter</strong> τ:𝕋→NZTime τ: 𝕋 \to \text{NZTime}</p></li></ul><p>Each is a deterministic function (no randomness).</p><hr/><h3 id="CRMAuditMasterTechNotes-4PipelineasFunctionComposition">4 Pipeline as Function Composition</h3><p>Define seven pure functions:</p><ol start="1"><li><p><strong>Filter</strong> f1:r↦r  ∣  t&gt;t0  ∧  mask numeric∧…f_1 : r \mapsto r \;\big|\; t &gt; t_0\; \land \; \text{mask numeric} \land \dots</p></li><li><p><strong>Sanitise</strong> f2:di↦remove quotes(di)f_2 : d_i \mapsto \text{remove quotes}(d_i)</p></li><li><p><strong>Explode</strong> f3:r↦{(ci,di)}i=1..kf_3 : r \mapsto \{(c_i,d_i)\}_{i=1..k}</p></li><li><p><strong>Enrich</strong> f4:(c,d)↦(ϕ(c),d)f_4 : (c,d) \mapsto (\phi(c),d)</p></li><li><p><strong>Translate</strong> f5(FieldMeta,d)={σopt(… )if option-setλ(… )if lookupbool→Yes/Noif two-optiondelsef_5\bigl(\text{FieldMeta},d\bigr)=\begin{cases} σ_{\text{opt}}(\dots) &amp; \text{if option-set}\\ λ(\dots) &amp; \text{if lookup}\\[4pt] \text{bool→Yes/No} &amp; \text{if two-option}\\ d &amp; \text{else} \end{cases}</p></li><li><p><strong>ConvertTime</strong> f6:t↦τ(t)f_6 : t \mapsto τ(t)</p></li><li><p><strong>PairOldNew</strong> f7f_7   uses a window operator <strong>LEAD</strong> so that<br/>(Old,New)=(di,di+ ⁣1)\bigl(\text{Old},\text{New}\bigr) = \bigl(d_i, d_{i+\!1}\bigr) if same field.</p></li></ol><p>The <strong>whole ETL</strong> is</p><p>F  =  f7∘f6∘f5∘f4∘f3∘f2∘f1F \;=\; f_7 \circ f_6 \circ f_5 \circ f_4 \circ f_3 \circ f_2 \circ f_1</p><p>Mapping the space of raw rows <strong>ℛ</strong> into the tidy report space <strong>ℛ*</strong>.</p><hr/><h3 id="CRMAuditMasterTechNotes-5Event-StreamModel">5 Event-Stream Model</h3><p>Treat daily auditing as a discrete-time <strong>labeled multigraph</strong></p><ul><li><p><strong>Vertices</strong> every record GUID g∈𝕌g \in 𝕌</p></li><li><p><strong>Edges</strong> an edge e:(g, g)e : (g,\,g) stamped with label (a,C,D,t,u)(a,C,D,t,u)</p></li></ul><p>Edge weight = 1 (single change).<br/>A <strong>path</strong> on a vertex gives the chronological change history of that record.</p><hr/><h3 id="CRMAuditMasterTechNotes-6TypicalPattern-MiningProblems(expressedformally)">6 Typical Pattern-Mining Problems (expressed formally)</h3><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="26b92789-7dc8-4fcf-9cb2-161557551206" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>Problem</p></th><th class="confluenceTh"><p>Mathematical formulation</p></th></tr><tr><td class="confluenceTd"><p><strong>Anomaly detection</strong></p></td><td class="confluenceTd"><p>Given a sequence ⟨a1,…,an⟩\langle a_1,\dots,a_n\rangle on a vertex, flag when aia_i deviates from the Markov model (P(a_{i}</p></td></tr><tr><td class="confluenceTd"><p><strong>Who changes what the most?</strong></p></td><td class="confluenceTd"><p>For user uu compute frequency vector fu(c)=f_u(c)= count of column cc edits; rank by ∥fu∥1\|f_u\|_1.</p></td></tr><tr><td class="confluenceTd"><p><strong>Rollback candidate</strong></p></td><td class="confluenceTd"><p>Find latest ee such that F(e).Field=XF(e).Field = X and F(e).NewValue=VF(e).NewValue = V; output e.te.t for restore point.</p></td></tr><tr><td class="confluenceTd"><p><strong>Hot columns</strong></p></td><td class="confluenceTd"><p>For period ΔΔ, maximise var(C)\text{var}(C) over all C⊆MC\subseteq ℳ.</p></td></tr><tr><td class="confluenceTd"><p><strong>Time-to-converge</strong> (e.g., how long until address stops flipping)</p></td><td class="confluenceTd"><p>Compute smallest mm where di=di+m=di+2m=…d_{i} = d_{i+m} = d_{i+2m} = \dots for a field.</p></td></tr></tbody></table></div><hr/><h3 id="CRMAuditMasterTechNotes-7ExampleWalk-ThroughinSymbols">7 Example Walk-Through in Symbols</h3><p>Raw row (scenario A):</p><p>r=(2,  2,  g,  {22,10366},  ⟨702, 64⟩,  t,  u)r=\bigl(2,\;2,\;g,\;\{22,10366\},\;\langle702,\,64\rangle,\;t,\;u\bigr)</p><ol start="1"><li><p><strong>Filter passes</strong> (t&gt;t0t &gt; t_0).</p></li><li><p><strong>Sanitise</strong> – nothing to strip.</p></li><li><p><strong>Explode</strong> → (22,702)(22,702), (10366,64)(10366,64).</p></li><li><p><strong>Enrich</strong></p><ul><li><p>22↦22 \mapsto <em>Country</em></p></li><li><p>10366↦10366 \mapsto <em>CitizenshipStatus</em></p></li></ul></li><li><p><strong>Translate</strong></p><ul><li><p>σopt(2,Country,702)=σ_{\text{opt}}(2,\text{Country},702)= “New Zealand”</p></li><li><p>σopt(2,CitizenshipStatus,64)=σ_{\text{opt}}(2,\text{CitizenshipStatus},64)= “Permanent Resident”</p></li></ul></li><li><p><strong>ConvertTime</strong> τ(t)=τ(t)= 11/06/2025 03∶30 pm</p></li><li><p><strong>PairOldNew</strong> waits for next audit row (LEAD).</p></li></ol><hr/><h3 id="CRMAuditMasterTechNotes-8WhyThisModelHelps">8 Why This Model Helps</h3><ul><li><p><strong>Determinism:</strong>   every step is a pure function ⇒ easy unit-test and parallelise.</p></li><li><p><strong>Complexity:</strong>   worst-case time O(N⋅M)O(N·M) where NN=audit rows, MM=max columns per row.</p></li><li><p><strong>Optimisation levers:</strong></p><ul><li><p>Push f1f_1 (filter) <strong>before</strong> big scans to cut NN.</p></li><li><p>Implement f3,f4f_3,f_4 with set-based <code>OPENJSON</code> instead of cursor ⇒ reduce MM-factor.</p></li></ul></li></ul><hr/><h3 id="CRMAuditMasterTechNotes-9OpenExtensionsforResearchProjects">9 Open Extensions for Research Projects</h3><ol start="1"><li><p><strong>Probabilistic Audit Modelling</strong> – treat aa as a stochastic process, build Hidden Markov Model to predict next change type.</p></li><li><p><strong>Graph Embeddings</strong> – embed the event multigraph into ℝᵈ and cluster volatile vs stable records.</p></li><li><p><strong>Field-impact Score</strong> – define I(c)=∑e touches cSeverity(ae)I(c)=\sum_{e\text{ touches }c}\text{Severity}(a_e); rank by II.</p></li><li><p><strong>Optimal Partitioning</strong> – given quarterly partitions, model query cost as C(p)=α p+βC(p)=α\,p+β; solve for ideal retention p*.</p></li></ol><hr/><h3 id="CRMAuditMasterTechNotes-10Cheat-SheetofAllSymbols">10 Cheat-Sheet of All Symbols</h3><div class="table-wrap"><table data-table-width="760" data-layout="default" data-local-id="67554902-bad5-4585-8fe3-1b4cdafa62d8" class="confluenceTable"><tbody><tr><th class="confluenceTh"><p>Symbol</p></th><th class="confluenceTh"><p>Meaning</p></th></tr><tr><td class="confluenceTd"><p>aa</p></td><td class="confluenceTd"><p>action code</p></td></tr><tr><td class="confluenceTd"><p>oo</p></td><td class="confluenceTd"><p>entity OTC</p></td></tr><tr><td class="confluenceTd"><p>gg</p></td><td class="confluenceTd"><p>GUID of record</p></td></tr><tr><td class="confluenceTd"><p>CC</p></td><td class="confluenceTd"><p>set of changed columns</p></td></tr><tr><td class="confluenceTd"><p>DD</p></td><td class="confluenceTd"><p>vector of old values</p></td></tr><tr><td class="confluenceTd"><p>tt</p></td><td class="confluenceTd"><p>UTC time</p></td></tr><tr><td class="confluenceTd"><p>uu</p></td><td class="confluenceTd"><p>user GUID</p></td></tr><tr><td class="confluenceTd"><p>ϕ \phi</p></td><td class="confluenceTd"><p>column-metadata lookup</p></td></tr><tr><td class="confluenceTd"><p>σoptσ_{\text{opt}}</p></td><td class="confluenceTd"><p>option-set code → text</p></td></tr><tr><td class="confluenceTd"><p>λλ</p></td><td class="confluenceTd"><p>GUID → name</p></td></tr><tr><td class="confluenceTd"><p>ττ</p></td><td class="confluenceTd"><p>UTC → NZ†</p></td></tr></tbody></table></div><hr/><p><strong>Result:</strong><br/>You now have a <strong>formal pipeline F:R→R\*F:ℛ→ℛ^\*</strong> plus a graph/event-stream view that lets you apply probability, graph theory, or optimisation techniques to CRM auditing — far beyond the original procedural script.</p>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on 18-08-25 20:53</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
